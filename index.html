<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids' Mission System</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- æ·»åŠ Chart.jsç”¨äºå›¾è¡¨å¯è§†åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- æ·»åŠ SheetJSç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ·»åŠ ä¸€äº›åŸºç¡€æ ·å¼ï¼Œç¡®ä¿å›¾æ ‡å°ºå¯¸æ­£ç¡® */
        i[data-lucide] {
            display: inline-block; /* æˆ–è€… blockï¼Œæ ¹æ®éœ€è¦ */
            vertical-align: middle;
        }
        
        /* é˜²å¾¡æ€§æ ·å¼ï¼Œç¡®ä¿å¸ƒå±€ç¨³å®š */
        #root {
            position: relative;
            z-index: 1;
        }
        
        /* ç¡®ä¿æ²¡æœ‰æ„å¤–çš„å®šä½é—®é¢˜ */
        .header-login-area {
            position: relative;
            z-index: 10;
        }
        
        /* å¼ºåˆ¶å‚ç›´å¸ƒå±€ï¼Œé˜²æ­¢é¢ å€’ */
        .main-container {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
        }
        
        .main-container > * {
            position: static !important;
            order: unset !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- æ·»åŠ ä»»åŠ¡è¡¨å• -->
    <div id="addTaskForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
            <h3 class="text-lg font-bold mb-4">æ·»åŠ ä»»åŠ¡</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç±»å‹</label>
                <select id="taskType" class="w-full p-2 border rounded">
                    <option value="positive">å¾—åˆ†é¡¹</option>
                    <option value="negative">æ‰£åˆ†é¡¹</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡åç§°</label>
                <input type="text" id="taskName" class="w-full p-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†å€¼</label>
                <input type="number" id="taskPoints" class="w-full p-2 border rounded" min="1">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeAddTaskForm()" class="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button>
                <button onclick="addTask()" class="px-4 py-2 bg-blue-500 text-white rounded">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥–åŠ±è¡¨å• -->
    <div id="addRewardForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
            <h3 class="text-lg font-bold mb-4">æ·»åŠ å¥–åŠ±</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">å¥–åŠ±åç§°</label>
                <input type="text" id="rewardName" class="w-full p-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">æ‰€éœ€ç§¯åˆ†</label>
                <input type="number" id="rewardPoints" class="w-full p-2 border rounded" min="1">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeAddRewardForm()" class="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button>
                <button onclick="addReward()" class="px-4 py-2 bg-blue-500 text-white rounded">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, Fragment } = React; // ä»å…¨å±€ React å¯¹è±¡ä¸­è·å– Hooks

        const SUPABASE_URL = 'https://bojodbpcvgrkbsxtfnfi.supabase.co'; // æ›¿æ¢æˆä½ çš„ Supabase é¡¹ç›® URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvam9kYnBjdmdya2JzeHRmbmZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMDAzNzUsImV4cCI6MjA2NDY3NjM3NX0.xaAVHAZ8fpmbEYSAPXjbKEqndWEowFcFHFrwMPOWigY'; // æ›¿æ¢æˆä½ çš„ Supabase anon key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ç›´æ¥åœ¨è¿™é‡Œå®šä¹‰ Lucide å›¾æ ‡ç»„ä»¶çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæˆ–è€…åœ¨JSXä¸­ä½¿ç”¨ <i> æ ‡ç­¾
        // ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†ç›´æ¥åœ¨JSXä¸­ä½¿ç”¨ <i data-lucide="..."></i> å¹¶ç”¨useEffectæ›´æ–°

        function LucaPointsSystem() {
          const [totalPoints, setTotalPoints] = useState(0);
          const [viewMode, setViewMode] = useState('today');
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [history, setHistory] = useState([]);
          const [showRewards, setShowRewards] = useState(false);
          const [showAddTask, setShowAddTask] = useState(false);
          const [editingTask, setEditingTask] = useState(null);
          const [newTask, setNewTask] = useState({
            name: '',
            nameEn: '',
            points: 10,
            icon: 'â­',
            type: 'daily'
          });
          const [childName, setChildName] = useState('');
          const [isUpdating, setIsUpdating] = useState(false);
          const [pendingHistory, setPendingHistory] = useState(null);
          const [tasks, setTasks] = useState([]);
          
          const [rewards, setRewards] = useState([]);
          
          const emojiOptions = ['â­', 'ğŸ“š', 'ğŸ¯', 'ğŸ’ª', 'ğŸƒ', 'ğŸ¨', 'ğŸ§©', 'ğŸª', 'ğŸŒŸ', 'ğŸ’', 'ğŸ”¥', 'âš¡', 'ğŸŒˆ', 'ğŸ­', 'ğŸ¸'];

          const [showAddReward, setShowAddReward] = useState(false);
          const [newReward, setNewReward] = useState({
            name: '',
            nameEn: '',
            cost: 50,
            icon: 'ğŸ'
          });

          const [currentUser, setCurrentUser] = useState(null);
          const [loginEmail, setLoginEmail] = useState('');
          const [loginPassword, setLoginPassword] = useState('');
          const [authMode, setAuthMode] = useState('login'); // 'login', 'register', 'forgot'
          const [isAuthLoading, setIsAuthLoading] = useState(false);
          const [showLoginModal, setShowLoginModal] = useState(false);
          const [pendingAction, setPendingAction] = useState(null); // å­˜å‚¨å¾…æ‰§è¡Œçš„åŠ¨ä½œ
          
          // å¤šå­©å­æ”¯æŒ
          const [children, setChildren] = useState([]);
          const [currentChild, setCurrentChild] = useState(null);
          const [showChildrenManager, setShowChildrenManager] = useState(false);
          const [newChild, setNewChild] = useState({ name: '', birth_year: new Date().getFullYear() - 5, avatar: 'ğŸ˜Š' });

          // æ•°æ®ç»Ÿè®¡å’Œå¯¼å‡ºåŠŸèƒ½
          const [showReportsPage, setShowReportsPage] = useState(false);
          const [reportData, setReportData] = useState(null);
          const [reportPeriod, setReportPeriod] = useState('week'); // 'week', 'month', 'quarter', 'year', 'custom'
          const [isLoadingReport, setIsLoadingReport] = useState(false);
          const [customStartDate, setCustomStartDate] = useState('');
          const [customEndDate, setCustomEndDate] = useState('');

          // é¢„è®¾ä»»åŠ¡å’Œå¥–åŠ±
          const DEFAULT_TASKS = [
            // æ¯æ—¥ä»»åŠ¡ Daily Tasks
            { name: 'å®Œæˆå­¦æ ¡ä½œä¸š', nameEn: 'Finish Homework', points: 20, icon: 'ğŸ“š', type: 'daily' },
            { name: 'å­¦ä¹ ä¸­æ–‡', nameEn: 'Learn Chinese', points: 15, icon: 'ğŸˆ¶', type: 'daily' },
            { name: 'å­¦ä¹ æ³•è¯­', nameEn: 'Learn French', points: 15, icon: 'ğŸ‡«ğŸ‡·', type: 'daily' },
            { name: 'å†™æ—¥è®°', nameEn: 'Write Diary', points: 10, icon: 'ğŸ“', type: 'daily' },
            { name: 'æ•°å­¦ç»ƒä¹ ', nameEn: 'Math Practice', points: 15, icon: 'â—', type: 'daily' },
            { name: 'Read Theory', nameEn: 'Read Theory', points: 15, icon: 'ğŸ“–', type: 'daily' },
            { name: 'è¿åŠ¨', nameEn: 'Exercise', points: 15, icon: 'ğŸƒ', type: 'daily' },

            // è¡Œä¸ºä¹ æƒ¯ Good Habits
            { name: 'æ´—æ¾¡åˆ·ç‰™', nameEn: 'Shower & Brush Teeth', points: 5, icon: 'ğŸ›', type: 'behavior' },
            { name: 'ç‰©å“å½’ä½', nameEn: 'Put Things Back', points: 5, icon: 'ğŸ§¸', type: 'behavior' },
            { name: 'å‡†æ—¶ç¡è§‰', nameEn: 'Go to Bed on Time', points: 5, icon: 'ğŸ›ï¸', type: 'behavior' },

            // æ‰£åˆ†é¡¹ Penalties
            { name: 'æˆ¿é—´ä¸æ•´æ´', nameEn: 'Messy Room', points: -10, icon: 'ğŸ¡', type: 'penalties' },
            { name: 'äº‰åµæ‰“æ¶', nameEn: 'Fighting/Arguing', points: -20, icon: 'ğŸ˜¤', type: 'penalties' },
            { name: 'å¿˜è®°å¸¦ä½œä¸š', nameEn: 'Forgot Homework', points: -15, icon: 'ğŸ’', type: 'penalties' },
            { name: 'è¶…æ—¶çœ‹å±å¹•', nameEn: 'Too Much Screen Time', points: -10, icon: 'ğŸ“±', type: 'penalties' },
            { name: 'è¯´è°', nameEn: 'Lying', points: -25, icon: 'ğŸ¤”', type: 'penalties' }
          ];
          const DEFAULT_REWARDS = [
            { name: 'Roblox 30åˆ†é’Ÿ', nameEn: '30min Roblox', cost: 50, icon: 'ğŸ®' },
            { name: 'Roblox 1å°æ—¶', nameEn: '1hr Roblox', cost: 90, icon: 'ğŸ®' },
            { name: 'çœ‹ç”µå½±', nameEn: 'Movie Time', cost: 100, icon: 'ğŸ¬' },
            { name: 'ç‰¹åˆ«é›¶é£Ÿ', nameEn: 'Special Treat', cost: 40, icon: 'ğŸ°' },
            { name: 'æ™šç¡30åˆ†é’Ÿ', nameEn: '30min Later Bedtime', cost: 60, icon: 'ğŸŒ™' },
            { name: 'æœ‹å‹èšä¼š', nameEn: 'Playdate', cost: 120, icon: 'ğŸ‘«' }
          ];

          useEffect(() => {
            lucide.createIcons();
          });

          // ç›‘å¬æŠ¥å‘Šé¡µé¢çš„æ‰“å¼€/å…³é—­ï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®é‡ç½®
          useEffect(() => {
            console.log('showReportsPage çŠ¶æ€å˜åŒ–:', showReportsPage);
            console.log('å½“å‰ isLoadingReport:', isLoadingReport);
            console.log('å½“å‰ reportData:', reportData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');
            
            if (!showReportsPage) {
              // é¡µé¢å…³é—­æ—¶ï¼Œæ¸…ç†æ‰€æœ‰ç›¸å…³çŠ¶æ€
              console.log('æ­£åœ¨æ¸…ç†æŠ¥å‘Šé¡µé¢çŠ¶æ€...');
              setReportData(null);
              setIsLoadingReport(false);
              console.log('æŠ¥å‘Šé¡µé¢å…³é—­ï¼ŒçŠ¶æ€å·²é‡ç½®');
            }
          }, [showReportsPage]);

          // é¢å¤–ç›‘å¬åŠ è½½çŠ¶æ€ï¼Œè°ƒè¯•ç”¨
          useEffect(() => {
            console.log('isLoadingReport çŠ¶æ€å˜åŒ–:', isLoadingReport);
          }, [isLoadingReport]);

          // å…ˆæš‚æ—¶ç®€åŒ–ï¼šéƒ½ä½¿ç”¨user_idæŸ¥è¯¢ä»¥ä¿æŒå…¼å®¹æ€§

          // ç®€åŒ–çš„å­©å­ç®¡ç†å‡½æ•°
          const loadChildren = async (user) => {
            try {
              console.log('åŠ è½½å­©å­åˆ—è¡¨...');
              const { data: childrenData, error } = await supabase
                .from('children')
                .select('*')
                .eq('parent_id', user.id)
                .order('created_at', { ascending: true });
              
              if (error) {
                console.error('åŠ è½½å­©å­å¤±è´¥:', error);
                setChildren([]);
                setShowChildrenManager(true);
                return;
              }
              
              console.log('æ‰¾åˆ°å­©å­:', childrenData?.length || 0, 'ä¸ª');
              setChildren(childrenData || []);
              
              if (childrenData && childrenData.length > 0) {
                setCurrentChild(childrenData[0]);
                console.log('è®¾ç½®å½“å‰å­©å­:', childrenData[0].name);
                setShowChildrenManager(false);
            } else {
                setCurrentChild(null);
                setShowChildrenManager(true);
              }
              
            } catch (error) {
              console.error('åŠ è½½å­©å­æ—¶å‡ºé”™:', error);
              setChildren([]);
              setShowChildrenManager(true);
            }
          };

          const addChild = async () => {
            console.log('å¼€å§‹æ·»åŠ å­©å­...');
            console.log('å½“å‰ç”¨æˆ·:', currentUser?.email);
            console.log('æ–°å­©å­ä¿¡æ¯:', newChild);
            console.log('ç°æœ‰å­©å­æ•°é‡:', children.length);
            
            if (!currentUser || !newChild.name.trim()) {
              alert('è¯·è¾“å…¥å­©å­å§“å');
                  return;
                }
            
            if (children.length >= 3) {
              alert('æœ€å¤šåªèƒ½æ·»åŠ 3ä¸ªå­©å­');
              return;
            }

            try {
              // æ£€æŸ¥childrenè¡¨æ˜¯å¦å­˜åœ¨
              const { data, error } = await supabase
                .from('children')
                .insert([{
                  parent_id: currentUser.id,
                  name: newChild.name.trim(),
                  birth_year: newChild.birth_year,
                  avatar: newChild.avatar
                }])
                .select();

                if (error) {
                console.error('æ•°æ®åº“é”™è¯¯è¯¦æƒ…:', error);
                
                // å¦‚æœæ˜¯è¡¨ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œåˆ›å»ºæœ¬åœ°å­©å­
                if (error.code === 'PGRST116' || error.message?.includes('does not exist') || !error.message) {
                  console.log('childrenè¡¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºæœ¬åœ°å­©å­æ¡£æ¡ˆ');
                  
                  // åˆ›å»ºä¸€ä¸ªæœ¬åœ°IDï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
                  const localChild = {
                    id: 'local_' + Date.now(),
                    parent_id: currentUser.id,
                    name: newChild.name.trim(),
                    birth_year: newChild.birth_year,
                    avatar: newChild.avatar,
                    created_at: new Date().toISOString(),
                    is_local: true // æ ‡è®°ä¸ºæœ¬åœ°åˆ›å»º
                  };

                  const updatedChildren = [...children, localChild];
                  setChildren(updatedChildren);
                  
                  // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå­©å­ï¼Œè®¾ä¸ºå½“å‰å­©å­
                  if (updatedChildren.length === 1) {
                    setCurrentChild(localChild);
                    setShowChildrenManager(false);
                  }
                  
                  setNewChild({ name: '', birth_year: new Date().getFullYear() - 5, avatar: 'ğŸ˜Š' });
                  
                  // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                  localStorage.setItem('children_backup', JSON.stringify(updatedChildren));
                  
                  alert('å­©å­æ¡£æ¡ˆå·²åˆ›å»ºï¼ï¼ˆæ³¨æ„ï¼šå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼‰');
                  return;
                } else {
                  alert('æ·»åŠ å­©å­å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                  return;
                }
              }

              const updatedChildren = [...children, data[0]];
              setChildren(updatedChildren);
              
              // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå­©å­ï¼Œè®¾ä¸ºå½“å‰å­©å­
              if (updatedChildren.length === 1) {
                setCurrentChild(data[0]);
                setShowChildrenManager(false);
              }
              
              setNewChild({ name: '', birth_year: new Date().getFullYear() - 5, avatar: 'ğŸ˜Š' });
              alert('å­©å­æ¡£æ¡ˆæ·»åŠ æˆåŠŸï¼');
              
            } catch (error) {
              console.error('æ·»åŠ å­©å­æ—¶å‘ç”Ÿé”™è¯¯:', error);
              alert('æ·»åŠ å­©å­å‡ºé”™: ' + (error.message || 'ç½‘ç»œè¿æ¥é—®é¢˜'));
            }
          };

          const deleteChild = async (childId) => {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­©å­çš„æ¡£æ¡ˆå—ï¼Ÿæ‰€æœ‰ç›¸å…³æ•°æ®å°†è¢«åˆ é™¤ï¼')) {
              return;
            }

            try {
              // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°å­©å­
              const childToDelete = children.find(child => child.id === childId);
              const isLocalChild = childToDelete?.is_local || (typeof childId === 'string' && childId.startsWith('local_'));
              
              if (!isLocalChild) {
                // åˆ é™¤æ•°æ®åº“ä¸­çš„å­©å­ç›¸å…³æ•°æ®
                await supabase.from('history').delete().eq('child_id', childId);
                await supabase.from('tasks').delete().eq('child_id', childId);
                await supabase.from('rewards').delete().eq('child_id', childId);
                await supabase.from('children').delete().eq('id', childId);
              }

              const updatedChildren = children.filter(child => child.id !== childId);
              setChildren(updatedChildren);
              
              // æ›´æ–°æœ¬åœ°å¤‡ä»½
              localStorage.setItem('children_backup', JSON.stringify(updatedChildren));
              
              // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å­©å­ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
              if (currentChild?.id === childId) {
                if (updatedChildren.length > 0) {
                  setCurrentChild(updatedChildren[0]);
                  } else {
                  setCurrentChild(null);
                  setShowChildrenManager(true);
                }
              }
              
              alert(isLocalChild ? 'æœ¬åœ°å­©å­æ¡£æ¡ˆå·²åˆ é™¤' : 'å­©å­æ¡£æ¡ˆå·²åˆ é™¤');
              
            } catch (error) {
              console.error('åˆ é™¤å­©å­æ—¶å‡ºé”™:', error);
              alert('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
          };

          // åŠ è½½ç”¨æˆ·æ•°æ®å‡½æ•°
          const loadUserData = async (user) => {
            if (!user) return;
            
            console.log('å¼€å§‹åŠ è½½ç”¨æˆ·æ•°æ®:', user.email);
            
            console.log('ğŸš€ å¼€å§‹åŠ è½½æ•°æ®:', user.email);
            
            try {
              // æ­¥éª¤1: åŠ è½½å­©å­åˆ—è¡¨
              console.log('æ­¥éª¤1: å¼€å§‹åŠ è½½å­©å­åˆ—è¡¨');
              await loadChildren(user);
              console.log('æ­¥éª¤1: å­©å­åˆ—è¡¨åŠ è½½å®Œæˆ');
              
              // æ­¥éª¤2: ä»»åŠ¡å’Œå¥–åŠ±æ•°æ®ç°åœ¨ç”±loadChildDataå¤„ç†ï¼Œè·³è¿‡
              console.log('æ­¥éª¤2: ä»»åŠ¡å’Œå¥–åŠ±æ•°æ®å°†åœ¨é€‰æ‹©å­©å­ååŠ è½½');

              // æ­¥éª¤3: å†å²è®°å½•ç°åœ¨ç”±loadChildDataå¤„ç†ï¼Œè·³è¿‡
              console.log('æ­¥éª¤3: å†å²è®°å½•å°†åœ¨é€‰æ‹©å­©å­ååŠ è½½');
              
              console.log('ğŸ‰ æ‰€æœ‰æ•°æ®åŠ è½½æµç¨‹å®Œæˆ');
              
            } catch (error) {
              console.error('ğŸš¨ æ•°æ®åŠ è½½å¤±è´¥:', error);
              
              // å³ä½¿å¤±è´¥ä¹Ÿè¦è®¾ç½®åŸºæœ¬çŠ¶æ€ï¼Œé¿å…å¡ä½
              console.log('è®¾ç½®é»˜è®¤çŠ¶æ€ä»¥é¿å…å¡ä½');
              setTasks(DEFAULT_TASKS.map((t, index) => ({ ...t, id: index + 1 }))); // ä½¿ç”¨æœ¬åœ°é¢„è®¾
              setRewards(DEFAULT_REWARDS.map((r, index) => ({ ...r, id: index + 1 }))); // ä½¿ç”¨æœ¬åœ°é¢„è®¾
              setHistory([]);
              setChildren([]);
              
              // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†å…è®¸ç»§ç»­ä½¿ç”¨
              if (error.message.includes('è¶…æ—¶')) {
                alert('æ•°æ®åŠ è½½è¾ƒæ…¢ï¼Œå·²åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼ã€‚ä½ ä»å¯ä»¥æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿï¼');
            } else {
                alert('ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå·²åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼: ' + error.message);
              }
            }
          };

          // ä¸ºå½“å‰å­©å­åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆä»»åŠ¡ã€å¥–åŠ±ã€å†å²è®°å½•ï¼‰
          const loadChildData = async (child) => {
            if (!child || !currentUser) return;
            
            try {
              console.log('åŠ è½½å­©å­æ•°æ®:', child.name, child.id);
              
              // åŠ è½½è¯¥å­©å­çš„ä»»åŠ¡
              const { data: tasksData, error: tasksError } = await supabase
                .from('tasks')
                .select('*')
                .eq('child_id', child.id);
              
              if (tasksError) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', tasksError);
                // å¦‚æœæ²¡æœ‰child_idå­—æ®µï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼
                if (tasksError.message?.includes('child_id')) {
                  console.log('tasksè¡¨child_idå­—æ®µä¸å­˜åœ¨ï¼Œä½¿ç”¨user_idæŸ¥è¯¢å…¼å®¹æ¨¡å¼');
                  const { data: fallbackData } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('user_id', currentUser.id);
                  setTasks(fallbackData || []);
                } else {
                  // å¦‚æœè¯¥å­©å­è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œä¸ºå…¶åˆ›å»ºé¢„è®¾ä»»åŠ¡
                  console.log('ä¸ºæ–°å­©å­åˆ›å»ºé¢„è®¾ä»»åŠ¡');
                  const { error: insertError } = await supabase.from('tasks').insert(
                      DEFAULT_TASKS.map(t => ({
                      ...t,
                        user_id: currentUser.id,
                      child_id: child.id
                      }))
                    );
                  if (!insertError) {
                    const { data: newTasks } = await supabase.from('tasks').select('*').eq('child_id', child.id);
                    setTasks(newTasks || []);
                  } else {
                    setTasks([]);
                  }
                }
              } else if (!tasksData || tasksData.length === 0) {
                // å¦‚æœè¯¥å­©å­è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œä¸ºå…¶åˆ›å»ºé¢„è®¾ä»»åŠ¡
                console.log('ä¸ºæ–°å­©å­åˆ›å»ºé¢„è®¾ä»»åŠ¡');
                const { error: insertError } = await supabase.from('tasks').insert(
                  DEFAULT_TASKS.map(t => ({
                    ...t,
                    user_id: currentUser.id,
                    child_id: child.id
                  }))
                );
                if (!insertError) {
                  const { data: newTasks } = await supabase.from('tasks').select('*').eq('child_id', child.id);
                  setTasks(newTasks || []);
                } else {
                  setTasks([]);
                }
              } else {
                console.log('æˆåŠŸåŠ è½½ä»»åŠ¡:', tasksData?.length || 0, 'ä¸ª');
                setTasks(tasksData || []);
              }

              // åŠ è½½è¯¥å­©å­çš„å¥–åŠ±
              const { data: rewardsData, error: rewardsError } = await supabase
                .from('rewards')
                .select('*')
                .eq('child_id', child.id);
              
              if (rewardsError) {
                console.error('åŠ è½½å¥–åŠ±å¤±è´¥:', rewardsError);
                // å¦‚æœæ²¡æœ‰child_idå­—æ®µï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼
                if (rewardsError.message?.includes('child_id')) {
                  console.log('rewardsè¡¨child_idå­—æ®µä¸å­˜åœ¨ï¼Œä½¿ç”¨user_idæŸ¥è¯¢å…¼å®¹æ¨¡å¼');
                  const { data: fallbackData } = await supabase
                    .from('rewards')
                    .select('*')
                    .eq('user_id', currentUser.id);
                  setRewards(fallbackData || []);
                } else {
                  // å¦‚æœè¯¥å­©å­è¿˜æ²¡æœ‰å¥–åŠ±ï¼Œä¸ºå…¶åˆ›å»ºé¢„è®¾å¥–åŠ±
                  console.log('ä¸ºæ–°å­©å­åˆ›å»ºé¢„è®¾å¥–åŠ±');
                  const { error: insertError } = await supabase.from('rewards').insert(
                      DEFAULT_REWARDS.map(r => ({
                        ...r,
                      user_id: currentUser.id,
                      child_id: child.id
                      }))
                    );
                  if (!insertError) {
                    const { data: newRewards } = await supabase.from('rewards').select('*').eq('child_id', child.id);
                    setRewards(newRewards || []);
                  } else {
                    setRewards([]);
                  }
                }
              } else if (!rewardsData || rewardsData.length === 0) {
                // å¦‚æœè¯¥å­©å­è¿˜æ²¡æœ‰å¥–åŠ±ï¼Œä¸ºå…¶åˆ›å»ºé¢„è®¾å¥–åŠ±
                console.log('ä¸ºæ–°å­©å­åˆ›å»ºé¢„è®¾å¥–åŠ±');
                const { error: insertError } = await supabase.from('rewards').insert(
                  DEFAULT_REWARDS.map(r => ({
                    ...r,
                    user_id: currentUser.id,
                    child_id: child.id
                  }))
                );
                if (!insertError) {
                  const { data: newRewards } = await supabase.from('rewards').select('*').eq('child_id', child.id);
                  setRewards(newRewards || []);
            } else {
              setRewards([]);
            }
              } else {
                console.log('æˆåŠŸåŠ è½½å¥–åŠ±:', rewardsData?.length || 0, 'ä¸ª');
                setRewards(rewardsData || []);
              }
              
              // åŠ è½½è¯¥å­©å­çš„å†å²è®°å½•
              const { data: historyData, error: historyError } = await supabase
                .from('history')
                .select('*')
                .eq('child_id', child.id);
              
              if (historyError) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', historyError);
                // å¦‚æœæ˜¯å› ä¸ºæ²¡æœ‰child_idå­—æ®µï¼Œå°è¯•æŒ‰user_idåŠ è½½ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                if (historyError.message?.includes('child_id')) {
                  console.log('historyè¡¨child_idå­—æ®µä¸å­˜åœ¨ï¼Œä½¿ç”¨user_idæŸ¥è¯¢å…¼å®¹æ¨¡å¼');
                  const { data: fallbackData } = await supabase
                    .from('history')
                    .select('*')
                    .eq('user_id', currentUser.id);
                  setHistory(fallbackData || []);
            } else {
              setHistory([]);
            }
              } else {
                console.log('æˆåŠŸåŠ è½½å†å²è®°å½•:', historyData?.length || 0, 'æ¡');
                setHistory(historyData || []);
              }
              
            } catch (error) {
              console.error('åŠ è½½å­©å­æ•°æ®å¤±è´¥:', error);
              setHistory([]);
              setTasks([]);
              setRewards([]);
            }
          };

          // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
          useEffect(() => {
            console.log('è®¾ç½®è®¤è¯ç›‘å¬å™¨');
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€
            supabase.auth.getSession().then(({ data: { session } }) => {
              console.log('æ£€æŸ¥å½“å‰ä¼šè¯:', session?.user?.email);
              if (session?.user) {
                setCurrentUser(session.user);
                loadUserData(session.user);
              }
            });

            const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
              console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event, session?.user?.email);
              
              if (event === 'SIGNED_IN' && session?.user) {
                console.log('ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œå¼€å§‹åŠ è½½æ•°æ®');
                setCurrentUser(session.user);
                
                try {
                  // åŠ è½½ç”¨æˆ·æ•°æ®
                  await loadUserData(session.user);
                  console.log('ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆ');
                  
                  // æ‰§è¡Œå¾…æ‰§è¡Œçš„åŠ¨ä½œå¹¶å…³é—­ç™»å½•æ¨¡æ€æ¡†
                  executePendingAction();
                } catch (error) {
                  console.error('åŠ è½½ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™:', error);
                  // å³ä½¿å‡ºé”™ä¹Ÿè¦å…³é—­ç™»å½•æ¡†
                  setShowLoginModal(false);
                  setIsAuthLoading(false);
                }
              } else if (event === 'SIGNED_OUT') {
                console.log('ç”¨æˆ·é€€å‡ºç™»å½•');
                setCurrentUser(null);
                setChildren([]);
                setCurrentChild(null);
                setTasks([]);
                setRewards([]);
                setHistory([]);
                setTotalPoints(0);
              }
            });

            return () => subscription.unsubscribe();
          }, []);

          // å½“å‰å­©å­å˜åŒ–æ—¶ï¼ŒåŠ è½½è¯¥å­©å­çš„å†å²æ•°æ®
          useEffect(() => {
            if (currentChild && currentUser) {
              console.log('å­©å­åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½æ•°æ®:', currentChild.name);
              loadChildData(currentChild);
            }
          }, [currentChild, currentUser]);

          useEffect(() => {
            let total = 0;
            if (Array.isArray(history)) {
              history.forEach(item => {
                total += item.points;
              });
            }
            setTotalPoints(total);
          }, [history]);

          useEffect(() => {
            const todayStr = getLocalDateStr(new Date());
            const dateStr = getLocalDateStr(selectedDate);
            if (dateStr !== todayStr) {
              // historyæ˜¯æ•°ç»„ï¼Œéœ€è¦è¿‡æ»¤å‡ºæŒ‡å®šæ—¥æœŸçš„è®°å½•
              const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
              setPendingHistory(JSON.parse(JSON.stringify(dayHistory)));
            } else {
              setPendingHistory(null);
            }
          }, [selectedDate, history]);

          // é¡µé¢åŠ è½½æ—¶ä¼˜å…ˆä» localStorage è¯»å–
          useEffect(() => {
            const savedTasks = localStorage.getItem('kidsTasks');
            if (savedTasks) setTasks(JSON.parse(savedTasks));
            const savedRewards = localStorage.getItem('kidsRewards');
            if (savedRewards) setRewards(JSON.parse(savedRewards));
          }, []);

          // æ¯æ¬¡ tasks æˆ– rewards å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜åˆ° localStorage
          useEffect(() => {
            localStorage.setItem('kidsTasks', JSON.stringify(tasks));
            localStorage.setItem('kidsRewards', JSON.stringify(rewards));
          }, [tasks, rewards]);



          // è¿™äº›è®¤è¯ç›‘å¬å·²ç»åœ¨å‰é¢å¤„ç†äº†ï¼Œé¿å…é‡å¤
          // useEffect(() => {
          //   // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
          //   supabase.auth.getUser().then(({ data: { user } }) => {
          //     setCurrentUser(user || null);
          //   });
          // }, []);

          // useEffect(() => {
          //   // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
          //   const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          //     setCurrentUser(session?.user || null);
          //   });
          //   return () => {
          //     subscription.unsubscribe();
          //   };
          // }, []);

          // è¿™ä¸ªuseEffectå·²ç»ä¸éœ€è¦äº†ï¼Œå› ä¸ºæ•°æ®åŠ è½½ç°åœ¨åœ¨loadUserDataä¸­å¤„ç†
          // useEffect(() => {
          //   if (currentUser) {
          //     supabase
          //       .from('tasks')
          //       .select('*')
          //       .eq('user_id', currentUser.id)
          //       .then(({ data, error }) => {
          //         if (error) {
          //           alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message);
          //         } else {
          //           setTasks(data || []);
          //         }
          //       });
          //   } else {
          //     setTasks([]);
          //   }
          // }, [currentUser]);


          // è‡ªåŠ¨ä¸ºæ–°ç”¨æˆ·æ’å…¥é¢„è®¾ä»»åŠ¡å’Œå¥–åŠ±
          // æ•°æ®åŠ è½½ç°åœ¨ç”±è®¤è¯çŠ¶æ€ç›‘å¬å¤„ç†

          // æ”¹ä¸ºä» localStorage ä¸­è¯»å– childName
          useEffect(() => {
            const savedChildName = localStorage.getItem('childName');
            if (savedChildName) setChildName(savedChildName);
          }, []);

          // æ”¹ä¸ºåœ¨ childName å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜åˆ° localStorage
          useEffect(() => {
            if (childName) localStorage.setItem('childName', childName);
          }, [childName]);

          
          const toggleTask = async (category, taskId) => {
            if (isUpdating) return;
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å­©å­
            if (!currentChild) {
              alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­©å­ / Please select a child first');
              return;
            }
            
            const dateStr = getLocalDateStr(selectedDate);
            const todayStr = getLocalDateStr(new Date());
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            setIsUpdating(true);

            // å¦‚æœæ˜¯è¡¥å½•æ¨¡å¼ï¼ˆéä»Šå¤©ï¼‰
            if (dateStr !== todayStr && pendingHistory !== null) {
              // æ›´æ–°pendingHistoryçŠ¶æ€
              const already = pendingHistory.some(item => item.task === task.name && item.type === category);
              
              if (already) {
                // ä»pendingHistoryä¸­åˆ é™¤
                setPendingHistory(prev => prev.filter(item => !(item.task === task.name && item.type === category)));
              } else {
                // æ·»åŠ åˆ°pendingHistory
                const newItem = {
                  date: dateStr,
                  task: task.name,
                  type: category,
                  points: task.points,
                  user_id: currentUser.id
                };
                setPendingHistory(prev => [...prev, newItem]);
              }
            } else {
              // ä»Šå¤©çš„æ•°æ®ï¼Œç›´æ¥å†™å…¥æ•°æ®åº“
            const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            const already = dayHistory.some(item => item.task === task.name && item.type === category);

            if (already) {
              // åˆ é™¤è¯¥æ¡è®°å½•
              const itemToDelete = dayHistory.find(item => item.task === task.name && item.type === category);
              if (itemToDelete) {
                await supabase.from('history').delete().eq('id', itemToDelete.id);
              }
            } else {
              // æ’å…¥æ–°è®°å½•
              await supabase.from('history').insert([{
                date: dateStr,
                task: task.name,
                type: category,
                points: task.points,
                  user_id: currentUser.id,
                  child_id: currentChild?.id
              }]);
            }

              // åˆ·æ–°å½“å‰å­©å­çš„ history
              if (currentChild?.id) {
                const { data } = await supabase.from('history').select('*').eq('child_id', currentChild.id);
            setHistory(data || []);
              }
            }

            setIsUpdating(false);
          };
          const addTask = async (newTask) => {
            if (!currentUser || !currentChild) {
              alert('è¯·å…ˆç™»å½•å¹¶é€‰æ‹©å­©å­');
              return;
            }
            const { error } = await supabase.from('tasks').insert([{
                user_id: currentUser.id,
              child_id: currentChild.id,
                name: newTask.name,
                nameEn: newTask.nameEn,
                points: newTask.points,
                icon: newTask.icon,
                type: newTask.type
            }]);
            
            if (error) {
              alert('æ·»åŠ ä»»åŠ¡å¤±è´¥: ' + error.message);
            } else {
              // é‡æ–°åŠ è½½å½“å‰å­©å­çš„ä»»åŠ¡
              const { data } = await supabase.from('tasks').select('*').eq('child_id', currentChild.id);
              setTasks(data || []);
              alert('æ·»åŠ æˆåŠŸï¼');
            }
          };
          
          const deleteTask = async (taskId) => {
            if (!currentUser || !currentChild) return;
            await supabase.from('tasks').delete().eq('id', taskId).eq('child_id', currentChild.id);
            // é‡æ–°åŠ è½½å½“å‰å­©å­çš„ä»»åŠ¡
            const { data } = await supabase.from('tasks').select('*').eq('child_id', currentChild.id);
            setTasks(data || []);
          };
          
          const startEditTask = (task) => {
             setEditingTask(task);
          };

          const handleUpdateTask = (taskId, updates) => {
             setTasks(prev => prev.map(t => 
               t.id === taskId ? { ...t, ...updates } : t
             ));
             // If we are directly updating, we might not need editingTask state like this
             // For simplicity, we'll update directly. If a modal was used, setEditingTask(null) would be here.
          };
          
          const saveEditedTask = (taskId, currentEditedTaskState) => {
            // currentEditedTaskState would be the state from the editing form
            // This function is conceptual if editing is done in a separate form/modal.
            // In TaskCard, it updates directly.
            setTasks(prev => prev.map(t => 
              t.id === taskId ? { ...t, ...currentEditedTaskState } : t
            ));
            setEditingTask(null); // Close editing mode
          };

          const redeemReward = async (reward) => {
            if (totalPoints >= reward.cost) {
              const dateStr = pendingHistory !== null
                ? getLocalDateStr(selectedDate)
                : getLocalDateStr(new Date());
              // ç”¨ Supabase æ’å…¥ history
              const { error } = await supabase
                .from('history')
                .insert([
                  {
                    date: dateStr,
                    task: reward.name + 'å…‘æ¢',
                    type: 'redeem',
                    points: -reward.cost,
                    user_id: currentUser.id,
                    child_id: currentChild?.id
                  }
                ]);
              if (!error) {
                alert(`å¤ªæ£’äº†! ä½ å…‘æ¢äº† ${reward.name} / Great! You redeemed ${reward.nameEn}! ğŸ‰`);
                // ç”¨ Supabase åˆ·æ–°å½“å‰å­©å­çš„ history
                if (currentChild?.id) {
                const { data } = await supabase
                  .from('history')
                  .select('*')
                    .eq('child_id', currentChild.id);
                setHistory(data || []);
                }
              }
            } else {
              alert('ç§¯åˆ†ä¸è¶³å“¦! / Not enough points! ğŸ™');
            }
          };

          const getCompletionRate = (date = selectedDate) => {
            const dateStr = getLocalDateStr(date);
            const todayStr = getLocalDateStr(new Date());
            
            // å¦‚æœæ˜¯è¡¥å½•æ¨¡å¼ï¼Œä½¿ç”¨pendingHistoryçš„æ•°æ®
            let dayHistory;
            if (dateStr !== todayStr && pendingHistory !== null) {
              dayHistory = pendingHistory;
            } else {
              dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            }
            
            let totalPossible = 0;
            tasks.forEach(t => { if (t.points > 0) totalPossible += t.points; });
            if (totalPossible === 0) return 0;
            let actual = 0;
            if (Array.isArray(dayHistory)) {
              dayHistory.forEach(item => {
                if ((item.type === 'daily' || item.type === 'behavior') && item.points > 0) {
                  actual += item.points;
                }
              });
            }
            return Math.round((actual / totalPossible) * 100);
          };

          const getDayPoints = (date) => {
            const dateStr = getLocalDateStr(date);
            const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            let total = 0;
            if (Array.isArray(dayHistory)) {
              dayHistory.forEach(item => {
                total += typeof item.points === 'number' ? item.points : 0;
              });
            }
            return total;
          };

          const TaskCard = ({ task, category }) => {
            const dateStr = getLocalDateStr(selectedDate);
            const todayStr = getLocalDateStr(new Date());
            
            // å¦‚æœæ˜¯è¡¥å½•æ¨¡å¼ï¼Œä½¿ç”¨pendingHistoryçš„æ•°æ®
            let dayHistory;
            if (dateStr !== todayStr && pendingHistory !== null) {
              dayHistory = pendingHistory;
            } else {
              dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            }
            
            // åˆ¤æ–­æ˜¯å¦å·²å®Œæˆï¼ˆå‹¾é€‰ï¼‰
            const isCompleted = dayHistory.some(item => item.task === task.name && item.type === category);
            const isPenalty = category === 'penalties';
            
            const daysDiff = Math.floor((new Date() - selectedDate) / (1000 * 60 * 60 * 24));
            const canEditOrComplete = daysDiff <= 3;

            // ç¼–è¾‘çŠ¶æ€
            const [editing, setEditing] = useState(false);
            const [editName, setEditName] = useState(task.name);
            const [editNameEn, setEditNameEn] = useState(task.nameEn);
            const [editPoints, setEditPoints] = useState(Math.abs(task.points));
            const [editIcon, setEditIcon] = useState(task.icon);

            const handleSave = () => {
              const updatedPoints = isPenalty ? -Math.abs(editPoints) : Math.abs(editPoints);
              handleUpdateTask(task.id, {
                name: editName,
                nameEn: editNameEn,
                points: updatedPoints,
                icon: editIcon
              });
              setEditing(false);
            };

            if (editing) {
              return (
                <div className="p-4 rounded-lg border-2 bg-gray-50 shadow-md">
                  <div className="space-y-2">
                    <input
                      type="text"
                      value={editName}
                      onChange={e => setEditName(e.target.value)}
                      className="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                      placeholder="ä¸­æ–‡åç§°"
                    />
                    <input
                      type="text"
                      value={editNameEn}
                      onChange={e => setEditNameEn(e.target.value)}
                      className="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                      placeholder="English Name"
                    />
                    <div className="flex items-center gap-2">
                      <input
                        type="number"
                        value={editPoints}
                        onChange={e => setEditPoints(parseInt(e.target.value) || 0)}
                        className="w-24 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <span className="text-sm text-gray-500">ç§¯åˆ†</span>
                    </div>
                    <div className="flex flex-wrap gap-2 bg-gray-50 p-2 rounded-lg border">
                      {emojiOptions.map(emoji => (
                        <button
                          key={emoji}
                          type="button"
                          onClick={() => setEditIcon(emoji)}
                          className={`text-2xl p-2 rounded-md transition-all ${editIcon === emoji ? 'bg-blue-500 text-white scale-110 ring-2 ring-blue-300' : 'hover:bg-gray-200 bg-white'}`}
                        >
                          {emoji}
                        </button>
                      ))}
                    </div>
                    <div className="flex gap-2 mt-2">
                      <button
                        onClick={handleSave}
                        className="bg-green-500 text-white px-3 py-1.5 rounded-md hover:bg-green-600 flex items-center"
                      >
                        <i data-lucide="save" className="w-4 h-4 mr-1"></i> ä¿å­˜ Save
                      </button>
                      <button
                        onClick={() => setEditing(false)}
                        className="bg-gray-300 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-400 flex items-center"
                      >
                        <i data-lucide="x" className="w-4 h-4 mr-1"></i> å–æ¶ˆ Cancel
                      </button>
                    </div>
                  </div>
                </div>
              );
            }

            return (
              <div className="relative group">
                <div
                  onClick={() => canEditOrComplete && !isUpdating && toggleTask(category, task.id)}
                  className={`${!canEditOrComplete || isUpdating ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'} 
                                p-4 rounded-lg border-2 transition-all duration-150 ease-in-out
                                ${ isPenalty 
                                    ? 'bg-red-50 border-red-200 hover:shadow-md' 
                                    : isCompleted 
                                        ? 'bg-green-100 border-green-400 hover:border-green-500 shadow-sm' 
                                        : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-md'
                                }`}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <span className="text-3xl">{task.icon}</span>
                      <div>
                        <h3 className="font-semibold text-gray-800">{task.name}</h3>
                        <p className="text-sm text-gray-500">{task.nameEn}</p>
                      </div>
                    </div>
                    <div className="flex items-center space-x-2">
                      <span className={`font-bold text-lg ${isPenalty ? 'text-red-600' : 'text-blue-600'}`}>
                        {task.points > 0 && !isPenalty ? '+' : ''}{task.points}
                      </span>
                      {isCompleted ? 
                        <i data-lucide="check-circle" className="text-green-500 w-6 h-6"></i> : 
                        <i data-lucide="circle" className="text-gray-300 w-6 h-6"></i>
                      }
                    </div>
                  </div>
                  <div className="absolute bottom-2 left-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <button
                      type="button"
                      onClick={e => { e.stopPropagation(); setEditing(true); }}
                      className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-600 transition"
                      title="ç¼–è¾‘ä»»åŠ¡ Edit Task"
                    >
                      <i data-lucide="edit-2" className="w-3 h-3"></i>
                    </button>
                    <button
                      type="button"
                      onClick={e => { e.stopPropagation(); deleteTask(task.id); }}
                      className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-600 transition"
                      title="åˆ é™¤ä»»åŠ¡ Delete Task"
                    >
                      <i data-lucide="x" className="w-3 h-3"></i>
                    </button>
                  </div>
                  {!canEditOrComplete && (
                    <p className="text-xs text-gray-400 mt-1 text-center">å·²è¿‡ä¿®æ”¹æœŸé™ (3å¤©) / Modification period expired (3 days)</p>
                  )}
                </div>
              </div>
            );
          };

          const HistoryView = () => {
            const dates = Array.from({length: 30}, (_, i) => {
              const date = new Date();
              date.setDate(date.getDate() - i);
              return date;
            });

            // è®¡ç®—æ¯ä¸€å¤©çš„ç´¯è®¡ä½™é¢
            let runningTotal = 0;
            // å…ˆæŒ‰æ—¶é—´æ­£åºç»Ÿè®¡æ€»åˆ†
            const allDates = dates.slice().reverse();
            const dateToBalance = {};
            allDates.forEach(date => {
              const dateStr = getLocalDateStr(date);
              const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
              if (Array.isArray(dayHistory)) {
                dayHistory.forEach(item => {
                  runningTotal += typeof item.points === 'number' ? item.points : 0;
                });
              }
              dateToBalance[dateStr] = runningTotal;
            });

            return (
              <div id="history-view" className="bg-white rounded-xl shadow-lg p-6 mt-8">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-700 flex items-center">
                    <i data-lucide="calendar-days" className="w-7 h-7 inline-block mr-2 align-text-bottom"></i>
                    å†å²è®°å½• History - æœ€è¿‘30å¤©
                  </h2>
                  <button
                    onClick={() => {
                      setViewMode('today');
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                    }}
                    className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                  >
                    <i data-lucide="arrow-left-circle" className="w-5 h-5"></i>
                    è¿”å›
                  </button>
                </div>
                <div className="space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto pr-2">
                  {dates.map(date => {
                    const dateStr = getLocalDateStr(date);
                    const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
                    let score = 0, penalty = 0, redeem = 0;
                    if (Array.isArray(dayHistory)) {
                      dayHistory.forEach(item => {
                        if (item.type === 'redeem') {
                          redeem += typeof item.points === 'number' ? item.points : 0;
                        } else if (item.points > 0) {
                          score += item.points;
                        } else if (item.points < 0) {
                          penalty += item.points;
                        }
                      });
                    }
                    const balance = dateToBalance[dateStr] || 0;
                    return (
                      <div 
                        key={date.toISOString()}
                        onClick={() => {
                          setSelectedDate(date);
                          setViewMode('today');
                        }}
                        className={`p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors flex justify-between items-center shadow-sm ${getLocalDateStr(selectedDate) === dateStr ? 'bg-blue-50' : ''}`}
                      >
                        <span className="font-medium text-gray-700">
                          {date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                          {date.toDateString() === new Date().toDateString() && <span className="text-xs ml-1 text-blue-500">(ä»Šæ—¥)</span>}
                        </span>
                        <div className="flex items-center gap-4 flex-wrap">
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            å®Œæˆç‡: {getCompletionRate(date)}%
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            ä½™é¢: <span className="font-bold text-blue-600">{balance}</span>
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            å¾—åˆ†: <span className="font-bold text-green-600">+{score}</span>
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            æ‰£åˆ†: <span className="font-bold text-red-600">{penalty}</span>
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            å…‘æ¢: <span className="font-bold text-pink-600">{redeem}</span>
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          };

          const earnedTodayOrSelectedDay = (() => {
            const dateStr = getLocalDateStr(selectedDate);
            const todayStr = getLocalDateStr(new Date());
            
            // å¦‚æœæ˜¯è¡¥å½•æ¨¡å¼ï¼Œä½¿ç”¨pendingHistoryçš„æ•°æ®
            let dayHistory;
            if (dateStr !== todayStr && pendingHistory !== null) {
              dayHistory = pendingHistory;
            } else {
              dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            }
            
            let total = 0;
            if (Array.isArray(dayHistory)) {
              dayHistory.forEach(item => {
                if (item.type !== 'redeem') {
                  total += typeof item.points === 'number' ? item.points : 0;
                }
              });
            }
            return total;
          })();
          const completionRateForSelectedDay = getCompletionRate(selectedDate);

          async function addHistory(date, task, type, points) {
            if (!currentUser) return;
            setIsUpdating(true);
            // ç”¨ Supabase æ’å…¥ history
            const { error } = await supabase
              .from('history')
              .insert([
                { 
                  date, 
                  task, 
                  type, 
                  points, 
                  user_id: currentUser.id,
                  child_id: currentChild?.id
                }
              ]);
            if (!error) {
              // ç”¨ Supabase åˆ·æ–°å½“å‰å­©å­çš„ history
              if (currentChild?.id) {
              const { data } = await supabase
                .from('history')
                .select('*')
                  .eq('child_id', currentChild.id);
              setHistory(data || []);
              }
            } else {
              console.error('addHistory error:', error);
            }
            setIsUpdating(false);
          }

          // å·¥å…·å‡½æ•°ï¼šè¿”å›æœ¬åœ° yyyy-mm-dd å­—ç¬¦ä¸²
          function getLocalDateStr(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
          }

          // è®¤è¯å‡½æ•°
          const handleAuth = async () => {
            setIsAuthLoading(true);
            try {
              if (!loginEmail.trim()) {
                alert('è¯·è¾“å…¥é‚®ç®± / Please enter email');
                return;
              }
              
              if (authMode === 'register') {
                if (!loginPassword.trim()) {
                  alert('è¯·è¾“å…¥å¯†ç  / Please enter password');
                  setIsAuthLoading(false);
                  return;
                }
                if (loginPassword.length < 6) {
                  alert('å¯†ç è‡³å°‘6ä½ / Password must be at least 6 characters');
                  setIsAuthLoading(false);
                  return;
                }
                
                const { data, error } = await supabase.auth.signUp({
                  email: loginEmail.trim(),
                  password: loginPassword
                });
                
                if (error) {
                  // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºå‹å¥½çš„ä¸­è‹±æ–‡æç¤º
                  let errorMessage = 'æ³¨å†Œå¤±è´¥ / Registration failed';
                  
                  if (error.message.includes('already registered') || 
                      error.message.includes('already exists') ||
                      error.message.includes('duplicate')) {
                    errorMessage = 'è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•æˆ–ä½¿ç”¨å…¶ä»–é‚®ç®±ï¼/ Email already registered, please login or use another email!';
                  } else if (error.message.includes('password') && 
                             (error.message.includes('short') || error.message.includes('weak'))) {
                    errorMessage = 'å¯†ç å¤ªçŸ­ï¼Œè¯·ä½¿ç”¨è‡³å°‘6ä½å­—ç¬¦ï¼/ Password too short, please use at least 6 characters!';
                  } else if (error.message.includes('email') && 
                             error.message.includes('invalid')) {
                    errorMessage = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥é‚®ç®±åœ°å€ï¼/ Invalid email format, please check your email address!';
                  } else if (error.message.includes('rate limit') || 
                             error.message.includes('too many')) {
                    errorMessage = 'æ³¨å†Œå°è¯•è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ï¼/ Too many registration attempts, please try again later!';
                  } else {
                    errorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼/ Registration failed, please check your network connection!';
                  }
                  
                  alert(errorMessage);
                } else {
                  alert('æ³¨å†ŒæˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥ç›´æ¥ç™»å½•ä½¿ç”¨ / Registration successful! You can now login directly');
                  setLoginEmail('');
                  setLoginPassword('');
                  setAuthMode('login');
                }
              } else if (authMode === 'login') {
                if (!loginPassword.trim()) {
                  alert('è¯·è¾“å…¥å¯†ç  / Please enter password');
                  setIsAuthLoading(false);
                  return;
                }
                
                const { data, error } = await supabase.auth.signInWithPassword({
                  email: loginEmail.trim(),
                  password: loginPassword
                });
                
                if (error) {
                  // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºå‹å¥½çš„ä¸­è‹±æ–‡æç¤º
                  let errorMessage = 'ç™»å½•å¤±è´¥ / Login failed';
                  
                  if (error.message.includes('Invalid login credentials') || 
                      error.message.includes('invalid_credentials') ||
                      error.message.includes('password') ||
                      error.message.includes('incorrect')) {
                    errorMessage = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼/ Incorrect password, please try again!';
                  } else if (error.message.includes('email') || 
                             error.message.includes('user not found')) {
                    errorMessage = 'é‚®ç®±ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é‚®ç®±åœ°å€ï¼/ Email not found, please check your email address!';
                  } else if (error.message.includes('rate limit') || 
                             error.message.includes('too many')) {
                    errorMessage = 'ç™»å½•å°è¯•è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ï¼/ Too many login attempts, please try again later!';
                  } else {
                    errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼/ Login failed, please check your network connection!';
                  }
                  
                  alert(errorMessage);
                } else {
                  setLoginEmail('');
                  setLoginPassword('');
                  // ç™»å½•æˆåŠŸåçš„å¤„ç†å°†åœ¨è®¤è¯çŠ¶æ€ç›‘å¬ä¸­å¤„ç†
                }
              } else if (authMode === 'forgot') {
                const { error } = await supabase.auth.resetPasswordForEmail(loginEmail.trim(), {
                  redirectTo: window.location.origin
                });
                
                if (error) {
                  alert('å‘é€é‡ç½®é“¾æ¥å¤±è´¥ / Failed to send reset link: ' + error.message);
                } else {
                  alert('å¯†ç é‡ç½®é“¾æ¥å·²å‘é€åˆ°é‚®ç®±ï¼/ Password reset link sent to your email!');
                  setLoginEmail('');
                  setAuthMode('login');
                }
              }
            } catch (error) {
              alert('æ“ä½œå¤±è´¥ / Operation failed: ' + error.message);
            }
            
            setIsAuthLoading(false);
          };

          // æäº¤è¡¥å½•
          const submitPendingHistory = async () => {
            if (!currentUser) return;
            const dateStr = getLocalDateStr(selectedDate);
            // å…ˆæ¸…ç©ºè¯¥å­©å­è¯¥æ—¥å†å²
            if (currentChild?.id) {
            await supabase
              .from('history')
              .delete()
                .eq('child_id', currentChild.id)
              .eq('date', dateStr);
            // å†æ‰¹é‡å†™å…¥
            if (pendingHistory && pendingHistory.length > 0) {
              await supabase.from('history').insert(
                pendingHistory.map(item => ({
                  ...item,
                  date: dateStr,
                    user_id: currentUser.id,
                    child_id: currentChild.id
                }))
              );
            }
              // åˆ·æ–°å½“å‰å­©å­çš„ history
            const { data } = await supabase
              .from('history')
              .select('*')
                .eq('child_id', currentChild.id);
            setHistory(data || []);
            }
            setPendingHistory(null);
            setSelectedDate(new Date());
            alert('è¡¥å½•æˆåŠŸï¼Make-up records submitted!');
          };

          // æ·»åŠ ä»»åŠ¡å‡½æ•°
          const handleAddTask = () => {
            if (newTask.name && newTask.nameEn) {
              const taskId = `custom_${Date.now()}`;
              const category = newTask.type === 'penalty' ? 'penalties' : newTask.type;
              
              setTasks(prev => ({
                ...prev,
                [category]: [...prev[category], { 
                  id: taskId, 
                  name: newTask.name, 
                  nameEn: newTask.nameEn, 
                  points: newTask.type === 'penalty' ? -Math.abs(newTask.points) : Math.abs(newTask.points),
                  icon: newTask.icon 
                }]
              }));
              
              setNewTask({ name: '', points: 10, icon: 'â­', type: 'daily' });
              setShowAddTask(false);
              alert('æ·»åŠ æˆåŠŸï¼');
            }
          };

          // æ·»åŠ å¥–åŠ±å‡½æ•°
          const addReward = async (newReward) => {
            if (!currentUser || !currentChild) {
              alert('è¯·å…ˆç™»å½•å¹¶é€‰æ‹©å­©å­');
              return;
            }
            const { error } = await supabase.from('rewards').insert([
              {
                user_id: currentUser.id,
                child_id: currentChild.id,
                name: newReward.name,
                nameEn: newReward.nameEn,
                cost: newReward.cost,
                icon: newReward.icon
              }
            ]);
            if (error) {
              alert('æ·»åŠ å¥–åŠ±å¤±è´¥: ' + error.message);
            } else {
              // é‡æ–°åŠ è½½å½“å‰å­©å­çš„å¥–åŠ±
              const { data } = await supabase.from('rewards').select('*').eq('child_id', currentChild.id);
              setRewards(data || []);
              alert('æ·»åŠ æˆåŠŸï¼');
            }
          };

          // å¥–åŠ±å¡ç‰‡ä¹Ÿæ”¯æŒç¼–è¾‘å’Œåˆ é™¤
          const RewardCard = ({ reward }) => {
            const [editing, setEditing] = useState(false);
            const [editName, setEditName] = useState(reward.name);
            const [editNameEn, setEditNameEn] = useState(reward.nameEn);
            const [editCost, setEditCost] = useState(reward.cost);
            const [editIcon, setEditIcon] = useState(reward.icon);

            const handleSave = () => {
              handleUpdateReward(reward.id, {
                name: editName,
                nameEn: editNameEn,
                cost: Math.abs(editCost),
                icon: editIcon
              });
              setEditing(false);
            };

            if (editing) {
              return (
                <div className="border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center text-center shadow-sm bg-gray-50">
                  <div className="flex flex-wrap gap-2 bg-gray-50 p-2 rounded-lg border mb-2">
                    {emojiOptions.map(emoji => (
                      <button
                        key={emoji}
                        type="button"
                        onClick={() => setEditIcon(emoji)}
                        className={`text-2xl p-2 rounded-md transition-all ${editIcon === emoji ? 'bg-pink-500 text-white scale-110 ring-2 ring-pink-300' : 'hover:bg-gray-200 bg-white'}`}
                      >
                        {emoji}
                      </button>
                    ))}
                  </div>
                  <input
                    type="text"
                    value={editName}
                    onChange={e => setEditName(e.target.value)}
                    className="w-full p-2 border rounded-md focus:ring-pink-500 focus:border-pink-500 mb-2"
                    placeholder="ä¸­æ–‡åç§°"
                  />
                  <input
                    type="text"
                    value={editNameEn}
                    onChange={e => setEditNameEn(e.target.value)}
                    className="w-full p-2 border rounded-md focus:ring-pink-500 focus:border-pink-500 mb-2"
                    placeholder="English Name"
                  />
                  <input
                    type="number"
                    value={editCost}
                    onChange={e => setEditCost(parseInt(e.target.value) || 0)}
                    className="w-24 p-2 border rounded-md focus:ring-pink-500 focus:border-pink-500 mb-2"
                    placeholder="æ‰€éœ€ç§¯åˆ†"
                  />
                  <div className="flex gap-2 mt-2">
                    <button
                      onClick={handleSave}
                      className="bg-pink-500 text-white px-3 py-1.5 rounded-md hover:bg-pink-600 flex items-center"
                    >
                      <i data-lucide="save" className="w-4 h-4 mr-1"></i> ä¿å­˜ Save
                    </button>
                    <button
                      onClick={() => setEditing(false)}
                      className="bg-gray-300 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-400 flex items-center"
                    >
                      <i data-lucide="x" className="w-4 h-4 mr-1"></i> å–æ¶ˆ Cancel
                    </button>
                  </div>
                </div>
              );
            }

            return (
              <div className="border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center text-center shadow-sm hover:shadow-md group relative">
                <span className="text-4xl mb-2.5 block">{reward.icon}</span>
                <h3 className="font-semibold text-gray-800">{reward.name}</h3>
                <p className="text-xs text-gray-500 mb-1.5">{reward.nameEn}</p>
                <p className="text-lg font-bold text-pink-600 my-2">{reward.cost} ç§¯åˆ†</p>
                <div className="flex gap-1 mb-2 opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-2 left-2">
                  <button
                    type="button"
                    onClick={() => setEditing(true)}
                    className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-pink-100 hover:text-pink-600 transition"
                    title="ç¼–è¾‘å¥–åŠ± Edit Reward"
                  >
                    <i data-lucide="edit-2" className="w-3 h-3"></i>
                  </button>
                  <button
                    type="button"
                    onClick={() => deleteReward(reward.id)}
                    className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-600 transition"
                    title="åˆ é™¤å¥–åŠ± Delete Reward"
                  >
                    <i data-lucide="x" className="w-3 h-3"></i>
                  </button>
                </div>
                <button
                  onClick={() => redeemReward(reward)}
                  disabled={totalPoints < reward.cost}
                  className={`w-full mt-auto py-2.5 rounded-lg text-sm font-medium transition-all ${
                    totalPoints >= reward.cost
                      ? 'bg-pink-500 text-white hover:bg-pink-600'
                      : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  }`}
                >
                  {totalPoints >= reward.cost ? 'å…‘æ¢ Redeem' : 'ç§¯åˆ†ä¸è¶³ / Not enough points'}
                </button>
              </div>
            );
          };

          // æ›´æ–°å¥–åŠ±
          const handleUpdateReward = (rewardId, updates) => {
            setRewards(prev => prev.map(r => r.id === rewardId ? { ...r, ...updates } : r));
          };
          // åˆ é™¤å¥–åŠ±
          const deleteReward = async (rewardId) => {
            if (!currentUser || !currentChild) return;
            await supabase.from('rewards').delete().eq('id', rewardId).eq('child_id', currentChild.id);
            // é‡æ–°åŠ è½½å½“å‰å­©å­çš„å¥–åŠ±
            const { data } = await supabase.from('rewards').select('*').eq('child_id', currentChild.id);
            setRewards(data || []);
          };

          // ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šæ•°æ®
          const generateReportData = async (childId, period = 'week') => {
            console.log('å¼€å§‹ç”ŸæˆæŠ¥å‘Šæ•°æ®...', { childId, period });
            setIsLoadingReport(true);
            setReportData(null); // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
            
            try {
              // éªŒè¯è¾“å…¥å‚æ•°
              if (!childId) {
                throw new Error('æœªé€‰æ‹©å­©å­');
              }

              // è®¡ç®—æ—¥æœŸèŒƒå›´
              const now = new Date();
              let startDate, endDate;
              
              switch(period) {
                case 'week':
                  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  endDate = now;
                  break;
                case 'month':
                  startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                  endDate = now;
                  break;
                case 'quarter':
                  startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                  endDate = now;
                  break;
                case 'year':
                  startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                  endDate = now;
                  break;
                case 'custom':
                  console.log('å¤„ç†è‡ªå®šä¹‰æ—¥æœŸ:', { customStartDate, customEndDate });
                  if (!customStartDate || !customEndDate) {
                    throw new Error('è¯·é€‰æ‹©è‡ªå®šä¹‰å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                  }
                  startDate = new Date(customStartDate);
                  endDate = new Date(customEndDate);
                  
                  console.log('è§£æåçš„æ—¥æœŸ:', { startDate, endDate });
                  
                  // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
                  if (startDate > endDate) {
                    throw new Error('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                  }
                  if (startDate > now) {
                    throw new Error('å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ');
                  }
                  if (endDate > now) {
                    endDate = now; // ç»“æŸæ—¥æœŸä¸èƒ½è¶…è¿‡ä»Šå¤©
                    console.log('ç»“æŸæ—¥æœŸè°ƒæ•´ä¸ºä»Šå¤©:', endDate);
                  }
                  
                  console.log('æœ€ç»ˆæ—¥æœŸèŒƒå›´:', { startDate, endDate });
                  break;
                default:
                  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  endDate = now;
              }

              console.log('æŸ¥è¯¢æ—¥æœŸèŒƒå›´:', { 
                startDate: getLocalDateStr(startDate), 
                endDate: getLocalDateStr(endDate) 
              });

              // è·å–å†å²æ•°æ®
              const { data: historyData, error } = await supabase
                .from('history')
                .select('*')
                .eq('child_id', childId)
                .gte('date', getLocalDateStr(startDate))
                .lte('date', getLocalDateStr(endDate))
                .order('date', { ascending: true });

              if (error) {
                console.error('SupabaseæŸ¥è¯¢é”™è¯¯:', error);
                throw error;
              }

              console.log('è·å–åˆ°å†å²æ•°æ®:', historyData?.length || 0, 'æ¡è®°å½•');

              // åˆ†ææ•°æ®
              const analysis = analyzeHistoryData(historyData || [], startDate, endDate);
              console.log('æ•°æ®åˆ†æå®Œæˆ:', analysis);
              
              return analysis;
            } catch (error) {
              console.error('ç”ŸæˆæŠ¥å‘Šæ•°æ®é”™è¯¯:', error);
              // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
              const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
              console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
              alert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + errorMessage);
              setReportData(null);
              return null;
            } finally {
              console.log('æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼Œæ¸…é™¤åŠ è½½çŠ¶æ€');
              setIsLoadingReport(false);
            }
          };

          // åˆ†æå†å²æ•°æ®
          const analyzeHistoryData = (historyData, startDate, endDate) => {
            const analysis = {
              period: {
                startDate: getLocalDateStr(startDate),
                endDate: getLocalDateStr(endDate),
                totalDays: Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24))
              },
              summary: {
                totalTasks: 0,
                completedTasks: 0,
                totalPointsEarned: 0,
                totalPointsLost: 0,
                totalRewardsClaimed: 0,
                netPoints: 0
              },
              dailyBreakdown: {},
              categoryBreakdown: {
                daily: { count: 0, points: 0 },
                behavior: { count: 0, points: 0 },
                penalties: { count: 0, points: 0 },
                redeem: { count: 0, points: 0 }
              },
              trends: {
                dailyPoints: [],
                weeklyCompletion: []
              },
              topTasks: {
                mostCompleted: [],
                highestPoints: [],
                commonPenalties: []
              },
              rewardStats: {
                mostRedeemed: [],
                rewardBreakdown: {}
              }
            };

            // æŒ‰æ—¥æœŸåˆ†ç»„æ•°æ®
            const dateGroups = {};
            historyData.forEach(item => {
              if (!dateGroups[item.date]) {
                dateGroups[item.date] = [];
              }
              dateGroups[item.date].push(item);
            });

            // åˆ†ææ¯æ—¥æ•°æ®
            Object.keys(dateGroups).forEach(date => {
              const dayData = dateGroups[date];
              let dayPoints = 0;
              let dayTaskCount = 0;
              let dayCompletedTasks = 0;

              dayData.forEach(item => {
                dayPoints += (item.points || 0);
                
                if (item.type === 'redeem') {
                  analysis.summary.totalRewardsClaimed++;
                  analysis.categoryBreakdown.redeem.count++;
                  analysis.categoryBreakdown.redeem.points += (item.points || 0);
                } else {
                  // ç»Ÿè®¡æ‰€æœ‰ä»»åŠ¡å®Œæˆæ¬¡æ•°ï¼ˆåŒ…æ‹¬æ­£å‘å’Œè´Ÿå‘ï¼‰
                  dayTaskCount++;
                  analysis.summary.totalTasks++;
                  
                  // åŒºåˆ†å®Œæˆï¼ˆæ­£ç§¯åˆ†ï¼‰å’Œæ‰£åˆ†ï¼ˆè´Ÿç§¯åˆ†ï¼‰
                  if (item.points > 0) {
                    analysis.summary.totalPointsEarned += item.points;
                    dayCompletedTasks++;
                    analysis.summary.completedTasks++;
                  } else {
                    analysis.summary.totalPointsLost += Math.abs(item.points);
                  }

                  // åˆ†ç±»ç»Ÿè®¡
                  if (analysis.categoryBreakdown[item.type]) {
                    analysis.categoryBreakdown[item.type].count++;
                    analysis.categoryBreakdown[item.type].points += (item.points || 0);
                  }
                }
              });

              analysis.dailyBreakdown[date] = {
                points: dayPoints,
                taskCount: dayTaskCount,
                completedTasks: dayCompletedTasks,
                completionRate: 0 // éœ€è¦åŸºäºå¯ç”¨ä»»åŠ¡è®¡ç®—
              };

              analysis.trends.dailyPoints.push({
                date: date,
                points: dayPoints,
                taskCount: dayTaskCount
              });
            });

            // è®¡ç®—å‡€ç§¯åˆ†
            analysis.summary.netPoints = analysis.summary.totalPointsEarned - analysis.summary.totalPointsLost;

            // åˆ†æçƒ­é—¨ä»»åŠ¡
            const taskCounts = {};
            const taskPoints = {};
            const penaltyTasks = {};
            const rewardCounts = {};

            historyData.forEach(item => {
              if (item.type !== 'redeem') {
                taskCounts[item.task] = (taskCounts[item.task] || 0) + 1;
                taskPoints[item.task] = (taskPoints[item.task] || 0) + (item.points || 0);
                
                if (item.points < 0) {
                  penaltyTasks[item.task] = (penaltyTasks[item.task] || 0) + 1;
                }
              } else {
                // ç»Ÿè®¡å¥–åŠ±å…‘æ¢
                const rewardName = item.task.replace('å…‘æ¢', ''); // å»æ‰"å…‘æ¢"åç¼€
                if (!rewardCounts[rewardName]) {
                  rewardCounts[rewardName] = {
                    name: rewardName,
                    count: 0,
                    totalCost: 0
                  };
                }
                rewardCounts[rewardName].count++;
                rewardCounts[rewardName].totalCost += Math.abs(item.points || 0);
              }
            });

            // æ’åºå¹¶å–å‰5
            analysis.topTasks.mostCompleted = Object.entries(taskCounts)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5)
              .map(([task, count]) => ({ task, count }));

            analysis.topTasks.highestPoints = Object.entries(taskPoints)
              .filter(([, points]) => points > 0)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5)
              .map(([task, points]) => ({ task, points }));

            analysis.topTasks.commonPenalties = Object.entries(penaltyTasks)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 5)
              .map(([task, count]) => ({ task, count }));

            // åˆ†æå¥–åŠ±å…‘æ¢æ•°æ®
            analysis.rewardStats.mostRedeemed = Object.values(rewardCounts)
              .sort((a, b) => b.count - a.count)
              .slice(0, 5);

            analysis.rewardStats.rewardBreakdown = rewardCounts;

            return analysis;
          };

          // å¯¼å‡ºæ•°æ®ä¸ºExcel
          const exportToExcel = async (childId, period = 'week') => {
            try {
              console.log('å¼€å§‹å¯¼å‡ºExcel...', { childId, period });
              
              // ä½¿ç”¨å½“å‰å·²æœ‰çš„æŠ¥å‘Šæ•°æ®ï¼Œé¿å…é‡å¤æŸ¥è¯¢
              let data = reportData;
              if (!data) {
                console.log('æ²¡æœ‰ç°æœ‰æ•°æ®ï¼Œé‡æ–°ç”Ÿæˆ...');
                data = await generateReportData(childId, period);
              }
              
              if (!data) {
                throw new Error('æ— æ³•è·å–æŠ¥å‘Šæ•°æ®');
              }
              
              const child = children.find(c => c.id === childId);
              
              // åˆ›å»ºå·¥ä½œç°¿
              const wb = XLSX.utils.book_new();
              
              // æ¦‚è¦sheet
              // è®¡ç®—æ›´åˆç†çš„å®Œæˆç‡ï¼šæ­£å‘å®Œæˆä»»åŠ¡æ•° / æ‰€æœ‰ä»»åŠ¡å®Œæˆæ•°ï¼ˆä¸åŒ…æ‹¬å¥–åŠ±å…‘æ¢ï¼‰
              const taskCompletionRate = data.summary.totalTasks > 0 ? 
                Math.round((data.summary.completedTasks / data.summary.totalTasks) * 100) : 0;
              
              const summaryData = [
                ['é¡¹ç›®', 'æ•°å€¼'],
                ['æŠ¥å‘ŠæœŸé—´', `${data.period.startDate} è‡³ ${data.period.endDate}`],
                ['æ€»å¤©æ•°', data.period.totalDays],
                ['ä»»åŠ¡å®Œæˆæ€»æ¬¡æ•°', data.summary.totalTasks],
                ['æ­£å‘å®Œæˆæ¬¡æ•°', data.summary.completedTasks],
                ['æ‰£åˆ†/å¤±è´¥æ¬¡æ•°', data.summary.totalTasks - data.summary.completedTasks],
                ['ä»»åŠ¡å®Œæˆç‡', `${taskCompletionRate}%`],
                ['è·å¾—ç§¯åˆ†', data.summary.totalPointsEarned],
                ['æ‰£é™¤ç§¯åˆ†', data.summary.totalPointsLost],
                ['å‡€ç§¯åˆ†', data.summary.netPoints],
                ['å…‘æ¢å¥–åŠ±æ¬¡æ•°', data.summary.totalRewardsClaimed]
              ];
              
              const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
              XLSX.utils.book_append_sheet(wb, summaryWs, 'æ¦‚è¦');

              // æ¯æ—¥æ˜ç»†sheet
              const dailyData = [['æ—¥æœŸ', 'ç§¯åˆ†', 'ä»»åŠ¡æ•°é‡']];
              data.trends.dailyPoints.forEach(day => {
                dailyData.push([day.date, day.points, day.taskCount]);
              });
              
              const dailyWs = XLSX.utils.aoa_to_sheet(dailyData);
              XLSX.utils.book_append_sheet(wb, dailyWs, 'æ¯æ—¥æ˜ç»†');

              // åˆ†ç±»ç»Ÿè®¡sheet
              const categoryData = [['åˆ†ç±»', 'æ¬¡æ•°', 'ç§¯åˆ†']];
              Object.entries(data.categoryBreakdown).forEach(([category, stats]) => {
                const categoryName = {
                  daily: 'æ¯æ—¥ä»»åŠ¡',
                  behavior: 'è¡Œä¸ºä¹ æƒ¯',
                  penalties: 'æ‰£åˆ†é¡¹',
                  redeem: 'å¥–åŠ±å…‘æ¢'
                }[category] || category;
                categoryData.push([categoryName, stats.count, stats.points]);
              });
              
              const categoryWs = XLSX.utils.aoa_to_sheet(categoryData);
              XLSX.utils.book_append_sheet(wb, categoryWs, 'åˆ†ç±»ç»Ÿè®¡');

              // è¯¦ç»†ä»»åŠ¡ç»Ÿè®¡sheet - æ–°å¢
              try {
                console.log('æŸ¥è¯¢è¯¦ç»†ä»»åŠ¡æ•°æ®...');
                const { data: allHistoryData, error: historyError } = await supabase
                  .from('history')
                  .select('*')
                  .eq('child_id', childId)
                  .gte('date', data.period.startDate)
                  .lte('date', data.period.endDate)
                  .order('task', { ascending: true });

                if (historyError) {
                  console.error('æŸ¥è¯¢è¯¦ç»†ä»»åŠ¡æ•°æ®å¤±è´¥:', historyError);
                  throw historyError;
                }

                if (allHistoryData && allHistoryData.length > 0) {
                  console.log('è·å–åˆ°è¯¦ç»†ä»»åŠ¡æ•°æ®:', allHistoryData.length, 'æ¡');
                // ç»Ÿè®¡æ¯ä¸ªä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
                const taskStats = {};
                allHistoryData.forEach(item => {
                  if (item.type !== 'redeem') { // æ’é™¤å¥–åŠ±å…‘æ¢
                    if (!taskStats[item.task]) {
                      taskStats[item.task] = {
                        task: item.task,
                        type: item.type,
                        count: 0,
                        totalPoints: 0,
                        avgPoints: 0,
                        firstDate: item.date,
                        lastDate: item.date
                      };
                    }
                    
                    taskStats[item.task].count++;
                    taskStats[item.task].totalPoints += (item.points || 0);
                    
                    // æ›´æ–°é¦–æ¬¡å’Œæœ€åå®Œæˆæ—¥æœŸ
                    if (item.date < taskStats[item.task].firstDate) {
                      taskStats[item.task].firstDate = item.date;
                    }
                    if (item.date > taskStats[item.task].lastDate) {
                      taskStats[item.task].lastDate = item.date;
                    }
                  }
                });

                // è®¡ç®—å¹³å‡åˆ†å¹¶æ’åº
                const sortedTasks = Object.values(taskStats)
                  .map(stat => ({
                    ...stat,
                    avgPoints: stat.count > 0 ? Math.round(stat.totalPoints / stat.count * 100) / 100 : 0
                  }))
                  .sort((a, b) => b.count - a.count); // æŒ‰å®Œæˆæ¬¡æ•°é™åºæ’åˆ—

                // åˆ›å»ºä»»åŠ¡æ˜ç»†æ•°æ®
                const taskDetailData = [
                  ['ä»»åŠ¡åç§°', 'ä»»åŠ¡ç±»å‹', 'å®Œæˆæ¬¡æ•°', 'æ€»ç§¯åˆ†', 'å¹³å‡ç§¯åˆ†', 'é¦–æ¬¡å®Œæˆ', 'æœ€åå®Œæˆ']
                ];

                sortedTasks.forEach(stat => {
                  const typeName = {
                    daily: 'æ¯æ—¥ä»»åŠ¡',
                    behavior: 'è¡Œä¸ºä¹ æƒ¯', 
                    penalties: 'æ‰£åˆ†é¡¹'
                  }[stat.type] || stat.type;

                  taskDetailData.push([
                    stat.task,
                    typeName,
                    stat.count,
                    stat.totalPoints,
                    stat.avgPoints,
                    stat.firstDate,
                    stat.lastDate
                  ]);
                });

                const taskDetailWs = XLSX.utils.aoa_to_sheet(taskDetailData);
                
                // è®¾ç½®åˆ—å®½
                taskDetailWs['!cols'] = [
                  { width: 25 }, // ä»»åŠ¡åç§°
                  { width: 12 }, // ä»»åŠ¡ç±»å‹
                  { width: 10 }, // å®Œæˆæ¬¡æ•°
                  { width: 10 }, // æ€»ç§¯åˆ†
                  { width: 10 }, // å¹³å‡ç§¯åˆ†
                  { width: 12 }, // é¦–æ¬¡å®Œæˆ
                  { width: 12 }  // æœ€åå®Œæˆ
                ];
                                 
                XLSX.utils.book_append_sheet(wb, taskDetailWs, 'ä»»åŠ¡æ˜ç»†ç»Ÿè®¡');
                } else {
                  console.log('æ²¡æœ‰è¯¦ç»†ä»»åŠ¡æ•°æ®ï¼Œè·³è¿‡æ˜ç»†ç»Ÿè®¡è¡¨');
                }
              } catch (detailError) {
                console.error('ç”Ÿæˆè¯¦ç»†ä»»åŠ¡ç»Ÿè®¡æ—¶å‡ºé”™:', detailError);
                // å³ä½¿è¯¦ç»†ç»Ÿè®¡å¤±è´¥ï¼Œä¹Ÿç»§ç»­å¯¼å‡ºå…¶ä»–æ•°æ®
              }

              // çƒ­é—¨ä»»åŠ¡sheet
              const topTasksData = [['ç±»å‹', 'ä»»åŠ¡åç§°', 'æ¬¡æ•°/ç§¯åˆ†']];
              data.topTasks.mostCompleted.forEach(item => {
                topTasksData.push(['æœ€å¸¸å®Œæˆ', item.task, item.count]);
              });
              data.topTasks.highestPoints.forEach(item => {
                topTasksData.push(['æœ€é«˜ç§¯åˆ†', item.task, item.points]);
              });
              data.topTasks.commonPenalties.forEach(item => {
                topTasksData.push(['å¸¸è§æ‰£åˆ†', item.task, item.count]);
              });
              
              const topTasksWs = XLSX.utils.aoa_to_sheet(topTasksData);
                              XLSX.utils.book_append_sheet(wb, topTasksWs, 'çƒ­é—¨ä»»åŠ¡');

              // å¥–åŠ±å…‘æ¢æ˜ç»†ç»Ÿè®¡sheet - æ–°å¢
              try {
                console.log('ç”Ÿæˆå¥–åŠ±å…‘æ¢ç»Ÿè®¡...');
                const { data: rewardHistoryData, error: rewardError } = await supabase
                  .from('history')
                  .select('*')
                  .eq('child_id', childId)
                  .eq('type', 'redeem')
                  .gte('date', data.period.startDate)
                  .lte('date', data.period.endDate)
                  .order('task', { ascending: true });

                if (rewardError) {
                  console.error('æŸ¥è¯¢å¥–åŠ±å…‘æ¢æ•°æ®å¤±è´¥:', rewardError);
                  throw rewardError;
                }

                if (rewardHistoryData && rewardHistoryData.length > 0) {
                  console.log('è·å–åˆ°å¥–åŠ±å…‘æ¢æ•°æ®:', rewardHistoryData.length, 'æ¡');
                  
                  // ç»Ÿè®¡æ¯ä¸ªå¥–åŠ±çš„è¯¦ç»†ä¿¡æ¯
                  const rewardStats = {};
                  rewardHistoryData.forEach(item => {
                    const rewardName = item.task.replace('å…‘æ¢', ''); // å»æ‰"å…‘æ¢"åç¼€
                    
                    if (!rewardStats[rewardName]) {
                      rewardStats[rewardName] = {
                        reward: rewardName,
                        count: 0,
                        totalCost: 0,
                        avgCost: 0,
                        firstDate: item.date,
                        lastDate: item.date
                      };
                    }
                    
                    rewardStats[rewardName].count++;
                    rewardStats[rewardName].totalCost += Math.abs(item.points || 0);
                    
                    // æ›´æ–°é¦–æ¬¡å’Œæœ€åå…‘æ¢æ—¥æœŸ
                    if (item.date < rewardStats[rewardName].firstDate) {
                      rewardStats[rewardName].firstDate = item.date;
                    }
                    if (item.date > rewardStats[rewardName].lastDate) {
                      rewardStats[rewardName].lastDate = item.date;
                    }
                  });

                  // è®¡ç®—å¹³å‡æˆæœ¬å¹¶æ’åº
                  const sortedRewards = Object.values(rewardStats)
                    .map(stat => ({
                      ...stat,
                      avgCost: stat.count > 0 ? Math.round(stat.totalCost / stat.count * 100) / 100 : 0
                    }))
                    .sort((a, b) => b.count - a.count); // æŒ‰å…‘æ¢æ¬¡æ•°é™åºæ’åˆ—

                  // åˆ›å»ºå¥–åŠ±æ˜ç»†æ•°æ®
                  const rewardDetailData = [
                    ['å¥–åŠ±åç§°', 'å…‘æ¢æ¬¡æ•°', 'æ€»ç§¯åˆ†æ¶ˆè€—', 'å¹³å‡ç§¯åˆ†æ¶ˆè€—', 'é¦–æ¬¡å…‘æ¢', 'æœ€åå…‘æ¢']
                  ];

                  sortedRewards.forEach(stat => {
                    rewardDetailData.push([
                      stat.reward,
                      stat.count,
                      stat.totalCost,
                      stat.avgCost,
                      stat.firstDate,
                      stat.lastDate
                    ]);
                  });

                  const rewardDetailWs = XLSX.utils.aoa_to_sheet(rewardDetailData);
                  
                  // è®¾ç½®åˆ—å®½
                  rewardDetailWs['!cols'] = [
                    { width: 20 }, // å¥–åŠ±åç§°
                    { width: 12 }, // å…‘æ¢æ¬¡æ•°
                    { width: 15 }, // æ€»ç§¯åˆ†æ¶ˆè€—
                    { width: 15 }, // å¹³å‡ç§¯åˆ†æ¶ˆè€—
                    { width: 12 }, // é¦–æ¬¡å…‘æ¢
                    { width: 12 }  // æœ€åå…‘æ¢
                  ];
                  
                  XLSX.utils.book_append_sheet(wb, rewardDetailWs, 'å¥–åŠ±å…‘æ¢ç»Ÿè®¡');
                } else {
                  console.log('æ²¡æœ‰å¥–åŠ±å…‘æ¢æ•°æ®');
                  
                  // å³ä½¿æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªç©ºè¡¨æ ¼
                  const emptyRewardData = [
                    ['å¥–åŠ±åç§°', 'å…‘æ¢æ¬¡æ•°', 'æ€»ç§¯åˆ†æ¶ˆè€—', 'å¹³å‡ç§¯åˆ†æ¶ˆè€—', 'é¦–æ¬¡å…‘æ¢', 'æœ€åå…‘æ¢'],
                    ['æš‚æ— å¥–åŠ±å…‘æ¢è®°å½•', '-', '-', '-', '-', '-']
                  ];
                  
                  const emptyRewardWs = XLSX.utils.aoa_to_sheet(emptyRewardData);
                  XLSX.utils.book_append_sheet(wb, emptyRewardWs, 'å¥–åŠ±å…‘æ¢ç»Ÿè®¡');
                }
              } catch (rewardError) {
                console.error('ç”Ÿæˆå¥–åŠ±å…‘æ¢ç»Ÿè®¡æ—¶å‡ºé”™:', rewardError);
                // å³ä½¿å¥–åŠ±ç»Ÿè®¡å¤±è´¥ï¼Œä¹Ÿç»§ç»­å¯¼å‡ºå…¶ä»–æ•°æ®
              }

              // å¯¼å‡ºæ–‡ä»¶
              const fileName = `${child?.name || 'å­©å­'}_${period}_æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`;
              XLSX.writeFile(wb, fileName);
              
              alert('ExcelæŠ¥å‘Šå·²æˆåŠŸå¯¼å‡ºï¼åŒ…å«6ä¸ªè¯¦ç»†è¡¨æ ¼ï¼šæ¦‚è¦ã€æ¯æ—¥æ˜ç»†ã€åˆ†ç±»ç»Ÿè®¡ã€ä»»åŠ¡æ˜ç»†ç»Ÿè®¡ã€å¥–åŠ±å…‘æ¢ç»Ÿè®¡ã€çƒ­é—¨ä»»åŠ¡ã€‚');
            } catch (error) {
              console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
              alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
          };



          // å¤„ç†åŠŸèƒ½å¡ç‰‡ç‚¹å‡»
          const handleFeatureClick = (feature) => {
            if (currentUser) {
              // å·²ç™»å½•ï¼Œç›´æ¥æ‰§è¡ŒåŠŸèƒ½
              switch(feature) {
                case 'tasks':
                  setViewMode('today');
                  break;
                case 'tracking':
                  // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼ˆå·²åœ¨é¡µé¢é¡¶éƒ¨ï¼‰
                  break;
                case 'rewards':
                  setViewMode('today');
                  setShowRewards(true);
                  break;
                case 'history':
                  setViewMode('history');
                  setTimeout(() => {
                    document.getElementById('history-view')?.scrollIntoView({ behavior: 'smooth' });
                  }, 100);
                  break;
                case 'reports':
                  console.log('æ‰“å¼€ç»Ÿè®¡æŠ¥å‘Šé¡µé¢');
                  setShowReportsPage(true);
                  setReportData(null); // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
                  setIsLoadingReport(false); // é‡ç½®åŠ è½½çŠ¶æ€
                  
                  // ä½¿ç”¨ setTimeout ç¡®ä¿çŠ¶æ€æ›´æ–°å®Œæˆ
                  setTimeout(() => {
                    if (currentChild) {
                      console.log('å¼€å§‹ä¸ºå­©å­ç”ŸæˆæŠ¥å‘Š:', currentChild.name);
                      generateReportData(currentChild.id, reportPeriod).then(data => {
                        console.log('æŠ¥å‘Šæ•°æ®ç”Ÿæˆç»“æœ:', data ? 'æˆåŠŸ' : 'å¤±è´¥');
                        if (data) {
                          setReportData(data);
                        }
                      }).catch(error => {
                        console.error('ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™:', error);
                        setIsLoadingReport(false);
                        setReportData(null);
                      });
                    } else {
                      console.warn('æ²¡æœ‰é€‰æ‹©çš„å­©å­');
                      setIsLoadingReport(false);
                    }
                  }, 100);
                  break;
              }
            } else {
              // æœªç™»å½•ï¼Œä¿å­˜å¾…æ‰§è¡ŒåŠ¨ä½œå¹¶æ˜¾ç¤ºç™»å½•æ¡†
              setPendingAction(feature);
              setShowLoginModal(true);
            }
          };

          // ç™»å½•æˆåŠŸåæ‰§è¡Œå¾…æ‰§è¡Œçš„åŠ¨ä½œ
          const executePendingAction = () => {
            console.log('æ‰§è¡Œå¾…æ‰§è¡Œçš„åŠ¨ä½œ');
            try {
              if (pendingAction) {
                handleFeatureClick(pendingAction);
                setPendingAction(null);
              }
            } catch (error) {
              console.error('æ‰§è¡Œå¾…æ‰§è¡ŒåŠ¨ä½œæ—¶å‡ºé”™:', error);
            }
            
            // ç¡®ä¿å…³é—­ç™»å½•æ¨¡æ€æ¡†å’Œåœæ­¢åŠ è½½çŠ¶æ€
            setShowLoginModal(false);
            setIsAuthLoading(false);
            console.log('ç™»å½•æµç¨‹å®Œæˆ');
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-yellow-100 via-pink-100 to-blue-100 p-2 sm:p-4 font-[sans-serif]">
              <div className="max-w-5xl mx-auto main-container">
                {/* Logoå±…ä¸­æ˜¾ç¤º */}
                <div className="relative px-4 sm:px-6 py-4 mb-6">
                  {/* å±…ä¸­çš„LogoåŒºåŸŸ */}
                  <div className="flex flex-col items-center text-center">
                    <div className="text-4xl sm:text-5xl mb-3">ğŸš€</div>
                    <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-1">å°å†’é™©å®¶ä»»åŠ¡ç³»ç»Ÿ</h1>
                    <p className="text-base sm:text-lg text-gray-600">Little Explorer Mission System</p>
                  </div>
                  
                  {/* ç”¨æˆ·ä¿¡æ¯æˆ–ç™»å½•æŒ‰é’®å›ºå®šåœ¨å³ä¸Šè§’ */}
                  <div className="absolute top-4 right-4 sm:right-6 flex items-center space-x-3 z-50">
                    {currentUser ? (
                      // å·²ç™»å½•ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’®
                      <>
                        <span className="text-sm text-gray-700 hidden sm:block font-medium">
                          æ¬¢è¿ï¼Œ{currentUser.email}
                        </span>
                      <button
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('é€€å‡ºæŒ‰é’®è¢«ç‚¹å‡»');
                            
                            // ä½¿ç”¨ç®€å•çš„æ–¹å¼é€€å‡º
                            const confirmLogout = () => {
                              console.log('ç¡®è®¤é€€å‡º');
                              // æ¸…ç†æ‰€æœ‰çŠ¶æ€
                          setCurrentUser(null);
                              setChildren([]);
                              setCurrentChild(null);
                          setTasks([]);
                          setRewards([]);
                          setHistory([]);
                              setTotalPoints(0);
                          localStorage.clear();
                              
                              // æ‰§è¡ŒSupabaseé€€å‡º
                              supabase.auth.signOut().then(() => {
                                console.log('Supabaseé€€å‡ºæˆåŠŸ');
                                setTimeout(() => {
                          window.location.reload();
                                }, 100);
                              }).catch((error) => {
                                console.error('Supabaseé€€å‡ºå¤±è´¥:', error);
                                // å³ä½¿Supabaseé€€å‡ºå¤±è´¥ï¼Œä¹Ÿå¼ºåˆ¶åˆ·æ–°é¡µé¢
                                setTimeout(() => {
                                  window.location.reload();
                                }, 100);
                              });
                            };
                            
                            // ç«‹å³æ‰§è¡Œé€€å‡º
                            confirmLogout();
                          }}
                          className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center space-x-1 shadow-lg cursor-pointer"
                          style={{ position: 'relative', zIndex: 9999, pointerEvents: 'auto' }}
                        >
                          <i data-lucide="log-out" className="w-4 h-4"></i>
                          <span className="hidden sm:inline">é€€å‡º</span>
                      </button>
                      </>
                    ) : (
                      // æœªç™»å½•ï¼šæ˜¾ç¤ºå°çš„ç™»å½•æŒ‰é’®
                      <button
                        onClick={() => setShowLoginModal(true)}
                        className="bg-white/90 hover:bg-white text-gray-700 hover:text-gray-900 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center space-x-1 shadow-lg backdrop-blur-sm border border-gray-200 hover:border-gray-300"
                      >
                        <i data-lucide="log-in" className="w-4 h-4"></i>
                        <span className="hidden sm:inline">ç™»å½•</span>
                      </button>
                    )}
                  </div>
                </div>

                {/* Hero Banner Section */}
                <header className="bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 rounded-xl shadow-lg mb-6 relative overflow-hidden">
                  {/* å¯çˆ±çš„èƒŒæ™¯è£…é¥° */}
                  <div className="absolute top-3 left-6 text-2xl animate-bounce" style={{animationDelay: '0s'}}>ğŸŒŸ</div>
                  <div className="absolute top-4 right-8 text-xl animate-bounce" style={{animationDelay: '0.5s'}}>ğŸˆ</div>
                  <div className="absolute bottom-3 left-8 text-lg animate-bounce" style={{animationDelay: '1s'}}>ğŸ¯</div>
                  <div className="absolute bottom-4 right-6 text-xl animate-bounce" style={{animationDelay: '1.5s'}}>âœ¨</div>
                  
                  {!currentUser ? (
                    // æœªç™»å½•æ—¶æ˜¾ç¤ºå®£ä¼ banner
                    <div className="text-center relative z-10 py-12 sm:py-16 px-6">
                      <div className="text-4xl sm:text-6xl mb-4 animate-pulse">ğŸ†</div>
                      <h2 className="text-2xl sm:text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg leading-tight">
                        æ¯å¤©å®Œæˆä»»åŠ¡ï¼Œèµšå–ç§¯åˆ†ï¼Œå…‘æ¢å¥–åŠ±ï¼
                      </h2>
                      <p className="text-lg sm:text-xl text-white/90 font-medium drop-shadow leading-relaxed mb-6">
                        Complete tasks â€¢ Earn points â€¢ Get rewards!
                      </p>
                      
                      {/* ç™»å½•æŒ‰é’® */}
                      <button
                        onClick={() => setShowLoginModal(true)}
                        className="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white font-semibold px-6 py-3 rounded-full border-2 border-white/40 hover:border-white/60 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center gap-2 mx-auto"
                      >
                        <i data-lucide="log-in" className="w-5 h-5"></i>
                        ç«‹å³å¼€å§‹ / Start Now
                      </button>
                    </div>
                  ) : (
                    // ç™»å½•åæ˜¾ç¤ºç®€æ´ä¿¡æ¯
                    <div className="text-center relative z-10 py-8 px-6">
                      <div className="text-3xl sm:text-4xl mb-3 animate-pulse">ğŸ®</div>
                      <h2 className="text-xl sm:text-2xl font-bold text-white mb-2 drop-shadow-lg">
                        æ¬¢è¿å›æ¥ï¼Œå‡†å¤‡å¼€å§‹æ–°çš„å†’é™©å§ï¼
                      </h2>
                      <p className="text-white/90 text-sm sm:text-base">Welcome back, ready for new adventures!</p>
                    </div>
                  )}

                </header>

                {/* å­©å­ç®¡ç†å’Œé€‰æ‹©å™¨ */}
                {currentUser && !showChildrenManager && children.length > 0 && (
                  <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-200">
                    <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                      <div className="flex items-center gap-3">
                        <span className="font-medium text-gray-700">å½“å‰æŸ¥çœ‹:</span>
                        <select
                          value={currentChild?.id ? String(currentChild.id) : ''}
                          onChange={(e) => {
                            console.log('é€‰æ‹©å­©å­:', e.target.value);
                            const selectedValue = e.target.value;
                            const selectedChild = children.find(child => 
                              String(child.id) === selectedValue
                            );
                            console.log('æ‰¾åˆ°çš„å­©å­:', selectedChild);
                            if (selectedChild) {
                              setCurrentChild(selectedChild);
                              console.log('åˆ‡æ¢åˆ°å­©å­:', selectedChild.name);
                            }
                          }}
                          className="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                        >
                          {children.map(child => (
                            <option key={child.id} value={String(child.id)}>
                              {child.avatar} {child.name} ({new Date().getFullYear() - child.birth_year}å²)
                            </option>
                          ))}
                        </select>
                        {currentChild && (
                          <div className="ml-3 px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm font-medium">
                            å½“å‰: {currentChild.avatar} {currentChild.name}
                          </div>
                        )}
                      </div>
                      
                      <div className="flex items-center gap-2 flex-wrap">
                        <button
                          onClick={() => setShowChildrenManager(true)}
                          className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
                        >
                          <i data-lucide="users" className="w-4 h-4"></i>
                          ç®¡ç†å­©å­
                      </button>
                        {currentChild && (
                          <button
                            onClick={() => handleFeatureClick('reports')}
                            className="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
                          >
                            <i data-lucide="bar-chart-3" className="w-4 h-4"></i>
                            ç»Ÿè®¡æŠ¥å‘Š
                          </button>
                        )}
                        {children.length < 3 && (
                          <button
                            onClick={() => {
                              setNewChild({ name: '', birth_year: new Date().getFullYear() - 5, avatar: 'ğŸ˜Š' });
                              setShowChildrenManager(true);
                            }}
                            className="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
                          >
                            <i data-lucide="plus" className="w-4 h-4"></i>
                            æ·»åŠ å­©å­
                          </button>
                        )}
                      </div>
                    </div>
                    </div>
                  )}

                {/* å­©å­ç®¡ç†ç•Œé¢ */}
                {currentUser && showChildrenManager && (
                  <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-200">
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="users" className="w-6 h-6 text-blue-500"></i>
                        å­©å­ç®¡ç†
                      </h3>
                      {children.length > 0 && (
                        <button
                          onClick={() => setShowChildrenManager(false)}
                          className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors"
                        >
                          è¿”å›
                        </button>
                      )}
                    </div>

                    {/* æ·»åŠ æ–°å­©å­è¡¨å• */}
                    {children.length < 3 && (
                      <div className="bg-blue-50 rounded-lg p-4 mb-6">
                        <h4 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                          <i data-lucide="plus-circle" className="w-5 h-5 text-green-500"></i>
                          æ·»åŠ æ–°å­©å­ ({children.length}/3)
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å¤´åƒ</label>
                            <select
                              value={newChild.avatar}
                              onChange={(e) => setNewChild({ ...newChild, avatar: e.target.value })}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 text-lg"
                            >
                              {['ğŸ˜Š', 'ğŸ˜ƒ', 'ğŸ¤—', 'ğŸ˜', 'ğŸ¥°', 'ğŸ¤©', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ˜‹', 'ğŸ¤“'].map(emoji => (
                                <option key={emoji} value={emoji}>{emoji}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
                    <input
                      type="text"
                              value={newChild.name}
                              onChange={(e) => setNewChild({ ...newChild, name: e.target.value })}
                              placeholder="å­©å­çš„å§“å"
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                    />
                  </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å‡ºç”Ÿå¹´ä»½</label>
                            <select
                              value={newChild.birth_year}
                              onChange={(e) => setNewChild({ ...newChild, birth_year: parseInt(e.target.value) })}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2"
                            >
                              {Array.from({ length: 18 }, (_, i) => new Date().getFullYear() - i - 2).map(year => (
                                <option key={year} value={year}>{year} ({new Date().getFullYear() - year}å²)</option>
                              ))}
                            </select>
                          </div>
                          <div className="flex items-end">
                            <button
                              onClick={addChild}
                              disabled={!newChild.name.trim()}
                              className="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                            >
                              æ·»åŠ 
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* ç°æœ‰å­©å­åˆ—è¡¨ */}
                    {children.length > 0 && (
                      <div>
                        <h4 className="font-semibold text-gray-800 mb-4">ç°æœ‰å­©å­</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {children.map(child => (
                            <div key={child.id} className="border border-gray-200 rounded-lg p-4 bg-gray-50">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  <span className="text-2xl">{child.avatar}</span>
                                  <div>
                                    <h5 className="font-semibold text-gray-800">{child.name}</h5>
                                    <p className="text-sm text-gray-600">{new Date().getFullYear() - child.birth_year}å²</p>
                                  </div>
                                </div>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => {
                                      setCurrentChild(child);
                                      setShowChildrenManager(false);
                                    }}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
                                  >
                                    æŸ¥çœ‹
                                  </button>
                                  <button
                                    onClick={() => deleteChild(child.id)}
                                    className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs"
                                  >
                                    åˆ é™¤
                                  </button>
                                </div>
                              </div>
                              <div className="text-xs text-gray-500">
                                åˆ›å»ºæ—¶é—´: {new Date(child.created_at).toLocaleDateString()}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {children.length === 0 && (
                      <div className="text-center py-8">
                        <div className="text-6xl mb-4">ğŸ‘¶</div>
                        <h4 className="text-lg font-semibold text-gray-700 mb-2">è¿˜æ²¡æœ‰æ·»åŠ å­©å­</h4>
                        <p className="text-gray-500">è¯·å…ˆæ·»åŠ ä¸€ä¸ªå­©å­æ¥å¼€å§‹ä½¿ç”¨ç³»ç»Ÿ</p>
                      </div>
                    )}
                  </div>
                )}

                {/* ç™»å½•åçš„æ§åˆ¶é¢æ¿ */}
                {currentUser && currentChild && !showChildrenManager && (
                  <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-200">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div className="flex items-center gap-3">
                        <span className="font-medium text-gray-700 text-sm sm:text-base">å½“å‰æŸ¥çœ‹:</span>
                        <div className="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg">
                          <span className="text-xl">{currentChild.avatar}</span>
                          <span className="font-semibold text-gray-800">{currentChild.name}</span>
                          <span className="text-sm text-gray-600">({new Date().getFullYear() - currentChild.birth_year}å²)</span>
                        </div>
                      </div>
                      
                      <div className="flex items-center gap-3">
                        <span className="font-medium text-gray-700 text-sm sm:text-base">è¡¥å½•æ—¥æœŸ:</span>
                    <select
                      value={getLocalDateStr(selectedDate)}
                      onChange={e => {
                        const [y, m, d] = e.target.value.split('-');
                        setSelectedDate(new Date(Number(y), Number(m)-1, Number(d)));
                      }}
                          className="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 flex-1"
                    >
                      {[0,1,2].map(offset => {
                        const d = new Date();
                        d.setDate(d.getDate() - offset);
                        const val = getLocalDateStr(d);
                            const label = offset === 0 ? 'ä»Šå¤©' : offset === 1 ? 'æ˜¨å¤©' : 'å‰å¤©';
                            return <option key={val} value={val}>{label} ({val})</option>;
                      })}
                    </select>
                      </div>
                  </div>
                  
                    <div className="flex justify-center gap-3 mb-4">
                    <button
                      onClick={() => {setSelectedDate(new Date()); setViewMode('today');}}
                        className={`px-4 py-2.5 rounded-lg font-medium text-sm flex items-center gap-2 transition-all
                          ${ viewMode === 'today' && selectedDate.toDateString() === new Date().toDateString() ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }`}
                    >
                        <i data-lucide="clock" className="w-4 h-4"></i>
                        ä»Šæ—¥ä»»åŠ¡
                    </button>
                    <button
                      onClick={() => {
                        setViewMode('history');
                        setTimeout(() => {
                          document.getElementById('history-view')?.scrollIntoView({ behavior: 'smooth' });
                        }, 100);
                      }}
                        className={`px-4 py-2.5 rounded-lg font-medium text-sm flex items-center gap-2 transition-all
                          ${ viewMode === 'history' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }`}
                    >
                        <i data-lucide="calendar-days" className="w-4 h-4"></i>
                        å†å²è®°å½•
                    </button>
                  </div>

                  {viewMode === 'today' && selectedDate.toDateString() !== new Date().toDateString() && (
                      <div className="text-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                      <p className="text-sm text-yellow-800">
                          <i data-lucide="alert-circle" className="w-4 h-4 inline mr-2"></i>
                          æ­£åœ¨æŸ¥çœ‹: <span className="font-semibold">{selectedDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}</span>
                          <button onClick={() => setSelectedDate(new Date())} className="ml-3 text-blue-600 hover:underline font-medium">
                            è¿”å›ä»Šæ—¥
                          </button>
                        </p>
                      </div>
                    )}
                    </div>
                  )}
                  
                {/* ä¸»å†…å®¹åŒºåŸŸ - ç¡®ä¿æ­£ç¡®çš„æ¸²æŸ“é¡ºåº */}
                <div className="content-area">
                  {/* ç»Ÿè®¡å¡ç‰‡ - åªåœ¨ç™»å½•åæ˜¾ç¤º */}
                  {currentUser && (
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-blue-50 rounded-lg p-6 shadow-sm border border-blue-200 flex flex-col items-center">
                        <i data-lucide="trophy" className="w-9 h-9 text-blue-500 mb-2"></i>
                        <div className="text-gray-600 text-base font-medium mb-1">æ€»ç§¯åˆ† Total</div>
                        <div className="text-3xl font-bold text-blue-600">{totalPoints}</div>
                      </div>
                      <div className="bg-green-50 rounded-lg p-6 shadow-sm border border-green-200 flex flex-col items-center">
                        <i data-lucide="star" className="w-9 h-9 text-green-500 mb-2"></i>
                          <div className="text-gray-600 text-base font-medium mb-1">ä»Šæ—¥å¾—åˆ† Today's Points</div>
                        <div className="text-3xl font-bold text-green-600">{earnedTodayOrSelectedDay}</div>
                      </div>
                      <div className="bg-purple-50 rounded-lg p-6 shadow-sm border border-purple-200 flex flex-col items-center">
                        <i data-lucide="bar-chart-big" className="w-9 h-9 text-purple-500 mb-2"></i>
                          <div className="text-gray-600 text-base font-medium mb-1">ä»Šæ—¥å®Œæˆç‡ Completion Rate</div>
                        <div className="text-3xl font-bold text-purple-600">{completionRateForSelectedDay}%</div>
                      </div>
                    </div>
                  </div>
                  )}

                  {/* æ¬¢è¿é¡µé¢ - æ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½å¡ç‰‡ */}
                  {!currentUser && (
                    <div className="relative">
                      {/* å¤§å¤§çš„æ¬¢è¿æç¤º - æ‰‹æœºé€‚é… */}
                      <div className="text-center mb-6 sm:mb-8 px-4 sm:px-0">
                        <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 animate-bounce">ğŸ¯</div>
                        <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
                          é€‰æ‹©ä½ çš„å†’é™©æ¨¡å¼ï¼
                        </h2>
                        <p className="text-base sm:text-lg text-gray-600">
                          Choose your adventure mode!
                        </p>
                      </div>
                        
                      {/* è¶…çº§ç‚«é…·çš„åŠŸèƒ½å¡ç‰‡ - å®Œå…¨å“åº”å¼è®¾è®¡ */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-8 px-2 sm:px-0">
                        <button 
                          onClick={() => handleFeatureClick('tasks')}
                          className="group bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:rotate-1 shadow-xl sm:shadow-2xl hover:shadow-green-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-spin">ğŸ“‹</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">æ¯æ—¥ä»»åŠ¡</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">Daily Tasks</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">å®Œæˆä»»åŠ¡èµšç§¯åˆ† ğŸ’°<br/>Complete tasks & earn points</p>
                        </button>
                        
                        <button 
                          onClick={() => handleFeatureClick('tracking')}
                          className="group bg-gradient-to-br from-blue-400 to-sky-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:-rotate-1 shadow-xl sm:shadow-2xl hover:shadow-blue-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-pulse">ğŸ“Š</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">ç§¯åˆ†æŸ¥çœ‹</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">Points Tracking</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">çœ‹çœ‹ä½ æœ‰å¤šæ£’ ğŸ…<br/>See how awesome you are</p>
                        </button>
                        
                        <button 
                          onClick={() => handleFeatureClick('rewards')}
                          className="group bg-gradient-to-br from-pink-400 to-rose-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:rotate-1 shadow-xl sm:shadow-2xl hover:shadow-pink-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-bounce">ğŸ</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">å¥–åŠ±å•†åº—</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">Reward Shop</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">ç”¨ç§¯åˆ†ä¹°å¥½ä¸œè¥¿ ğŸ›ï¸<br/>Buy cool stuff with points</p>
                        </button>
                        
                        <button 
                          onClick={() => handleFeatureClick('history')}
                          className="group bg-gradient-to-br from-purple-400 to-violet-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:-rotate-1 shadow-xl sm:shadow-2xl hover:shadow-purple-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-pulse">ğŸ“ˆ</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">æˆé•¿è®°å½•</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">History</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">çœ‹çœ‹ä½ çš„è¿›æ­¥ ğŸ“š<br/>Track your progress</p>
                        </button>
                      </div>
                      
                      {/* åº•éƒ¨æ¿€åŠ±æ–‡å­— - æ‰‹æœºé€‚é… */}
                      <div className="text-center px-4 sm:px-0">
                        <div className="flex justify-center items-center space-x-3 sm:space-x-4 text-3xl sm:text-4xl mb-3 sm:mb-4">
                          <span className="animate-bounce" style={{animationDelay: '0s'}}>ğŸŒŸ</span>
                          <span className="animate-bounce" style={{animationDelay: '0.2s'}}>ğŸš€</span>
                          <span className="animate-bounce" style={{animationDelay: '0.4s'}}>ğŸ†</span>
                          <span className="animate-bounce" style={{animationDelay: '0.6s'}}>ğŸ‰</span>
                        </div>
                        <p className="text-lg sm:text-xl font-bold text-gray-700">
                          æˆä¸ºæœ€æ£’çš„å°å†’é™©å®¶ï¼
                        </p>
                        <p className="text-sm sm:text-base text-gray-600">
                          Become the best little explorer!
                        </p>
                      </div>
                    </div>
                  )}

                  {/* å†å²è®°å½•è§†å›¾ */}
                  {currentUser && viewMode === 'history' && (
                  <div id="history-view">
                    <HistoryView />
                  </div>
                )}

                  {/* ä»Šæ—¥ä»»åŠ¡è§†å›¾ */}
                  {currentUser && viewMode === 'today' && (
                  <Fragment> {/* Use Fragment if no parent div is needed */}
                    <div className="mb-6 text-center">
                      <button
                        onClick={() => setShowAddTask(!showAddTask)}
                        className="bg-green-500 text-white px-5 py-2.5 rounded-lg hover:bg-green-600 transition-transform hover:scale-105 duration-150 flex items-center mx-auto shadow-md"
                      >
                        <i data-lucide={showAddTask ? "minus" : "plus"} className="w-5 h-5 mr-2"></i>
                        {showAddTask ? 'æ”¶èµ·è¡¨å• Hide Form' : 'æ·»åŠ æ–°ä»»åŠ¡ Add New Task'}
                      </button>
                    </div>

                    {showAddTask && (
                      <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
                        <h3 className="text-xl font-semibold mb-5 text-gray-700">
                            <i data-lucide="list-plus" className="w-6 h-6 inline mr-2 align-text-bottom"></i>
                            æ·»åŠ è‡ªå®šä¹‰ä»»åŠ¡/æ‰£åˆ†é¡¹
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                          <input
                            type="text"
                            placeholder="ä¸­æ–‡åç§° Chinese Name"
                            value={newTask.name}
                            onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          />
                          <input
                            type="text"
                            placeholder="è‹±æ–‡åç§° English Name"
                            value={newTask.nameEn}
                            onChange={(e) => setNewTask({ ...newTask, nameEn: e.target.value })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          />
                          <select
                            value={newTask.type}
                            onChange={e => setNewTask({ ...newTask, type: e.target.value })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          >
                            <option value="daily">æ¯æ—¥ä»»åŠ¡ Daily Task</option>
                            <option value="behavior">è¡Œä¸ºä¹ æƒ¯ Behavior</option>
                            <option value="penalties">æ‰£åˆ†é¡¹ Penalty</option>
                          </select>
                          <input
                            type="number"
                            placeholder="ç§¯åˆ† Points (æ‰£åˆ†å¡«æ­£æ•°)"
                            value={newTask.points}
                            onChange={(e) => setNewTask({ ...newTask, points: parseInt(e.target.value) || 0 })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          />
                          <div className="md:col-span-2">
                            <p className="text-sm text-gray-600 mb-2">é€‰æ‹©å›¾æ ‡ Choose Icon:</p>
                            <div className="flex flex-wrap gap-2 bg-gray-50 p-3 rounded-lg border">
                              {emojiOptions.map(emoji => (
                                <button
                                  key={emoji}
                                  onClick={() => setNewTask({ ...newTask, icon: emoji })}
                                  className={`text-2xl p-2 rounded-md transition-all ${newTask.icon === emoji ? 'bg-blue-500 text-white scale-110 ring-2 ring-blue-300' : 'hover:bg-gray-200 bg-white'}`}
                                >
                                  {emoji}
                                </button>
                              ))}
                            </div>
                          </div>
                          <div className="md:col-span-2 flex gap-3 mt-2">
                            <button
                              onClick={() => addTask(newTask)}
                              className="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600 transition flex items-center"
                            >
                              <i data-lucide="check" className="w-5 h-5 mr-1.5"></i> æ·»åŠ  Add
                            </button>
                            <button
                              onClick={() => setShowAddTask(false)}
                              className="bg-gray-300 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-400 transition"
                            >
                              å–æ¶ˆ Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-xl font-bold mb-5 text-gray-700 flex items-center">
                            <i data-lucide="clipboard-list" className="w-6 h-6 mr-2 text-sky-500"></i>
                            æ¯æ—¥ä»»åŠ¡ Daily Tasks
                            <button
                              onClick={async () => {
                                if (window.confirm('ç¡®å®šè¦æ¸…ç©ºå½“å¤©æ‰€æœ‰å¾—åˆ†/æ‰£åˆ†å—ï¼Ÿ\nAre you sure to clear all today\'s records?')) {
                                  const dateStr = getLocalDateStr(selectedDate);
                                  // ç”¨ Supabase åˆ é™¤è¯¥å­©å­è¯¥å¤©çš„è®°å½•
                                  if (currentChild?.id) {
                                  await supabase
                                    .from('history')
                                    .delete()
                                      .eq('child_id', currentChild.id)
                                    .eq('date', dateStr);
                                    // åˆ·æ–°å½“å‰å­©å­çš„ history
                                  const { data } = await supabase
                                    .from('history')
                                    .select('*')
                                      .eq('child_id', currentChild.id);
                                  setHistory(data || []);
                                  }
                                }
                              }}
                              className="ml-3 px-3 py-1.5 rounded-lg bg-red-500 text-white text-xs sm:text-sm font-medium hover:bg-red-600 transition-all flex items-center"
                              title="æ¸…ç©ºå½“å¤© Clear Today"
                            >
                              <i data-lucide='trash-2' className='w-4 h-4 mr-1'></i>
                              æ¸…ç©ºå½“å¤©
                            </button>
                        </h2>
                        <div className="space-y-3.5">
                          {tasks
                            .filter(task => task.type === 'daily')
                            .sort((a, b) => {
                              // é¢„è®¾ä»»åŠ¡ vs è‡ªå®šä¹‰ä»»åŠ¡çš„åˆ¤æ–­
                              const aIsPreset = DEFAULT_TASKS.some(defaultTask => defaultTask.name === a.name);
                              const bIsPreset = DEFAULT_TASKS.some(defaultTask => defaultTask.name === b.name);
                              
                              // é¢„è®¾ä»»åŠ¡æ’åœ¨å‰é¢
                              if (aIsPreset && !bIsPreset) return -1;
                              if (!aIsPreset && bIsPreset) return 1;
                              
                              // åŒç±»å‹å†…æŒ‰åç§°æ’åº
                              return a.name.localeCompare(b.name);
                            })
                            .map(task => (
                            <TaskCard key={task.id} task={task} category="daily" />
                          ))}
                        </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-xl font-bold mb-5 text-gray-700 flex items-center">
                            <i data-lucide="thumbs-up" className="w-6 h-6 mr-2 text-teal-500"></i>
                            è¡Œä¸ºä¹ æƒ¯ Good Habits
                        </h2>
                        <div className="space-y-3.5">
                          {tasks
                            .filter(task => task.type === 'behavior')
                            .sort((a, b) => {
                              // é¢„è®¾ä»»åŠ¡ vs è‡ªå®šä¹‰ä»»åŠ¡çš„åˆ¤æ–­
                              const aIsPreset = DEFAULT_TASKS.some(defaultTask => defaultTask.name === a.name);
                              const bIsPreset = DEFAULT_TASKS.some(defaultTask => defaultTask.name === b.name);
                              
                              // é¢„è®¾ä»»åŠ¡æ’åœ¨å‰é¢
                              if (aIsPreset && !bIsPreset) return -1;
                              if (!aIsPreset && bIsPreset) return 1;
                              
                              // åŒç±»å‹å†…æŒ‰åç§°æ’åº
                              return a.name.localeCompare(b.name);
                            })
                            .map(task => (
                            <TaskCard key={task.id} task={task} category="behavior" />
                          ))}
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-lg p-6 mt-6 border-2 border-red-200/70">
                      <h2 className="text-xl font-bold mb-5 text-red-600 flex items-center">
                        <i data-lucide="alert-triangle" className="w-6 h-6 mr-2"></i>
                        æ‰£åˆ†é¡¹ç›® Penalty Items
                      </h2>
                      <div className="grid md:grid-cols-2 gap-3.5">
                        {tasks
                          .filter(task => task.type === 'penalties')
                          .sort((a, b) => {
                            // é¢„è®¾ä»»åŠ¡ vs è‡ªå®šä¹‰ä»»åŠ¡çš„åˆ¤æ–­
                            const aIsPreset = DEFAULT_TASKS.some(defaultTask => defaultTask.name === a.name);
                            const bIsPreset = DEFAULT_TASKS.some(defaultTask => defaultTask.name === b.name);
                            
                            // é¢„è®¾ä»»åŠ¡æ’åœ¨å‰é¢
                            if (aIsPreset && !bIsPreset) return -1;
                            if (!aIsPreset && bIsPreset) return 1;
                            
                            // åŒç±»å‹å†…æŒ‰åç§°æ’åº
                            return a.name.localeCompare(b.name);
                          })
                          .map(task => (
                          <TaskCard key={task.id} task={task} category="penalties" />
                        ))}
                      </div>
                    </div>
                    
                    {/* è¡¥å½•å†å²æŒ‰é’® - ç§»åŠ¨åˆ°è¿™é‡Œ */}
                    {pendingHistory !== null && (
                      <div className="flex justify-center mt-6 mb-6">
                        <button
                          onClick={submitPendingHistory}
                          className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-lg transition-all transform hover:scale-105"
                        >
                          <i data-lucide="upload" className="w-5 h-5 mr-2 inline"></i>
                          æäº¤è¡¥å½• Make-up Submit
                        </button>
                      </div>
                    )}
                    
                    <div className="bg-white rounded-xl shadow-lg p-6 mt-8">
                      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 gap-3">
                        <h2 className="text-2xl font-bold flex items-center text-gray-700">
                          <i data-lucide="gift" className="w-7 h-7 mr-2.5 text-pink-500"></i>
                          <div className="flex flex-col leading-tight">
                            <span>å¥–åŠ±å•†åº—</span>
                            <span className="text-lg text-gray-600">Reward Shop</span>
                          </div>
                        </h2>
                        <button
                          onClick={() => setShowAddReward(!showAddReward)}
                          className="bg-pink-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-pink-600 text-xs sm:text-sm transition-all flex items-center justify-center min-w-0 shrink-0"
                        >
                          <i data-lucide="plus" className="w-4 h-4 mr-1 sm:mr-2"></i>
                          <span className="hidden sm:inline">{showAddReward ? 'éšè— Hide' : 'æ·»åŠ å¥–åŠ± Add Reward'}</span>
                          <span className="sm:hidden">{showAddReward ? 'éšè—' : 'æ·»åŠ '}</span>
                        </button>
                      </div>
                      
                      {showAddReward && (
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
                          <h3 className="text-xl font-semibold mb-5 text-gray-700">
                            <i data-lucide="gift" className="w-6 h-6 inline mr-2 align-text-bottom"></i>
                            æ·»åŠ æ–°å¥–åŠ± Add New Reward
                          </h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <input
                              type="text"
                              placeholder="ä¸­æ–‡åç§° Chinese Name"
                              value={newReward.name}
                              onChange={(e) => setNewReward({ ...newReward, name: e.target.value })}
                              className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            />
                            <input
                              type="text"
                              placeholder="è‹±æ–‡åç§° English Name"
                              value={newReward.nameEn}
                              onChange={(e) => setNewReward({ ...newReward, nameEn: e.target.value })}
                              className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            />
                            <input
                              type="number"
                              placeholder="æ‰€éœ€ç§¯åˆ† Points Required"
                              value={newReward.cost}
                              onChange={(e) => setNewReward({ ...newReward, cost: parseInt(e.target.value) || 0 })}
                              className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            />
                            <div className="md:col-span-2 flex gap-3 mt-2">
                              <button
                                onClick={() => addReward(newReward)}
                                className="bg-pink-500 text-white px-5 py-2 rounded-lg hover:bg-pink-600 transition flex items-center"
                              >
                                <i data-lucide="check" className="w-5 h-5 mr-1.5"></i> æ·»åŠ  Add
                              </button>
                              <button
                                onClick={() => setShowAddReward(false)}
                                className="bg-gray-300 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-400 transition"
                              >
                                å–æ¶ˆ Cancel
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-5 mt-6 pt-4 border-t">
                        {rewards.map(reward => (
                          <RewardCard key={reward.id} reward={reward} />
                        ))}
                      </div>
                    </div>
                  </Fragment>
                )}



                  {/* é¡µè„š */}
                  <footer className="text-center text-xs text-gray-500 py-8 mt-8">
                     Kids' Mission System &copy; {new Date().getFullYear()}
                  </footer>
                </div> {/* å…³é—­ content-area */}
              </div> {/* å…³é—­ main-container */}

              {/* ç»Ÿè®¡æŠ¥å‘Šé¡µé¢ */}
              {showReportsPage && currentChild && (
                <div className="fixed inset-0 bg-white z-40 overflow-auto">
                  <div className="min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 p-4">
                    <div className="max-w-6xl mx-auto">
                      {/* æŠ¥å‘Šé¡µé¢å¤´éƒ¨ */}
                      <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                        <div className="flex items-center justify-between mb-6">
                          <div className="flex items-center gap-3">
                            <div className="bg-purple-100 p-3 rounded-full">
                              <i data-lucide="bar-chart-3" className="w-8 h-8 text-purple-600"></i>
                            </div>
                            <div>
                              <h1 className="text-2xl font-bold text-gray-800">
                                {currentChild.avatar} {currentChild.name} çš„ç»Ÿè®¡æŠ¥å‘Š
                              </h1>
                              <p className="text-gray-600">Data Analytics & Export Dashboard</p>
                            </div>
                          </div>
                     <button
                            onClick={() => {
                              console.log('å…³é—­ç»Ÿè®¡æŠ¥å‘Šé¡µé¢');
                              setShowReportsPage(false);
                              setReportData(null);
                              setIsLoadingReport(false); // é‡ç½®åŠ è½½çŠ¶æ€
                              setReportPeriod('week'); // æ¢å¤é»˜è®¤
                              setCustomStartDate(''); // æ¸…ç©ºè‡ªå®šä¹‰æ—¥æœŸ
                              setCustomEndDate(''); // æ¸…ç©ºè‡ªå®šä¹‰æ—¥æœŸ
                            }}
                            className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                          >
                            <i data-lucide="x" className="w-4 h-4"></i>
                            è¿”å›
                          </button>
                        </div>

                        {/* æ—¶é—´æ®µé€‰æ‹©å’Œå¯¼å‡ºæŒ‰é’® */}
                        <div className="flex flex-wrap items-center justify-between gap-4">
                          <div className="flex flex-wrap items-center gap-3">
                            <label className="font-medium text-gray-700">æŠ¥å‘Šæ—¶é—´æ®µ:</label>
                            <select
                              value={reportPeriod}
                              onChange={(e) => {
                                console.log('åˆ‡æ¢æŠ¥å‘Šæ—¶é—´æ®µ:', e.target.value);
                                const newPeriod = e.target.value;
                                setReportPeriod(newPeriod);
                                setReportData(null); // æ¸…ç©ºå½“å‰æ•°æ®
                                setIsLoadingReport(false); // é‡ç½®åŠ è½½çŠ¶æ€
                                
                                // å¦‚æœä¸æ˜¯è‡ªå®šä¹‰æ¨¡å¼ï¼Œç«‹å³ç”ŸæˆæŠ¥å‘Š
                                if (newPeriod !== 'custom') {
                                  setTimeout(() => {
                                    if (currentChild) {
                                      generateReportData(currentChild.id, newPeriod).then(data => {
                                        if (data) {
                                          setReportData(data);
                                        }
                                      }).catch(error => {
                                        console.error('åˆ‡æ¢æ—¶é—´æ®µæ—¶å‡ºé”™:', error);
                                        setIsLoadingReport(false);
                                        setReportData(null);
                                      });
                                    }
                                  }, 100);
                                }
                              }}
                              className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400"
                            >
                              <option value="week">æœ€è¿‘ä¸€å‘¨</option>
                              <option value="month">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
                              <option value="quarter">æœ€è¿‘ä¸‰ä¸ªæœˆ</option>
                              <option value="year">æœ€è¿‘ä¸€å¹´</option>
                              <option value="custom">è‡ªå®šä¹‰æ—¶é—´æ®µ</option>
                            </select>
                            
                            {/* è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨ */}
                            {reportPeriod === 'custom' && (
                              <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border">
                                <div className="flex items-center gap-1">
                                  <label className="text-sm text-gray-600">ä»:</label>
                                  <input
                                    type="date"
                                    value={customStartDate}
                                    onChange={(e) => setCustomStartDate(e.target.value)}
                                    max={customEndDate || new Date().toISOString().split('T')[0]}
                                    className="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-purple-400"
                                  />
                                </div>
                                <div className="flex items-center gap-1">
                                  <label className="text-sm text-gray-600">åˆ°:</label>
                                  <input
                                    type="date"
                                    value={customEndDate}
                                    onChange={(e) => setCustomEndDate(e.target.value)}
                                    min={customStartDate}
                                    max={new Date().toISOString().split('T')[0]}
                                    className="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-purple-400"
                                  />
                                </div>
                                <button
                                  onClick={() => {
                                    if (customStartDate && customEndDate && currentChild) {
                                      generateReportData(currentChild.id, 'custom').then(data => {
                                        if (data) {
                                          setReportData(data);
                                        }
                                      }).catch(error => {
                                        console.error('ç”Ÿæˆè‡ªå®šä¹‰æŠ¥å‘Šæ—¶å‡ºé”™:', error);
                                        setIsLoadingReport(false);
                                        setReportData(null);
                                      });
                                    } else {
                                      alert('è¯·é€‰æ‹©å®Œæ•´çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                                    }
                                  }}
                                  disabled={!customStartDate || !customEndDate}
                                  className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                                    customStartDate && customEndDate 
                                    ? 'bg-purple-500 text-white hover:bg-purple-600' 
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                  }`}
                                >
                                  ç”ŸæˆæŠ¥å‘Š
                     </button>
                   </div>
                 )}
                          </div>
                          
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => exportToExcel(currentChild.id, reportPeriod)}
                              className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                            >
                              <i data-lucide="file-spreadsheet" className="w-4 h-4"></i>
                              å¯¼å‡ºå®Œæ•´æŠ¥å‘Š (Excel)
                            </button>
                          </div>
                        </div>
                      </div>

                      {/* åŠ è½½çŠ¶æ€ */}
                      {isLoadingReport && (
                        <div className="bg-white rounded-xl shadow-sm p-8 text-center">
                          <div className="animate-spin w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full mx-auto mb-4"></div>
                          <p className="text-gray-600">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</p>
                        </div>
                      )}

                      {/* ç»Ÿè®¡æ¦‚è¦ */}
                      {reportData && !isLoadingReport && (
                        <>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            {/* æ€»ä»»åŠ¡å®Œæˆæ•° */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 text-center">
                              <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="check-circle" className="w-8 h-8 text-blue-600"></i>
                              </div>
                              <h3 className="text-2xl font-bold text-gray-800 mb-1">{reportData.summary.totalTasks}</h3>
                              <p className="text-gray-600 text-sm">ä»»åŠ¡æ“ä½œæ€»æ¬¡æ•°</p>
                              <div className="text-xs text-gray-500 mt-1">
                                æ­£å‘å®Œæˆ {reportData.summary.completedTasks} æ¬¡
                              </div>
                            </div>

                            {/* å‡€ç§¯åˆ† */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 text-center">
                              <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="trending-up" className="w-8 h-8 text-green-600"></i>
                              </div>
                              <h3 className="text-2xl font-bold text-gray-800 mb-1">{reportData.summary.netPoints}</h3>
                              <p className="text-gray-600 text-sm">å‡€ç§¯åˆ†</p>
                              <div className="text-xs text-gray-500 mt-1">
                                è·å¾— {reportData.summary.totalPointsEarned} - æ‰£é™¤ {reportData.summary.totalPointsLost}
                              </div>
                            </div>

                            {/* å®Œæˆç‡ */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 text-center">
                              <div className="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="target" className="w-8 h-8 text-purple-600"></i>
                              </div>
                              <h3 className="text-2xl font-bold text-gray-800 mb-1">
                                {reportData.summary.totalTasks > 0 ? Math.round((reportData.summary.completedTasks / reportData.summary.totalTasks) * 100) : 0}%
                              </h3>
                              <p className="text-gray-600 text-sm">æ­£å‘å®Œæˆç‡</p>
                              <div className="text-xs text-gray-500 mt-1">
                                {reportData.summary.completedTasks}/{reportData.summary.totalTasks} æ¬¡æ­£å‘å®Œæˆ
                              </div>
                            </div>

                            {/* å¥–åŠ±å…‘æ¢æ•° */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 text-center">
                              <div className="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="gift" className="w-8 h-8 text-yellow-600"></i>
                              </div>
                              <h3 className="text-2xl font-bold text-gray-800 mb-1">{reportData.summary.totalRewardsClaimed}</h3>
                              <p className="text-gray-600 text-sm">å…‘æ¢å¥–åŠ±æ¬¡æ•°</p>
                              <div className="text-xs text-gray-500 mt-1">
                                {reportData.categoryBreakdown.redeem.points} ç§¯åˆ†å·²å…‘æ¢
                              </div>
                            </div>
                          </div>

                          {/* å›¾è¡¨åŒºåŸŸ */}
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            {/* æ¯æ—¥ç§¯åˆ†è¶‹åŠ¿å›¾ */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="line-chart" className="w-5 h-5 text-blue-600"></i>
                                æ¯æ—¥ç§¯åˆ†è¶‹åŠ¿
                              </h3>
                              <div className="h-64">
                                <canvas 
                                  id="dailyPointsChart" 
                                  className="w-full h-full"
                                  ref={(canvas) => {
                                    if (canvas && reportData.trends.dailyPoints.length > 0) {
                                      // é”€æ¯ç°æœ‰å›¾è¡¨
                                      const existingChart = Chart.getChart(canvas);
                                      if (existingChart) {
                                        existingChart.destroy();
                                      }
                                      
                                      // åˆ›å»ºæ–°å›¾è¡¨
                                      new Chart(canvas, {
                                        type: 'line',
                                        data: {
                                          labels: reportData.trends.dailyPoints.map(d => d.date),
                                          datasets: [{
                                            label: 'æ¯æ—¥ç§¯åˆ†',
                                            data: reportData.trends.dailyPoints.map(d => d.points),
                                            borderColor: 'rgb(59, 130, 246)',
                                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                            tension: 0.4,
                                            fill: true
                                          }]
                                        },
                                        options: {
                                          responsive: true,
                                          maintainAspectRatio: false,
                                          plugins: {
                                            legend: {
                                              display: false
                                            }
                                          },
                                          scales: {
                                            y: {
                                              beginAtZero: true
                                            }
                                          }
                                        }
                                      });
                                    }
                                  }}
                                ></canvas>
                              </div>
                            </div>

                            {/* åˆ†ç±»ç»Ÿè®¡é¥¼å›¾ */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="pie-chart" className="w-5 h-5 text-purple-600"></i>
                                ä»»åŠ¡åˆ†ç±»åˆ†å¸ƒ
                              </h3>
                              <div className="h-64">
                                <canvas 
                                  id="categoryChart"
                                  className="w-full h-full"
                                  ref={(canvas) => {
                                    if (canvas && reportData.categoryBreakdown) {
                                      // é”€æ¯ç°æœ‰å›¾è¡¨
                                      const existingChart = Chart.getChart(canvas);
                                      if (existingChart) {
                                        existingChart.destroy();
                                      }
                                      
                                      const categories = Object.entries(reportData.categoryBreakdown)
                                        .filter(([key, data]) => data.count > 0 && key !== 'redeem');
                                      
                                      if (categories.length > 0) {
                                        // åˆ›å»ºæ–°å›¾è¡¨
                                        new Chart(canvas, {
                                          type: 'doughnut',
                                          data: {
                                            labels: categories.map(([key]) => ({
                                              daily: 'æ¯æ—¥ä»»åŠ¡',
                                              behavior: 'è¡Œä¸ºä¹ æƒ¯',
                                              penalties: 'æ‰£åˆ†é¡¹'
                                            }[key] || key)),
                                            datasets: [{
                                              data: categories.map(([, data]) => data.count),
                                              backgroundColor: [
                                                'rgba(59, 130, 246, 0.8)',
                                                'rgba(16, 185, 129, 0.8)',
                                                'rgba(239, 68, 68, 0.8)',
                                                'rgba(245, 158, 11, 0.8)'
                                              ]
                                            }]
                                          },
                                          options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                              legend: {
                                                position: 'bottom'
                                              }
                                            }
                                          }
                                        });
                                      }
                                    }
                                  }}
                                ></canvas>
                              </div>
                            </div>
                          </div>

                          {/* è¯¦ç»†åˆ†ç±»ç»Ÿè®¡ */}
                          <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-6">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                              <i data-lucide="clipboard-list" className="w-5 h-5 text-green-600"></i>
                              åˆ†ç±»è¯¦ç»†ç»Ÿè®¡
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                              {Object.entries(reportData.categoryBreakdown).map(([category, stats]) => {
                                const categoryInfo = {
                                  daily: { name: 'æ¯æ—¥ä»»åŠ¡', icon: 'ğŸ“š', color: 'blue' },
                                  behavior: { name: 'è¡Œä¸ºä¹ æƒ¯', icon: 'â­', color: 'green' },
                                  penalties: { name: 'æ‰£åˆ†é¡¹', icon: 'âš ï¸', color: 'red' },
                                  redeem: { name: 'å¥–åŠ±å…‘æ¢', icon: 'ğŸ', color: 'purple' }
                                }[category] || { name: category, icon: 'ğŸ“‹', color: 'gray' };
                                
                                                                 return (
                                   <div key={category} className={`rounded-lg p-4 ${
                                     categoryInfo.color === 'blue' ? 'bg-blue-50 border border-blue-200' :
                                     categoryInfo.color === 'green' ? 'bg-green-50 border border-green-200' :
                                     categoryInfo.color === 'red' ? 'bg-red-50 border border-red-200' :
                                     categoryInfo.color === 'purple' ? 'bg-purple-50 border border-purple-200' :
                                     'bg-gray-50 border border-gray-200'
                                   }`}>
                                     <div className="flex items-center gap-2 mb-2">
                                       <span className="text-xl">{categoryInfo.icon}</span>
                                       <span className="font-semibold text-gray-800">{categoryInfo.name}</span>
                                     </div>
                                     <div className="space-y-1 text-sm">
                                       <div className="flex justify-between">
                                         <span className="text-gray-600">æ¬¡æ•°:</span>
                                         <span className="font-medium">{stats.count}</span>
                                       </div>
                                       <div className="flex justify-between">
                                         <span className="text-gray-600">ç§¯åˆ†:</span>
                                         <span className={`font-medium ${stats.points >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                           {stats.points >= 0 ? '+' : ''}{stats.points}
                                         </span>
                                       </div>
              </div>
                                   </div>
                                 );
                              })}
                            </div>
                          </div>

                          {/* è¯¦ç»†ä»»åŠ¡ç»Ÿè®¡è¡¨ */}
                          <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-6">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                              <i data-lucide="list" className="w-5 h-5 text-indigo-600"></i>
                              ä»»åŠ¡å®Œæˆæƒ…å†µ
                            </h3>
                            <div className="overflow-x-auto">
                              <table className="w-full text-sm">
                                <thead>
                                  <tr className="border-b border-gray-200 bg-gray-50">
                                    <th className="text-left py-3 px-4 font-semibold text-gray-700">ä»»åŠ¡åç§°</th>
                                    <th className="text-left py-3 px-4 font-semibold text-gray-700">ç±»å‹</th>
                                    <th className="text-center py-3 px-4 font-semibold text-gray-700">å®Œæˆæ¬¡æ•°</th>
                                    <th className="text-center py-3 px-4 font-semibold text-gray-700">æ€»ç§¯åˆ†</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {(() => {
                                    if (!reportData || !reportData.topTasks) {
                                      return (
                                        <tr>
                                          <td colSpan="4" className="py-8 text-center text-gray-500">
                                            æš‚æ— æ•°æ®
                                          </td>
                                        </tr>
                                      );
                                    }

                                    // åˆ›å»ºä»»åŠ¡æ˜¾ç¤ºåˆ—è¡¨ï¼Œé¿å…æ•°æ®æ··ä¹±
                                    const taskRows = [];
                                    
                                    // 1. æ·»åŠ æœ€å¸¸å®Œæˆçš„ä»»åŠ¡
                                    reportData.topTasks.mostCompleted.forEach((item, index) => {
                                      taskRows.push({
                                        task: item.task,
                                        type: 'æ­£å‘ä»»åŠ¡',
                                        count: item.count,
                                        totalPoints: 'æŸ¥çœ‹Excelè·å–',
                                        source: 'mostCompleted'
                                      });
                                    });
                                    
                                    // 2. æ·»åŠ å¸¸è§æ‰£åˆ†é¡¹
                                    reportData.topTasks.commonPenalties.forEach((item, index) => {
                                      taskRows.push({
                                        task: item.task,
                                        type: 'æ‰£åˆ†é¡¹',
                                        count: item.count,
                                        totalPoints: 'æŸ¥çœ‹Excelè·å–',
                                        source: 'penalties'
                                      });
                                    });
                                    
                                    // å»é‡ï¼ˆå¦‚æœæœ‰é‡å¤çš„ä»»åŠ¡åç§°ï¼‰
                                    const uniqueTaskRows = taskRows.filter((task, index, self) => 
                                      index === self.findIndex(t => t.task === task.task)
                                    );
                                    
                                    // æŒ‰å®Œæˆæ¬¡æ•°æ’åºå¹¶é™åˆ¶æ˜¾ç¤ºæ•°é‡
                                    const sortedTasks = uniqueTaskRows
                                      .sort((a, b) => b.count - a.count)
                                      .slice(0, 8);
                                    
                                    return sortedTasks.map((task, index) => (
                                      <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                                        <td className="py-3 px-4 font-medium text-gray-800">{task.task}</td>
                                        <td className="py-3 px-4">
                                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                            task.source === 'penalties' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'
                                          }`}>
                                            {task.type}
                                          </span>
                                        </td>
                                        <td className="py-3 px-4 text-center font-bold text-blue-600">{task.count}</td>
                                        <td className="py-3 px-4 text-center text-gray-500">
                                          {task.totalPoints}
                                        </td>
                                      </tr>
                                    ));
                                  })()}
                                </tbody>
                              </table>
                              <div className="mt-4 text-center">
                                <p className="text-sm text-gray-500">
                                  ğŸ“Š æ˜¾ç¤ºå®Œæˆæ¬¡æ•°æœ€å¤šçš„ä»»åŠ¡ï¼Œå®Œæ•´çš„è¯¦ç»†ç»Ÿè®¡ï¼ˆåŒ…å«æ€»ç§¯åˆ†ã€å¹³å‡ç§¯åˆ†ã€å®Œæˆæ—¥æœŸç­‰ï¼‰è¯·ç‚¹å‡»ä¸Šæ–¹"å¯¼å‡ºå®Œæ•´æŠ¥å‘Š"æŒ‰é’®ï¼ŒæŸ¥çœ‹Excelæ–‡ä»¶ä¸­çš„ 
                                  <span className="font-semibold text-indigo-600">"ä»»åŠ¡æ˜ç»†ç»Ÿè®¡"</span> è¡¨æ ¼
                                </p>
                              </div>
                            </div>
                          </div>

                          {/* å¥–åŠ±å…‘æ¢ç»Ÿè®¡ */}
                          {reportData.rewardStats && reportData.rewardStats.mostRedeemed.length > 0 && (
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-6">
                              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="gift" className="w-5 h-5 text-pink-600"></i>
                                å¥–åŠ±å…‘æ¢ç»Ÿè®¡
                              </h3>
                              <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                  <thead>
                                    <tr className="border-b border-gray-200 bg-gray-50">
                                      <th className="text-left py-3 px-4 font-semibold text-gray-700">å¥–åŠ±åç§°</th>
                                      <th className="text-center py-3 px-4 font-semibold text-gray-700">å…‘æ¢æ¬¡æ•°</th>
                                      <th className="text-center py-3 px-4 font-semibold text-gray-700">æ€»ç§¯åˆ†æ¶ˆè€—</th>
                                      <th className="text-center py-3 px-4 font-semibold text-gray-700">å¹³å‡æ¶ˆè€—</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {reportData.rewardStats.mostRedeemed.map((reward, index) => (
                                      <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                                        <td className="py-3 px-4 font-medium text-gray-800">
                                          <div className="flex items-center gap-2">
                                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${
                                              index === 0 ? 'bg-pink-500' : index === 1 ? 'bg-purple-400' : index === 2 ? 'bg-indigo-400' : 'bg-gray-300'
                                            }`}>
                                              {index + 1}
                                            </span>
                                            {reward.name}
                                          </div>
                                        </td>
                                        <td className="py-3 px-4 text-center font-bold text-pink-600">{reward.count}</td>
                                        <td className="py-3 px-4 text-center font-bold text-red-600">-{reward.totalCost}</td>
                                        <td className="py-3 px-4 text-center font-medium text-gray-600">
                                          -{(reward.totalCost / reward.count).toFixed(0)}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                                <div className="mt-4 text-center">
                                  <p className="text-sm text-gray-500">
                                    ğŸ æ˜¾ç¤ºå…‘æ¢æ¬¡æ•°æœ€å¤šçš„å¥–åŠ±ï¼Œå®Œæ•´ç»Ÿè®¡è¯·æŸ¥çœ‹Excelæ–‡ä»¶ä¸­çš„ 
                                    <span className="font-semibold text-pink-600">"å¥–åŠ±å…‘æ¢ç»Ÿè®¡"</span> è¡¨æ ¼
                                  </p>
                                </div>
                              </div>
                            </div>
                          )}

                          {/* çƒ­é—¨ä»»åŠ¡æ’è¡Œ */}
                          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* æœ€å¸¸å®Œæˆçš„ä»»åŠ¡ */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="trophy" className="w-5 h-5 text-yellow-600"></i>
                                æœ€å¸¸å®Œæˆ
                              </h3>
                              <div className="space-y-3">
                                {reportData.topTasks.mostCompleted.map((item, index) => (
                                  <div key={index} className="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                    <div className="flex items-center gap-2">
                                      <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${
                                        index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-orange-500' : 'bg-gray-300'
                                      }`}>
                                        {index + 1}
                                      </span>
                                      <span className="text-sm font-medium text-gray-800 truncate">{item.task}</span>
                                    </div>
                                    <span className="text-sm font-bold text-blue-600">{item.count}æ¬¡</span>
                                  </div>
                                ))}
                                {reportData.topTasks.mostCompleted.length === 0 && (
                                  <p className="text-gray-500 text-sm text-center py-4">æš‚æ— æ•°æ®</p>
                                )}
                              </div>
                            </div>

                            {/* æœ€é«˜ç§¯åˆ†ä»»åŠ¡ */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="star" className="w-5 h-5 text-green-600"></i>
                                æœ€é«˜ç§¯åˆ†
                              </h3>
                              <div className="space-y-3">
                                {reportData.topTasks.highestPoints.map((item, index) => (
                                  <div key={index} className="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                    <div className="flex items-center gap-2">
                                      <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${
                                        index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-orange-500' : 'bg-gray-300'
                                      }`}>
                                        {index + 1}
                                      </span>
                                      <span className="text-sm font-medium text-gray-800 truncate">{item.task}</span>
                                    </div>
                                    <span className="text-sm font-bold text-green-600">+{item.points}</span>
                                  </div>
                                ))}
                                {reportData.topTasks.highestPoints.length === 0 && (
                                  <p className="text-gray-500 text-sm text-center py-4">æš‚æ— æ•°æ®</p>
                                )}
                              </div>
                            </div>

                            {/* å¸¸è§æ‰£åˆ†é¡¹ */}
                            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="alert-triangle" className="w-5 h-5 text-red-600"></i>
                                éœ€è¦æ”¹è¿›
                              </h3>
                              <div className="space-y-3">
                                {reportData.topTasks.commonPenalties.map((item, index) => (
                                  <div key={index} className="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                    <div className="flex items-center gap-2">
                                      <span className="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center text-xs font-bold text-red-600">
                                        {index + 1}
                                      </span>
                                      <span className="text-sm font-medium text-gray-800 truncate">{item.task}</span>
                                    </div>
                                    <span className="text-sm font-bold text-red-600">{item.count}æ¬¡</span>
                                  </div>
                                ))}
                                {reportData.topTasks.commonPenalties.length === 0 && (
                                  <p className="text-gray-500 text-sm text-center py-4">å¾ˆæ£’ï¼Œæ²¡æœ‰æ‰£åˆ†ï¼ğŸ‰</p>
                                )}
                              </div>
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* è¶…çº§å¯çˆ±çš„å„¿ç«¥åŒ–ç™»å½•æ¨¡æ€æ¡† */}
              {showLoginModal && (
                <div 
                  className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                  onClick={(e) => {
                    if (e.target === e.currentTarget) {
                      setShowLoginModal(false);
                      setPendingAction(null);
                    }
                  }}
                >
                  <div className="bg-gradient-to-br from-pink-200 via-purple-200 to-blue-200 rounded-2xl sm:rounded-3xl shadow-2xl p-6 sm:p-8 w-11/12 max-w-lg mx-4 relative overflow-hidden border-2 sm:border-4 border-white">
                    {/* å¯çˆ±çš„èƒŒæ™¯è£…é¥° */}
                    <div className="absolute top-3 left-4 text-3xl animate-bounce" style={{animationDelay: '0s'}}>ğŸª</div>
                    <div className="absolute top-6 right-6 text-2xl animate-bounce" style={{animationDelay: '0.5s'}}>ğŸˆ</div>
                    <div className="absolute bottom-4 left-6 text-2xl animate-bounce" style={{animationDelay: '1s'}}>ğŸŒŸ</div>
                    <div className="absolute bottom-3 right-4 text-3xl animate-bounce" style={{animationDelay: '1.5s'}}>ğŸš€</div>
                    
                    {/* æ ‡é¢˜åŒºåŸŸ */}
                    <div className="text-center mb-5 sm:mb-6 relative z-10">
                      <div className="text-4xl sm:text-5xl mb-2 sm:mb-3 animate-pulse">ğŸ”</div>
                      <h3 className="text-xl sm:text-2xl font-bold text-gray-800 mb-1 sm:mb-2">
                        å¼€å§‹ä½ çš„å†’é™©ï¼
                      </h3>
                      <p className="text-sm sm:text-base text-gray-600 font-medium">
                        Start your adventure!
                      </p>
                      <button
                        onClick={() => {
                          setShowLoginModal(false);
                          setPendingAction(null);
                        }}
                        className="absolute top-0 right-0 w-8 h-8 bg-red-400 hover:bg-red-500 text-white rounded-full flex items-center justify-center transition-all transform hover:scale-110"
                      >
                        âœ•
                      </button>
                    </div>
                    
                    {/* è¶…çº§å¯çˆ±çš„æ¨¡å¼é€‰æ‹©æŒ‰é’® */}
                    <div className="mb-6 relative z-10">
                      <div className="flex justify-center gap-2">
                        <button
                          onClick={() => setAuthMode('login')}
                          className={`px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl text-xs sm:text-sm font-bold transition-all transform hover:scale-105 ${
                            authMode === 'login' 
                              ? 'bg-blue-500 text-white shadow-lg scale-105' 
                              : 'bg-white/70 text-gray-700 hover:bg-white/90'
                          }`}
                        >
                          ğŸ® ç™»å½•<br/>Login
                        </button>
                        <button
                          onClick={() => setAuthMode('register')}
                          className={`px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl text-xs sm:text-sm font-bold transition-all transform hover:scale-105 ${
                            authMode === 'register' 
                              ? 'bg-green-500 text-white shadow-lg scale-105' 
                              : 'bg-white/70 text-gray-700 hover:bg-white/90'
                          }`}
                        >
                          â­ æ³¨å†Œ<br/>Register
                        </button>
                        <button
                          onClick={() => setAuthMode('forgot')}
                          className={`px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl text-xs sm:text-sm font-bold transition-all transform hover:scale-105 ${
                            authMode === 'forgot' 
                              ? 'bg-orange-500 text-white shadow-lg scale-105' 
                              : 'bg-white/70 text-gray-700 hover:bg-white/90'
                          }`}
                        >
                          ğŸ”‘ å¿˜è®°<br/>Forgot
                        </button>
                      </div>
                    </div>
                    
                    {/* è¾“å…¥æ¡†åŒºåŸŸ */}
                    <div className="space-y-4 relative z-10">
                      <div className="relative">
                        <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl">ğŸ“§</div>
                        <input
                          type="email"
                          placeholder="é‚®ç®±åœ°å€ / Email"
                          value={loginEmail}
                          onChange={e => setLoginEmail(e.target.value)}
                          onKeyPress={e => e.key === 'Enter' && handleAuth()}
                          className="w-full pl-10 sm:pl-12 pr-3 sm:pr-4 py-3 sm:py-4 bg-white/90 border-2 sm:border-3 border-purple-300 rounded-xl sm:rounded-2xl focus:ring-2 sm:focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-base sm:text-lg font-medium placeholder-gray-500"
                          disabled={isAuthLoading}
                        />
                      </div>
                      
                      {authMode !== 'forgot' && (
                        <div className="relative">
                          <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl">ğŸ”’</div>
                          <input
                            type="password"
                            placeholder="å¯†ç  / Password"
                            value={loginPassword}
                            onChange={e => setLoginPassword(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && handleAuth()}
                            className="w-full pl-10 sm:pl-12 pr-3 sm:pr-4 py-3 sm:py-4 bg-white/90 border-2 sm:border-3 border-purple-300 rounded-xl sm:rounded-2xl focus:ring-2 sm:focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-base sm:text-lg font-medium placeholder-gray-500"
                            disabled={isAuthLoading}
                          />
                        </div>
                      )}
                      
                      {/* è¶…çº§é…·ç‚«çš„è¡ŒåŠ¨æŒ‰é’® */}
                      <button
                        onClick={handleAuth}
                        disabled={isAuthLoading}
                        className={`w-full py-3 sm:py-4 px-4 sm:px-6 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg transition-all transform hover:scale-105 shadow-xl ${
                          isAuthLoading
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : authMode === 'login'
                              ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700'
                              : authMode === 'register'
                                ? 'bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700'
                                : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white hover:from-orange-600 hover:to-orange-700'
                        }`}
                      >
                        {isAuthLoading ? (
                          <span className="flex items-center justify-center">
                            <div className="w-6 h-6 mr-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            å¤„ç†ä¸­... Loading...
                          </span>
                        ) : (
                          <span className="flex items-center justify-center">
                            {authMode === 'login' ? 'ğŸ® å¼€å§‹å†’é™© Start Adventure!' :
                             authMode === 'register' ? 'â­ åŠ å…¥æˆ‘ä»¬ Join Us!' :
                             'ğŸ”‘ æ‰¾å›å¯†ç  Reset Password!'}
                          </span>
                        )}
                      </button>
                      
                      {authMode === 'register' && (
                        <div className="text-center">
                          <div className="bg-yellow-100 border-2 border-yellow-300 rounded-xl sm:rounded-2xl p-2 sm:p-3">
                            <span className="text-base sm:text-lg">ğŸ’¡</span>
                            <span className="text-xs sm:text-sm text-yellow-800 font-medium ml-2">
                              å¯†ç è‡³å°‘6ä½å­—ç¬¦å“¦ï¼Password must be at least 6 characters
                            </span>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // æ¸²æŸ“ä¸»ç»„ä»¶
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<LucaPointsSystem />);

    </script>
</body>
</html>