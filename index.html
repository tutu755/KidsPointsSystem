<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids' Mission System</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* 添加一些基础样式，确保图标尺寸正确 */
        i[data-lucide] {
            display: inline-block; /* 或者 block，根据需要 */
            vertical-align: middle;
        }
        
        /* 防御性样式，确保布局稳定 */
        #root {
            position: relative;
            z-index: 1;
        }
        
        /* 确保没有意外的定位问题 */
        .header-login-area {
            position: relative;
            z-index: 10;
        }
        
        /* 强制垂直布局，防止颠倒 */
        .main-container {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
        }
        
        .main-container > * {
            position: static !important;
            order: unset !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 添加任务表单 -->
    <div id="addTaskForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
            <h3 class="text-lg font-bold mb-4">添加任务</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">任务类型</label>
                <select id="taskType" class="w-full p-2 border rounded">
                    <option value="positive">得分项</option>
                    <option value="negative">扣分项</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
                <input type="text" id="taskName" class="w-full p-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">分值</label>
                <input type="number" id="taskPoints" class="w-full p-2 border rounded" min="1">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeAddTaskForm()" class="px-4 py-2 bg-gray-200 rounded">取消</button>
                <button onclick="addTask()" class="px-4 py-2 bg-blue-500 text-white rounded">添加</button>
            </div>
        </div>
    </div>

    <!-- 添加奖励表单 -->
    <div id="addRewardForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
            <h3 class="text-lg font-bold mb-4">添加奖励</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">奖励名称</label>
                <input type="text" id="rewardName" class="w-full p-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">所需积分</label>
                <input type="number" id="rewardPoints" class="w-full p-2 border rounded" min="1">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeAddRewardForm()" class="px-4 py-2 bg-gray-200 rounded">取消</button>
                <button onclick="addReward()" class="px-4 py-2 bg-blue-500 text-white rounded">添加</button>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, Fragment } = React; // 从全局 React 对象中获取 Hooks

        const SUPABASE_URL = 'https://bojodbpcvgrkbsxtfnfi.supabase.co'; // 替换成你的 Supabase 项目 URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvam9kYnBjdmdya2JzeHRmbmZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMDAzNzUsImV4cCI6MjA2NDY3NjM3NX0.xaAVHAZ8fpmbEYSAPXjbKEqndWEowFcFHFrwMPOWigY'; // 替换成你的 Supabase anon key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 直接在这里定义 Lucide 图标组件的替代方案，或者在JSX中使用 <i> 标签
        // 为了简单起见，我们将直接在JSX中使用 <i data-lucide="..."></i> 并用useEffect更新

        function LucaPointsSystem() {
          const [totalPoints, setTotalPoints] = useState(0);
          const [viewMode, setViewMode] = useState('today');
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [history, setHistory] = useState([]);
          const [showRewards, setShowRewards] = useState(false);
          const [showAddTask, setShowAddTask] = useState(false);
          const [editingTask, setEditingTask] = useState(null);
          const [newTask, setNewTask] = useState({
            name: '',
            nameEn: '',
            points: 10,
            icon: '⭐',
            type: 'daily'
          });
          const [childName, setChildName] = useState('');
          const [isUpdating, setIsUpdating] = useState(false);
          const [pendingHistory, setPendingHistory] = useState(null);
          const [tasks, setTasks] = useState([]);
          
          const [rewards, setRewards] = useState([]);
          
          const emojiOptions = ['⭐', '📚', '🎯', '💪', '🏃', '🎨', '🧩', '🎪', '🌟', '💎', '🔥', '⚡', '🌈', '🎭', '🎸'];

          const [showAddReward, setShowAddReward] = useState(false);
          const [newReward, setNewReward] = useState({
            name: '',
            nameEn: '',
            cost: 50,
            icon: '🎁'
          });

          const [currentUser, setCurrentUser] = useState(null);
          const [loginEmail, setLoginEmail] = useState('');
          const [loginPassword, setLoginPassword] = useState('');
          const [authMode, setAuthMode] = useState('login'); // 'login', 'register', 'forgot'
          const [isAuthLoading, setIsAuthLoading] = useState(false);
          const [showLoginModal, setShowLoginModal] = useState(false);
          const [pendingAction, setPendingAction] = useState(null); // 存储待执行的动作

          // 预设任务和奖励
          const DEFAULT_TASKS = [
            // 每日任务 Daily Tasks
            { name: '完成学校作业', nameEn: 'Finish Homework', points: 20, icon: '📚', type: 'daily' },
            { name: '学习中文', nameEn: 'Learn Chinese', points: 15, icon: '🈶', type: 'daily' },
            { name: '学习法语', nameEn: 'Learn French', points: 15, icon: '🇫🇷', type: 'daily' },
            { name: '写日记', nameEn: 'Write Diary', points: 10, icon: '📝', type: 'daily' },
            { name: '数学练习', nameEn: 'Math Practice', points: 15, icon: '➗', type: 'daily' },
            { name: 'Read Theory', nameEn: 'Read Theory', points: 15, icon: '📖', type: 'daily' },

            // 行为习惯 Good Habits
            { name: '洗澡刷牙', nameEn: 'Shower & Brush Teeth', points: 5, icon: '🛁', type: 'behavior' },
            { name: '物品归位', nameEn: 'Put Things Back', points: 5, icon: '🧸', type: 'behavior' },
            { name: '准时睡觉', nameEn: 'Go to Bed on Time', points: 5, icon: '🛏️', type: 'behavior' },

            // 扣分项 Penalties
            { name: '房间不整洁', nameEn: 'Messy Room', points: -10, icon: '🏡', type: 'penalties' },
            { name: '争吵打架', nameEn: 'Fighting/Arguing', points: -20, icon: '😤', type: 'penalties' },
            { name: '忘记带作业', nameEn: 'Forgot Homework', points: -15, icon: '🎒', type: 'penalties' },
            { name: '超时看屏幕', nameEn: 'Too Much Screen Time', points: -10, icon: '📱', type: 'penalties' },
            { name: '说谎', nameEn: 'Lying', points: -25, icon: '🤔', type: 'penalties' }
          ];
          const DEFAULT_REWARDS = [
            { name: 'Roblox 30分钟', nameEn: '30min Roblox', cost: 50, icon: '🎮' },
            { name: 'Roblox 1小时', nameEn: '1hr Roblox', cost: 90, icon: '🎮' },
            { name: '看电影', nameEn: 'Movie Time', cost: 100, icon: '🎬' },
            { name: '特别零食', nameEn: 'Special Treat', cost: 40, icon: '🍰' },
            { name: '晚睡30分钟', nameEn: '30min Later Bedtime', cost: 60, icon: '🌙' },
            { name: '朋友聚会', nameEn: 'Playdate', cost: 120, icon: '👫' }
          ];

          useEffect(() => {
            lucide.createIcons();
          });

          // 加载用户数据函数
          const loadUserData = async (user) => {
            if (!user) return;
            
            // 加载任务
            const { data: tasksData } = await supabase.from('tasks').select('*').eq('user_id', user.id);
            if (!tasksData || tasksData.length === 0) {
              // 插入预设任务
              await supabase.from('tasks').insert(
                DEFAULT_TASKS.map(t => ({
                  ...t,
                  user_id: user.id
                }))
              );
              const { data: newTasks } = await supabase.from('tasks').select('*').eq('user_id', user.id);
              setTasks(newTasks || []);
            } else {
              setTasks(tasksData || []);
            }

            // 加载奖励
            const { data: rewardsData } = await supabase.from('rewards').select('*').eq('user_id', user.id);
            if (!rewardsData || rewardsData.length === 0) {
              // 插入预设奖励
              await supabase.from('rewards').insert(
                DEFAULT_REWARDS.map(r => ({
                  ...r,
                  user_id: user.id
                }))
              );
              const { data: newRewards } = await supabase.from('rewards').select('*').eq('user_id', user.id);
              setRewards(newRewards || []);
            } else {
              setRewards(rewardsData || []);
            }

            // 加载历史记录
            const { data: historyData } = await supabase.from('history').select('*').eq('user_id', user.id);
            setHistory(historyData || []);
          };

          // 监听认证状态变化
          useEffect(() => {
            // 检查当前用户状态
            supabase.auth.getSession().then(({ data: { session } }) => {
              if (session?.user) {
                setCurrentUser(session.user);
                loadUserData(session.user);
              }
            });

            const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
              if (event === 'SIGNED_IN' && session?.user) {
                setCurrentUser(session.user);
                // 加载用户数据
                await loadUserData(session.user);
                // 执行待执行的动作并关闭登录模态框
                executePendingAction();
              } else if (event === 'SIGNED_OUT') {
                setCurrentUser(null);
                setTasks([]);
                setRewards([]);
                setHistory([]);
              }
            });

            return () => subscription.unsubscribe();
          }, []);

          useEffect(() => {
            let total = 0;
            if (Array.isArray(history)) {
              history.forEach(item => {
                total += item.points;
              });
            }
            setTotalPoints(total);
          }, [history]);

          useEffect(() => {
            const todayStr = getLocalDateStr(new Date());
            const dateStr = getLocalDateStr(selectedDate);
            if (dateStr !== todayStr) {
              // history是数组，需要过滤出指定日期的记录
              const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
              setPendingHistory(JSON.parse(JSON.stringify(dayHistory)));
            } else {
              setPendingHistory(null);
            }
          }, [selectedDate, history]);

          // 页面加载时优先从 localStorage 读取
          useEffect(() => {
            const savedTasks = localStorage.getItem('kidsTasks');
            if (savedTasks) setTasks(JSON.parse(savedTasks));
            const savedRewards = localStorage.getItem('kidsRewards');
            if (savedRewards) setRewards(JSON.parse(savedRewards));
          }, []);

          // 每次 tasks 或 rewards 变化时自动保存到 localStorage
          useEffect(() => {
            localStorage.setItem('kidsTasks', JSON.stringify(tasks));
            localStorage.setItem('kidsRewards', JSON.stringify(rewards));
          }, [tasks, rewards]);



          useEffect(() => {
            // 检查用户是否已登录
            supabase.auth.getUser().then(({ data: { user } }) => {
              setCurrentUser(user || null);
            });
          }, []);

          useEffect(() => {
            // 监听登录状态变化
            const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
              setCurrentUser(session?.user || null);
            });
            return () => {
              subscription.unsubscribe();
            };
          }, []);

          useEffect(() => {
            if (currentUser) {
              supabase
                .from('tasks')
                .select('*')
                .eq('user_id', currentUser.id)
                .then(({ data, error }) => {
                  if (error) {
                    alert('加载任务失败: ' + error.message);
                  } else {
                    setTasks(data || []);
                  }
                });
            } else {
              setTasks([]);
            }
          }, [currentUser]);


          // 自动为新用户插入预设任务和奖励
          // 数据加载现在由认证状态监听处理

          // 改为从 localStorage 中读取 childName
          useEffect(() => {
            const savedChildName = localStorage.getItem('childName');
            if (savedChildName) setChildName(savedChildName);
          }, []);

          // 改为在 childName 变化时自动保存到 localStorage
          useEffect(() => {
            if (childName) localStorage.setItem('childName', childName);
          }, [childName]);

          
          const toggleTask = async (category, taskId) => {
            if (isUpdating) return;
            const dateStr = getLocalDateStr(selectedDate);
            const todayStr = getLocalDateStr(new Date());
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            setIsUpdating(true);

            // 如果是补录模式（非今天）
            if (dateStr !== todayStr && pendingHistory !== null) {
              // 更新pendingHistory状态
              const already = pendingHistory.some(item => item.task === task.name && item.type === category);
              
              if (already) {
                // 从pendingHistory中删除
                setPendingHistory(prev => prev.filter(item => !(item.task === task.name && item.type === category)));
              } else {
                // 添加到pendingHistory
                const newItem = {
                  date: dateStr,
                  task: task.name,
                  type: category,
                  points: task.points,
                  user_id: currentUser.id
                };
                setPendingHistory(prev => [...prev, newItem]);
              }
            } else {
              // 今天的数据，直接写入数据库
              const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
              const already = dayHistory.some(item => item.task === task.name && item.type === category);

              if (already) {
                // 删除该条记录
                const itemToDelete = dayHistory.find(item => item.task === task.name && item.type === category);
                if (itemToDelete) {
                  await supabase.from('history').delete().eq('id', itemToDelete.id);
                }
              } else {
                // 插入新记录
                await supabase.from('history').insert([{
                  date: dateStr,
                  task: task.name,
                  type: category,
                  points: task.points,
                  user_id: currentUser.id
                }]);
              }

              // 刷新 history
              const { data } = await supabase.from('history').select('*').eq('user_id', currentUser.id);
              setHistory(data || []);
            }

            setIsUpdating(false);
          };
          const addTask = async (newTask) => {
            if (!currentUser) {
              alert('请先登录');
              return;
            }
            const { error } = await supabase.from('tasks').insert([
              {
                user_id: currentUser.id,
                name: newTask.name,
                nameEn: newTask.nameEn,
                points: newTask.points,
                icon: newTask.icon,
                type: newTask.type
              }
            ]);
            if (error) {
              alert('添加任务失败: ' + error.message);
            } else {
              // 重新加载任务
              const { data } = await supabase.from('tasks').select('*').eq('user_id', currentUser.id);
              setTasks(data || []);
              alert('添加成功！');
            }
          };
          
          const deleteTask = async (taskId) => {
            if (!currentUser) return;
            await supabase.from('tasks').delete().eq('id', taskId).eq('user_id', currentUser.id);
            // 重新加载任务
            const { data } = await supabase.from('tasks').select('*').eq('user_id', currentUser.id);
            setTasks(data || []);
          };
          
          const startEditTask = (task) => {
             setEditingTask(task);
          };

          const handleUpdateTask = (taskId, updates) => {
             setTasks(prev => prev.map(t => 
               t.id === taskId ? { ...t, ...updates } : t
             ));
             // If we are directly updating, we might not need editingTask state like this
             // For simplicity, we'll update directly. If a modal was used, setEditingTask(null) would be here.
          };
          
          const saveEditedTask = (taskId, currentEditedTaskState) => {
            // currentEditedTaskState would be the state from the editing form
            // This function is conceptual if editing is done in a separate form/modal.
            // In TaskCard, it updates directly.
            setTasks(prev => prev.map(t => 
              t.id === taskId ? { ...t, ...currentEditedTaskState } : t
            ));
            setEditingTask(null); // Close editing mode
          };

          const redeemReward = async (reward) => {
            if (totalPoints >= reward.cost) {
              const dateStr = pendingHistory !== null
                ? getLocalDateStr(selectedDate)
                : getLocalDateStr(new Date());
              // 用 Supabase 插入 history
              const { error } = await supabase
                .from('history')
                .insert([
                  {
                    date: dateStr,
                    task: reward.name + '兑换',
                    type: 'redeem',
                    points: -reward.cost,
                    user_id: currentUser.id
                  }
                ]);
              if (!error) {
                alert(`太棒了! 你兑换了 ${reward.name} / Great! You redeemed ${reward.nameEn}! 🎉`);
                // 用 Supabase 刷新 history
                const { data } = await supabase
                  .from('history')
                  .select('*')
                  .eq('user_id', currentUser.id);
                setHistory(data || []);
              }
            } else {
              alert('积分不足哦! / Not enough points! 🙁');
            }
          };

          const getCompletionRate = (date = selectedDate) => {
            const dateStr = getLocalDateStr(date);
            const todayStr = getLocalDateStr(new Date());
            
            // 如果是补录模式，使用pendingHistory的数据
            let dayHistory;
            if (dateStr !== todayStr && pendingHistory !== null) {
              dayHistory = pendingHistory;
            } else {
              dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            }
            
            let totalPossible = 0;
            tasks.forEach(t => { if (t.points > 0) totalPossible += t.points; });
            if (totalPossible === 0) return 0;
            let actual = 0;
            if (Array.isArray(dayHistory)) {
              dayHistory.forEach(item => {
                if ((item.type === 'daily' || item.type === 'behavior') && item.points > 0) {
                  actual += item.points;
                }
              });
            }
            return Math.round((actual / totalPossible) * 100);
          };

          const getDayPoints = (date) => {
            const dateStr = getLocalDateStr(date);
            const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            let total = 0;
            if (Array.isArray(dayHistory)) {
              dayHistory.forEach(item => {
                total += typeof item.points === 'number' ? item.points : 0;
              });
            }
            return total;
          };

          const TaskCard = ({ task, category }) => {
            const dateStr = getLocalDateStr(selectedDate);
            const todayStr = getLocalDateStr(new Date());
            
            // 如果是补录模式，使用pendingHistory的数据
            let dayHistory;
            if (dateStr !== todayStr && pendingHistory !== null) {
              dayHistory = pendingHistory;
            } else {
              dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            }
            
            // 判断是否已完成（勾选）
            const isCompleted = dayHistory.some(item => item.task === task.name && item.type === category);
            const isPenalty = category === 'penalties';
            
            const daysDiff = Math.floor((new Date() - selectedDate) / (1000 * 60 * 60 * 24));
            const canEditOrComplete = daysDiff <= 3;

            // 编辑状态
            const [editing, setEditing] = useState(false);
            const [editName, setEditName] = useState(task.name);
            const [editNameEn, setEditNameEn] = useState(task.nameEn);
            const [editPoints, setEditPoints] = useState(Math.abs(task.points));
            const [editIcon, setEditIcon] = useState(task.icon);

            const handleSave = () => {
              const updatedPoints = isPenalty ? -Math.abs(editPoints) : Math.abs(editPoints);
              handleUpdateTask(task.id, {
                name: editName,
                nameEn: editNameEn,
                points: updatedPoints,
                icon: editIcon
              });
              setEditing(false);
            };

            if (editing) {
              return (
                <div className="p-4 rounded-lg border-2 bg-gray-50 shadow-md">
                  <div className="space-y-2">
                    <input
                      type="text"
                      value={editName}
                      onChange={e => setEditName(e.target.value)}
                      className="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                      placeholder="中文名称"
                    />
                    <input
                      type="text"
                      value={editNameEn}
                      onChange={e => setEditNameEn(e.target.value)}
                      className="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                      placeholder="English Name"
                    />
                    <div className="flex items-center gap-2">
                      <input
                        type="number"
                        value={editPoints}
                        onChange={e => setEditPoints(parseInt(e.target.value) || 0)}
                        className="w-24 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <span className="text-sm text-gray-500">积分</span>
                    </div>
                    <div className="flex flex-wrap gap-2 bg-gray-50 p-2 rounded-lg border">
                      {emojiOptions.map(emoji => (
                        <button
                          key={emoji}
                          type="button"
                          onClick={() => setEditIcon(emoji)}
                          className={`text-2xl p-2 rounded-md transition-all ${editIcon === emoji ? 'bg-blue-500 text-white scale-110 ring-2 ring-blue-300' : 'hover:bg-gray-200 bg-white'}`}
                        >
                          {emoji}
                        </button>
                      ))}
                    </div>
                    <div className="flex gap-2 mt-2">
                      <button
                        onClick={handleSave}
                        className="bg-green-500 text-white px-3 py-1.5 rounded-md hover:bg-green-600 flex items-center"
                      >
                        <i data-lucide="save" className="w-4 h-4 mr-1"></i> 保存 Save
                      </button>
                      <button
                        onClick={() => setEditing(false)}
                        className="bg-gray-300 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-400 flex items-center"
                      >
                        <i data-lucide="x" className="w-4 h-4 mr-1"></i> 取消 Cancel
                      </button>
                    </div>
                  </div>
                </div>
              );
            }

            return (
              <div className="relative group">
                <div
                  onClick={() => canEditOrComplete && !isUpdating && toggleTask(category, task.id)}
                  className={`${!canEditOrComplete || isUpdating ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'} 
                                p-4 rounded-lg border-2 transition-all duration-150 ease-in-out
                                ${ isPenalty 
                                    ? 'bg-red-50 border-red-200 hover:shadow-md' 
                                    : isCompleted 
                                        ? 'bg-green-100 border-green-400 hover:border-green-500 shadow-sm' 
                                        : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-md'
                                }`}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <span className="text-3xl">{task.icon}</span>
                      <div>
                        <h3 className="font-semibold text-gray-800">{task.name}</h3>
                        <p className="text-sm text-gray-500">{task.nameEn}</p>
                      </div>
                    </div>
                    <div className="flex items-center space-x-2">
                      <span className={`font-bold text-lg ${isPenalty ? 'text-red-600' : 'text-blue-600'}`}>
                        {task.points > 0 && !isPenalty ? '+' : ''}{task.points}
                      </span>
                      {isCompleted ? 
                        <i data-lucide="check-circle" className="text-green-500 w-6 h-6"></i> : 
                        <i data-lucide="circle" className="text-gray-300 w-6 h-6"></i>
                      }
                    </div>
                  </div>
                  <div className="absolute bottom-2 left-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <button
                      type="button"
                      onClick={e => { e.stopPropagation(); setEditing(true); }}
                      className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-600 transition"
                      title="编辑任务 Edit Task"
                    >
                      <i data-lucide="edit-2" className="w-3 h-3"></i>
                    </button>
                    <button
                      type="button"
                      onClick={e => { e.stopPropagation(); deleteTask(task.id); }}
                      className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-600 transition"
                      title="删除任务 Delete Task"
                    >
                      <i data-lucide="x" className="w-3 h-3"></i>
                    </button>
                  </div>
                  {!canEditOrComplete && (
                    <p className="text-xs text-gray-400 mt-1 text-center">已过修改期限 (3天) / Modification period expired (3 days)</p>
                  )}
                </div>
              </div>
            );
          };

          const HistoryView = () => {
            const dates = Array.from({length: 30}, (_, i) => {
              const date = new Date();
              date.setDate(date.getDate() - i);
              return date;
            });

            // 计算每一天的累计余额
            let runningTotal = 0;
            // 先按时间正序统计总分
            const allDates = dates.slice().reverse();
            const dateToBalance = {};
            allDates.forEach(date => {
              const dateStr = getLocalDateStr(date);
              const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
              if (Array.isArray(dayHistory)) {
                dayHistory.forEach(item => {
                  runningTotal += typeof item.points === 'number' ? item.points : 0;
                });
              }
              dateToBalance[dateStr] = runningTotal;
            });

            return (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-2xl font-bold mb-6 text-gray-700 text-center">
                    <i data-lucide="calendar-days" className="w-7 h-7 inline-block mr-2 align-text-bottom"></i>
                    历史记录 History - 最近30天
                </h2>
                <div className="space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto pr-2">
                  {dates.map(date => {
                    const dateStr = getLocalDateStr(date);
                    const dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
                    let score = 0, penalty = 0, redeem = 0;
                    if (Array.isArray(dayHistory)) {
                      dayHistory.forEach(item => {
                        if (item.type === 'redeem') {
                          redeem += typeof item.points === 'number' ? item.points : 0;
                        } else if (item.points > 0) {
                          score += item.points;
                        } else if (item.points < 0) {
                          penalty += item.points;
                        }
                      });
                    }
                    const balance = dateToBalance[dateStr] || 0;
                    return (
                      <div 
                        key={date.toISOString()}
                        onClick={() => {
                          setSelectedDate(date);
                          setViewMode('today');
                        }}
                        className={`p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors flex justify-between items-center shadow-sm ${getLocalDateStr(selectedDate) === dateStr ? 'bg-blue-50' : ''}`}
                      >
                        <span className="font-medium text-gray-700">
                          {date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                          {date.toDateString() === new Date().toDateString() && <span className="text-xs ml-1 text-blue-500">(今日)</span>}
                        </span>
                        <div className="flex items-center gap-4 flex-wrap">
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            完成率: {getCompletionRate(date)}%
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            余额: <span className="font-bold text-blue-600">{balance}</span>
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            得分: <span className="font-bold text-green-600">+{score}</span>
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            扣分: <span className="font-bold text-red-600">{penalty}</span>
                          </span>
                          <span className="text-sm text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                            兑换: <span className="font-bold text-pink-600">{redeem}</span>
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          };

          const earnedTodayOrSelectedDay = (() => {
            const dateStr = getLocalDateStr(selectedDate);
            const todayStr = getLocalDateStr(new Date());
            
            // 如果是补录模式，使用pendingHistory的数据
            let dayHistory;
            if (dateStr !== todayStr && pendingHistory !== null) {
              dayHistory = pendingHistory;
            } else {
              dayHistory = Array.isArray(history) ? history.filter(item => item.date === dateStr) : [];
            }
            
            let total = 0;
            if (Array.isArray(dayHistory)) {
              dayHistory.forEach(item => {
                if (item.type !== 'redeem') {
                  total += typeof item.points === 'number' ? item.points : 0;
                }
              });
            }
            return total;
          })();
          const completionRateForSelectedDay = getCompletionRate(selectedDate);

          async function addHistory(date, task, type, points) {
            if (!currentUser) return;
            setIsUpdating(true);
            // 用 Supabase 插入 history
            const { error } = await supabase
              .from('history')
              .insert([
                { date, task, type, points, user_id: currentUser.id }
              ]);
            if (!error) {
              // 用 Supabase 刷新 history
              const { data } = await supabase
                .from('history')
                .select('*')
                .eq('user_id', currentUser.id);
              setHistory(data || []);
            } else {
              console.error('addHistory error:', error);
            }
            setIsUpdating(false);
          }

          // 工具函数：返回本地 yyyy-mm-dd 字符串
          function getLocalDateStr(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
          }

          // 认证函数
          const handleAuth = async () => {
            setIsAuthLoading(true);
            try {
              if (!loginEmail.trim()) {
                alert('请输入邮箱 / Please enter email');
                return;
              }
              
              if (authMode === 'register') {
                if (!loginPassword.trim()) {
                  alert('请输入密码 / Please enter password');
                  setIsAuthLoading(false);
                  return;
                }
                if (loginPassword.length < 6) {
                  alert('密码至少6位 / Password must be at least 6 characters');
                  setIsAuthLoading(false);
                  return;
                }
                
                const { data, error } = await supabase.auth.signUp({
                  email: loginEmail.trim(),
                  password: loginPassword
                });
                
                if (error) {
                  alert('注册失败 / Registration failed: ' + error.message);
                } else {
                  alert('注册成功！您现在可以直接登录使用 / Registration successful! You can now login directly');
                  setLoginEmail('');
                  setLoginPassword('');
                  setAuthMode('login');
                }
              } else if (authMode === 'login') {
                if (!loginPassword.trim()) {
                  alert('请输入密码 / Please enter password');
                  setIsAuthLoading(false);
                  return;
                }
                
                const { data, error } = await supabase.auth.signInWithPassword({
                  email: loginEmail.trim(),
                  password: loginPassword
                });
                
                if (error) {
                  alert('登录失败 / Login failed: ' + error.message);
                } else {
                  setLoginEmail('');
                  setLoginPassword('');
                  // 登录成功后的处理将在认证状态监听中处理
                }
              } else if (authMode === 'forgot') {
                const { error } = await supabase.auth.resetPasswordForEmail(loginEmail.trim(), {
                  redirectTo: window.location.origin
                });
                
                if (error) {
                  alert('发送重置链接失败 / Failed to send reset link: ' + error.message);
                } else {
                  alert('密码重置链接已发送到邮箱！/ Password reset link sent to your email!');
                  setLoginEmail('');
                  setAuthMode('login');
                }
              }
            } catch (error) {
              alert('操作失败 / Operation failed: ' + error.message);
            }
            
            setIsAuthLoading(false);
          };

          // 提交补录
          const submitPendingHistory = async () => {
            if (!currentUser) return;
            const dateStr = getLocalDateStr(selectedDate);
            // 先清空该日历史
            await supabase
              .from('history')
              .delete()
              .eq('user_id', currentUser.id)
              .eq('date', dateStr);
            // 再批量写入
            if (pendingHistory && pendingHistory.length > 0) {
              await supabase.from('history').insert(
                pendingHistory.map(item => ({
                  ...item,
                  date: dateStr,
                  user_id: currentUser.id
                }))
              );
            }
            // 刷新 history
            const { data } = await supabase
              .from('history')
              .select('*')
              .eq('user_id', currentUser.id);
            setHistory(data || []);
            setPendingHistory(null);
            setSelectedDate(new Date());
            alert('补录成功！Make-up records submitted!');
          };

          // 添加任务函数
          const handleAddTask = () => {
            if (newTask.name && newTask.nameEn) {
              const taskId = `custom_${Date.now()}`;
              const category = newTask.type === 'penalty' ? 'penalties' : newTask.type;
              
              setTasks(prev => ({
                ...prev,
                [category]: [...prev[category], { 
                  id: taskId, 
                  name: newTask.name, 
                  nameEn: newTask.nameEn, 
                  points: newTask.type === 'penalty' ? -Math.abs(newTask.points) : Math.abs(newTask.points),
                  icon: newTask.icon 
                }]
              }));
              
              setNewTask({ name: '', points: 10, icon: '⭐', type: 'daily' });
              setShowAddTask(false);
              alert('添加成功！');
            }
          };

          // 添加奖励函数
          const addReward = async (newReward) => {
            if (!currentUser) {
              alert('请先登录');
              return;
            }
            const { error } = await supabase.from('rewards').insert([
              {
                user_id: currentUser.id,
                name: newReward.name,
                nameEn: newReward.nameEn,
                cost: newReward.cost,
                icon: newReward.icon
              }
            ]);
            if (error) {
              alert('添加奖励失败: ' + error.message);
            } else {
              // 重新加载奖励
              const { data } = await supabase.from('rewards').select('*').eq('user_id', currentUser.id);
              setRewards(data || []);
              alert('添加成功！');
            }
          };

          // 奖励卡片也支持编辑和删除
          const RewardCard = ({ reward }) => {
            const [editing, setEditing] = useState(false);
            const [editName, setEditName] = useState(reward.name);
            const [editNameEn, setEditNameEn] = useState(reward.nameEn);
            const [editCost, setEditCost] = useState(reward.cost);
            const [editIcon, setEditIcon] = useState(reward.icon);

            const handleSave = () => {
              handleUpdateReward(reward.id, {
                name: editName,
                nameEn: editNameEn,
                cost: Math.abs(editCost),
                icon: editIcon
              });
              setEditing(false);
            };

            if (editing) {
              return (
                <div className="border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center text-center shadow-sm bg-gray-50">
                  <div className="flex flex-wrap gap-2 bg-gray-50 p-2 rounded-lg border mb-2">
                    {emojiOptions.map(emoji => (
                      <button
                        key={emoji}
                        type="button"
                        onClick={() => setEditIcon(emoji)}
                        className={`text-2xl p-2 rounded-md transition-all ${editIcon === emoji ? 'bg-pink-500 text-white scale-110 ring-2 ring-pink-300' : 'hover:bg-gray-200 bg-white'}`}
                      >
                        {emoji}
                      </button>
                    ))}
                  </div>
                  <input
                    type="text"
                    value={editName}
                    onChange={e => setEditName(e.target.value)}
                    className="w-full p-2 border rounded-md focus:ring-pink-500 focus:border-pink-500 mb-2"
                    placeholder="中文名称"
                  />
                  <input
                    type="text"
                    value={editNameEn}
                    onChange={e => setEditNameEn(e.target.value)}
                    className="w-full p-2 border rounded-md focus:ring-pink-500 focus:border-pink-500 mb-2"
                    placeholder="English Name"
                  />
                  <input
                    type="number"
                    value={editCost}
                    onChange={e => setEditCost(parseInt(e.target.value) || 0)}
                    className="w-24 p-2 border rounded-md focus:ring-pink-500 focus:border-pink-500 mb-2"
                    placeholder="所需积分"
                  />
                  <div className="flex gap-2 mt-2">
                    <button
                      onClick={handleSave}
                      className="bg-pink-500 text-white px-3 py-1.5 rounded-md hover:bg-pink-600 flex items-center"
                    >
                      <i data-lucide="save" className="w-4 h-4 mr-1"></i> 保存 Save
                    </button>
                    <button
                      onClick={() => setEditing(false)}
                      className="bg-gray-300 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-400 flex items-center"
                    >
                      <i data-lucide="x" className="w-4 h-4 mr-1"></i> 取消 Cancel
                    </button>
                  </div>
                </div>
              );
            }

            return (
              <div className="border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center text-center shadow-sm hover:shadow-md group relative">
                <span className="text-4xl mb-2.5 block">{reward.icon}</span>
                <h3 className="font-semibold text-gray-800">{reward.name}</h3>
                <p className="text-xs text-gray-500 mb-1.5">{reward.nameEn}</p>
                <p className="text-lg font-bold text-pink-600 my-2">{reward.cost} 积分</p>
                <div className="flex gap-1 mb-2 opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-2 left-2">
                  <button
                    type="button"
                    onClick={() => setEditing(true)}
                    className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-pink-100 hover:text-pink-600 transition"
                    title="编辑奖励 Edit Reward"
                  >
                    <i data-lucide="edit-2" className="w-3 h-3"></i>
                  </button>
                  <button
                    type="button"
                    onClick={() => deleteReward(reward.id)}
                    className="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-600 transition"
                    title="删除奖励 Delete Reward"
                  >
                    <i data-lucide="x" className="w-3 h-3"></i>
                  </button>
                </div>
                <button
                  onClick={() => redeemReward(reward)}
                  disabled={totalPoints < reward.cost}
                  className={`w-full mt-auto py-2.5 rounded-lg text-sm font-medium transition-all ${
                    totalPoints >= reward.cost
                      ? 'bg-pink-500 text-white hover:bg-pink-600'
                      : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  }`}
                >
                  {totalPoints >= reward.cost ? '兑换 Redeem' : '积分不足 / Not enough points'}
                </button>
              </div>
            );
          };

          // 更新奖励
          const handleUpdateReward = (rewardId, updates) => {
            setRewards(prev => prev.map(r => r.id === rewardId ? { ...r, ...updates } : r));
          };
          // 删除奖励
          const deleteReward = async (rewardId) => {
            if (!currentUser) return;
            await supabase.from('rewards').delete().eq('id', rewardId).eq('user_id', currentUser.id);
            // 重新加载奖励
            const { data } = await supabase.from('rewards').select('*').eq('user_id', currentUser.id);
            setRewards(data || []);
          };

          // 处理功能卡片点击
          const handleFeatureClick = (feature) => {
            if (currentUser) {
              // 已登录，直接执行功能
              switch(feature) {
                case 'tasks':
                  setViewMode('today');
                  break;
                case 'tracking':
                  // 显示统计信息（已在页面顶部）
                  break;
                case 'rewards':
                  setViewMode('today');
                  setShowRewards(true);
                  break;
                case 'history':
                  setViewMode('history');
                  setTimeout(() => {
                    document.getElementById('history-view')?.scrollIntoView({ behavior: 'smooth' });
                  }, 100);
                  break;
              }
            } else {
              // 未登录，保存待执行动作并显示登录框
              setPendingAction(feature);
              setShowLoginModal(true);
            }
          };

          // 登录成功后执行待执行的动作
          const executePendingAction = () => {
            if (pendingAction) {
              handleFeatureClick(pendingAction);
              setPendingAction(null);
            }
            setShowLoginModal(false);
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-yellow-100 via-pink-100 to-blue-100 p-2 sm:p-4 font-[sans-serif]">
              <div className="max-w-5xl mx-auto main-container">
                {/* Logo居中显示 */}
                <div className="relative px-4 sm:px-6 py-4 mb-6">
                  {/* 居中的Logo区域 */}
                  <div className="flex flex-col items-center text-center">
                    <div className="text-4xl sm:text-5xl mb-3">🚀</div>
                    <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-1">小冒险家任务系统</h1>
                    <p className="text-base sm:text-lg text-gray-600">Little Explorer Mission System</p>
                  </div>
                  
                  {/* 用户信息固定在右上角 */}
                  {currentUser && (
                    <div className="absolute top-4 right-4 sm:right-6 flex items-center space-x-3">
                      <span className="text-sm text-gray-700 hidden sm:block font-medium">
                        欢迎，{currentUser.email}
                      </span>
                      <button
                        onClick={async () => {
                          await supabase.auth.signOut();
                          setCurrentUser(null);
                          setTasks([]);
                          setRewards([]);
                          setHistory([]);
                          localStorage.clear();
                          window.location.reload();
                        }}
                        className="bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center space-x-1 shadow-sm"
                      >
                        <i data-lucide="log-out" className="w-4 h-4"></i>
                        <span className="hidden sm:inline">退出</span>
                      </button>
                    </div>
                  )}
                </div>

                {/* Hero Banner Section */}
                <header className="bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 rounded-xl shadow-lg mb-6 relative overflow-hidden">
                  {/* 可爱的背景装饰 */}
                  <div className="absolute top-3 left-6 text-2xl animate-bounce" style={{animationDelay: '0s'}}>🌟</div>
                  <div className="absolute top-4 right-8 text-xl animate-bounce" style={{animationDelay: '0.5s'}}>🎈</div>
                  <div className="absolute bottom-3 left-8 text-lg animate-bounce" style={{animationDelay: '1s'}}>🎯</div>
                  <div className="absolute bottom-4 right-6 text-xl animate-bounce" style={{animationDelay: '1.5s'}}>✨</div>
                  
                  {!currentUser ? (
                    // 未登录时显示宣传banner
                    <div className="text-center relative z-10 py-12 sm:py-16 px-6">
                      <div className="text-4xl sm:text-6xl mb-4 animate-pulse">🏆</div>
                      <h2 className="text-2xl sm:text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg leading-tight">
                        每天完成任务，赚取积分，兑换奖励！
                      </h2>
                      <p className="text-lg sm:text-xl text-white/90 font-medium drop-shadow leading-relaxed">
                        Complete tasks • Earn points • Get rewards!
                      </p>
                    </div>
                  ) : (
                    // 登录后显示简洁信息
                    <div className="text-center relative z-10 py-8 px-6">
                      <div className="text-3xl sm:text-4xl mb-3 animate-pulse">🎮</div>
                      <h2 className="text-xl sm:text-2xl font-bold text-white mb-2 drop-shadow-lg">
                        欢迎回来，准备开始新的冒险吧！
                      </h2>
                      <p className="text-white/90 text-sm sm:text-base">Welcome back, ready for new adventures!</p>
                    </div>
                  )}

                </header>

                {/* 登录后的控制面板 */}
                {currentUser && (
                  <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-200">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div className="flex items-center gap-3">
                        <span className="font-medium text-gray-700 text-sm sm:text-base">小朋友姓名:</span>
                        <input
                          type="text"
                          value={childName}
                          onChange={e => {
                            setChildName(e.target.value);
                          }}
                          className="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 flex-1"
                          placeholder="请输入姓名"
                        />
                      </div>
                      
                      <div className="flex items-center gap-3">
                        <span className="font-medium text-gray-700 text-sm sm:text-base">查看日期:</span>
                        <select
                          value={getLocalDateStr(selectedDate)}
                          onChange={e => {
                            const [y, m, d] = e.target.value.split('-');
                            setSelectedDate(new Date(Number(y), Number(m)-1, Number(d)));
                          }}
                          className="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 flex-1"
                        >
                          {[0,1,2].map(offset => {
                            const d = new Date();
                            d.setDate(d.getDate() - offset);
                            const val = getLocalDateStr(d);
                            const label = offset === 0 ? '今天' : offset === 1 ? '昨天' : '前天';
                            return <option key={val} value={val}>{label} ({val})</option>;
                          })}
                        </select>
                      </div>
                    </div>
                    
                    <div className="flex justify-center gap-3 mb-4">
                      <button
                        onClick={() => {setSelectedDate(new Date()); setViewMode('today');}}
                        className={`px-4 py-2.5 rounded-lg font-medium text-sm flex items-center gap-2 transition-all
                          ${ viewMode === 'today' && selectedDate.toDateString() === new Date().toDateString() ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }`}
                      >
                        <i data-lucide="clock" className="w-4 h-4"></i>
                        今日任务
                      </button>
                      <button
                        onClick={() => {
                          setViewMode('history');
                          setTimeout(() => {
                            document.getElementById('history-view')?.scrollIntoView({ behavior: 'smooth' });
                          }, 100);
                        }}
                        className={`px-4 py-2.5 rounded-lg font-medium text-sm flex items-center gap-2 transition-all
                          ${ viewMode === 'history' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }`}
                      >
                        <i data-lucide="calendar-days" className="w-4 h-4"></i>
                        历史记录
                      </button>
                    </div>

                    {viewMode === 'today' && selectedDate.toDateString() !== new Date().toDateString() && (
                      <div className="text-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p className="text-sm text-yellow-800">
                          <i data-lucide="alert-circle" className="w-4 h-4 inline mr-2"></i>
                          正在查看: <span className="font-semibold">{selectedDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}</span>
                          <button onClick={() => setSelectedDate(new Date())} className="ml-3 text-blue-600 hover:underline font-medium">
                            返回今日
                          </button>
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {/* 主内容区域 - 确保正确的渲染顺序 */}
                <div className="content-area">
                  {/* 统计卡片 - 只在登录后显示 */}
                  {currentUser && (
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-blue-50 rounded-lg p-6 shadow-sm border border-blue-200 flex flex-col items-center">
                          <i data-lucide="trophy" className="w-9 h-9 text-blue-500 mb-2"></i>
                          <div className="text-gray-600 text-base font-medium mb-1">总积分 Total</div>
                          <div className="text-3xl font-bold text-blue-600">{totalPoints}</div>
                        </div>
                        <div className="bg-green-50 rounded-lg p-6 shadow-sm border border-green-200 flex flex-col items-center">
                          <i data-lucide="star" className="w-9 h-9 text-green-500 mb-2"></i>
                          <div className="text-gray-600 text-base font-medium mb-1">今日得分 Today's Points</div>
                          <div className="text-3xl font-bold text-green-600">{earnedTodayOrSelectedDay}</div>
                        </div>
                        <div className="bg-purple-50 rounded-lg p-6 shadow-sm border border-purple-200 flex flex-col items-center">
                          <i data-lucide="bar-chart-big" className="w-9 h-9 text-purple-500 mb-2"></i>
                          <div className="text-gray-600 text-base font-medium mb-1">今日完成率 Completion Rate</div>
                          <div className="text-3xl font-bold text-purple-600">{completionRateForSelectedDay}%</div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* 欢迎页面 - 显示所有功能卡片 */}
                  {!currentUser && (
                    <div className="relative">
                      {/* 大大的欢迎提示 - 手机适配 */}
                      <div className="text-center mb-6 sm:mb-8 px-4 sm:px-0">
                        <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 animate-bounce">🎯</div>
                        <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
                          选择你的冒险模式！
                        </h2>
                        <p className="text-base sm:text-lg text-gray-600">
                          Choose your adventure mode!
                        </p>
                      </div>
                        
                      {/* 超级炫酷的功能卡片 - 完全响应式设计 */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-8 px-2 sm:px-0">
                        <button 
                          onClick={() => handleFeatureClick('tasks')}
                          className="group bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:rotate-1 shadow-xl sm:shadow-2xl hover:shadow-green-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-spin">📋</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">每日任务</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">Daily Tasks</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">完成任务赚积分 💰<br/>Complete tasks & earn points</p>
                        </button>
                        
                        <button 
                          onClick={() => handleFeatureClick('tracking')}
                          className="group bg-gradient-to-br from-blue-400 to-sky-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:-rotate-1 shadow-xl sm:shadow-2xl hover:shadow-blue-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-pulse">📊</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">积分查看</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">Points Tracking</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">看看你有多棒 🏅<br/>See how awesome you are</p>
                        </button>
                        
                        <button 
                          onClick={() => handleFeatureClick('rewards')}
                          className="group bg-gradient-to-br from-pink-400 to-rose-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:rotate-1 shadow-xl sm:shadow-2xl hover:shadow-pink-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-bounce">🎁</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">奖励商店</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">Reward Shop</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">用积分买好东西 🛍️<br/>Buy cool stuff with points</p>
                        </button>
                        
                        <button 
                          onClick={() => handleFeatureClick('history')}
                          className="group bg-gradient-to-br from-purple-400 to-violet-500 rounded-2xl sm:rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105 sm:hover:scale-110 hover:-rotate-1 shadow-xl sm:shadow-2xl hover:shadow-purple-300/50 border-2 sm:border-4 border-white"
                        >
                          <div className="text-4xl sm:text-6xl mb-3 sm:mb-4 group-hover:animate-pulse">📈</div>
                          <h3 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2 drop-shadow-lg">成长记录</h3>
                          <p className="text-base sm:text-lg text-white/90 font-semibold">History</p>
                          <p className="text-sm sm:text-base text-white/80 mt-2">看看你的进步 📚<br/>Track your progress</p>
                        </button>
                      </div>
                      
                      {/* 底部激励文字 - 手机适配 */}
                      <div className="text-center px-4 sm:px-0">
                        <div className="flex justify-center items-center space-x-3 sm:space-x-4 text-3xl sm:text-4xl mb-3 sm:mb-4">
                          <span className="animate-bounce" style={{animationDelay: '0s'}}>🌟</span>
                          <span className="animate-bounce" style={{animationDelay: '0.2s'}}>🚀</span>
                          <span className="animate-bounce" style={{animationDelay: '0.4s'}}>🏆</span>
                          <span className="animate-bounce" style={{animationDelay: '0.6s'}}>🎉</span>
                        </div>
                        <p className="text-lg sm:text-xl font-bold text-gray-700">
                          成为最棒的小冒险家！
                        </p>
                        <p className="text-sm sm:text-base text-gray-600">
                          Become the best little explorer!
                        </p>
                      </div>
                    </div>
                  )}

                  {/* 历史记录视图 */}
                  {currentUser && viewMode === 'history' && (
                    <div id="history-view">
                      <HistoryView />
                    </div>
                  )}

                  {/* 今日任务视图 */}
                  {currentUser && viewMode === 'today' && (
                  <Fragment> {/* Use Fragment if no parent div is needed */}
                    <div className="mb-6 text-center">
                      <button
                        onClick={() => setShowAddTask(!showAddTask)}
                        className="bg-green-500 text-white px-5 py-2.5 rounded-lg hover:bg-green-600 transition-transform hover:scale-105 duration-150 flex items-center mx-auto shadow-md"
                      >
                        <i data-lucide={showAddTask ? "minus" : "plus"} className="w-5 h-5 mr-2"></i>
                        {showAddTask ? '收起表单 Hide Form' : '添加新任务 Add New Task'}
                      </button>
                    </div>

                    {showAddTask && (
                      <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
                        <h3 className="text-xl font-semibold mb-5 text-gray-700">
                            <i data-lucide="list-plus" className="w-6 h-6 inline mr-2 align-text-bottom"></i>
                            添加自定义任务/扣分项
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                          <input
                            type="text"
                            placeholder="中文名称 Chinese Name"
                            value={newTask.name}
                            onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          />
                          <input
                            type="text"
                            placeholder="英文名称 English Name"
                            value={newTask.nameEn}
                            onChange={(e) => setNewTask({ ...newTask, nameEn: e.target.value })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          />
                          <select
                            value={newTask.type}
                            onChange={e => setNewTask({ ...newTask, type: e.target.value })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          >
                            <option value="daily">每日任务 Daily Task</option>
                            <option value="behavior">行为习惯 Behavior</option>
                            <option value="penalties">扣分项 Penalty</option>
                          </select>
                          <input
                            type="number"
                            placeholder="积分 Points (扣分填正数)"
                            value={newTask.points}
                            onChange={(e) => setNewTask({ ...newTask, points: parseInt(e.target.value) || 0 })}
                            className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                          />
                          <div className="md:col-span-2">
                            <p className="text-sm text-gray-600 mb-2">选择图标 Choose Icon:</p>
                            <div className="flex flex-wrap gap-2 bg-gray-50 p-3 rounded-lg border">
                              {emojiOptions.map(emoji => (
                                <button
                                  key={emoji}
                                  onClick={() => setNewTask({ ...newTask, icon: emoji })}
                                  className={`text-2xl p-2 rounded-md transition-all ${newTask.icon === emoji ? 'bg-blue-500 text-white scale-110 ring-2 ring-blue-300' : 'hover:bg-gray-200 bg-white'}`}
                                >
                                  {emoji}
                                </button>
                              ))}
                            </div>
                          </div>
                          <div className="md:col-span-2 flex gap-3 mt-2">
                            <button
                              onClick={() => addTask(newTask)}
                              className="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600 transition flex items-center"
                            >
                              <i data-lucide="check" className="w-5 h-5 mr-1.5"></i> 添加 Add
                            </button>
                            <button
                              onClick={() => setShowAddTask(false)}
                              className="bg-gray-300 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-400 transition"
                            >
                              取消 Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-xl font-bold mb-5 text-gray-700 flex items-center">
                            <i data-lucide="clipboard-list" className="w-6 h-6 mr-2 text-sky-500"></i>
                            每日任务 Daily Tasks
                            <button
                              onClick={async () => {
                                if (window.confirm('确定要清空当天所有得分/扣分吗？\nAre you sure to clear all today\'s records?')) {
                                  const dateStr = getLocalDateStr(selectedDate);
                                  // 用 Supabase 删除该用户该天的记录
                                  await supabase
                                    .from('history')
                                    .delete()
                                    .eq('user_id', currentUser.id)
                                    .eq('date', dateStr);
                                  // 刷新 history
                                  const { data } = await supabase
                                    .from('history')
                                    .select('*')
                                    .eq('user_id', currentUser.id);
                                  setHistory(data || []);
                                }
                              }}
                              className="ml-3 px-3 py-1.5 rounded-lg bg-red-500 text-white text-xs sm:text-sm font-medium hover:bg-red-600 transition-all flex items-center"
                              title="清空当天 Clear Today"
                            >
                              <i data-lucide='trash-2' className='w-4 h-4 mr-1'></i>
                              清空当天
                            </button>
                        </h2>
                        <div className="space-y-3.5">
                          {tasks.filter(task => task.type === 'daily').map(task => (
                            <TaskCard key={task.id} task={task} category="daily" />
                          ))}
                        </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-xl font-bold mb-5 text-gray-700 flex items-center">
                            <i data-lucide="thumbs-up" className="w-6 h-6 mr-2 text-teal-500"></i>
                            行为习惯 Good Habits
                        </h2>
                        <div className="space-y-3.5">
                          {tasks.filter(task => task.type === 'behavior').map(task => (
                            <TaskCard key={task.id} task={task} category="behavior" />
                          ))}
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-lg p-6 mt-6 border-2 border-red-200/70">
                      <h2 className="text-xl font-bold mb-5 text-red-600 flex items-center">
                        <i data-lucide="alert-triangle" className="w-6 h-6 mr-2"></i>
                        扣分项目 Penalty Items
                      </h2>
                      <div className="grid md:grid-cols-2 gap-3.5">
                        {tasks.filter(task => task.type === 'penalties').map(task => (
                          <TaskCard key={task.id} task={task} category="penalties" />
                        ))}
                      </div>
                    </div>
                    
                    {/* 补录历史按钮 - 移动到这里 */}
                    {pendingHistory !== null && (
                      <div className="flex justify-center mt-6 mb-6">
                        <button
                          onClick={submitPendingHistory}
                          className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-lg transition-all transform hover:scale-105"
                        >
                          <i data-lucide="upload" className="w-5 h-5 mr-2 inline"></i>
                          提交补录 Make-up Submit
                        </button>
                      </div>
                    )}
                    
                    <div className="bg-white rounded-xl shadow-lg p-6 mt-8">
                      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 gap-3">
                        <h2 className="text-2xl font-bold flex items-center text-gray-700">
                          <i data-lucide="gift" className="w-7 h-7 mr-2.5 text-pink-500"></i>
                          <div className="flex flex-col leading-tight">
                            <span>奖励商店</span>
                            <span className="text-lg text-gray-600">Reward Shop</span>
                          </div>
                        </h2>
                        <button
                          onClick={() => setShowAddReward(!showAddReward)}
                          className="bg-pink-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-pink-600 text-xs sm:text-sm transition-all flex items-center justify-center min-w-0 shrink-0"
                        >
                          <i data-lucide="plus" className="w-4 h-4 mr-1 sm:mr-2"></i>
                          <span className="hidden sm:inline">{showAddReward ? '隐藏 Hide' : '添加奖励 Add Reward'}</span>
                          <span className="sm:hidden">{showAddReward ? '隐藏' : '添加'}</span>
                        </button>
                      </div>
                      
                      {showAddReward && (
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
                          <h3 className="text-xl font-semibold mb-5 text-gray-700">
                            <i data-lucide="gift" className="w-6 h-6 inline mr-2 align-text-bottom"></i>
                            添加新奖励 Add New Reward
                          </h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <input
                              type="text"
                              placeholder="中文名称 Chinese Name"
                              value={newReward.name}
                              onChange={(e) => setNewReward({ ...newReward, name: e.target.value })}
                              className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            />
                            <input
                              type="text"
                              placeholder="英文名称 English Name"
                              value={newReward.nameEn}
                              onChange={(e) => setNewReward({ ...newReward, nameEn: e.target.value })}
                              className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            />
                            <input
                              type="number"
                              placeholder="所需积分 Points Required"
                              value={newReward.cost}
                              onChange={(e) => setNewReward({ ...newReward, cost: parseInt(e.target.value) || 0 })}
                              className="p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                            />
                            <div className="md:col-span-2 flex gap-3 mt-2">
                              <button
                                onClick={() => addReward(newReward)}
                                className="bg-pink-500 text-white px-5 py-2 rounded-lg hover:bg-pink-600 transition flex items-center"
                              >
                                <i data-lucide="check" className="w-5 h-5 mr-1.5"></i> 添加 Add
                              </button>
                              <button
                                onClick={() => setShowAddReward(false)}
                                className="bg-gray-300 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-400 transition"
                              >
                                取消 Cancel
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-5 mt-6 pt-4 border-t">
                        {rewards.map(reward => (
                          <RewardCard key={reward.id} reward={reward} />
                        ))}
                      </div>
                    </div>
                    </Fragment>
                  )}



                  {/* 页脚 */}
                  <footer className="text-center text-xs text-gray-500 py-8 mt-8">
                     Kids' Mission System &copy; {new Date().getFullYear()}
                  </footer>
                </div> {/* 关闭 content-area */}
              </div> {/* 关闭 main-container */}

              {/* 超级可爱的儿童化登录模态框 */}
              {showLoginModal && (
                <div 
                  className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                  onClick={(e) => {
                    if (e.target === e.currentTarget) {
                      setShowLoginModal(false);
                      setPendingAction(null);
                    }
                  }}
                >
                  <div className="bg-gradient-to-br from-pink-200 via-purple-200 to-blue-200 rounded-2xl sm:rounded-3xl shadow-2xl p-6 sm:p-8 w-11/12 max-w-lg mx-4 relative overflow-hidden border-2 sm:border-4 border-white">
                    {/* 可爱的背景装饰 */}
                    <div className="absolute top-3 left-4 text-3xl animate-bounce" style={{animationDelay: '0s'}}>🎪</div>
                    <div className="absolute top-6 right-6 text-2xl animate-bounce" style={{animationDelay: '0.5s'}}>🎈</div>
                    <div className="absolute bottom-4 left-6 text-2xl animate-bounce" style={{animationDelay: '1s'}}>🌟</div>
                    <div className="absolute bottom-3 right-4 text-3xl animate-bounce" style={{animationDelay: '1.5s'}}>🚀</div>
                    
                    {/* 标题区域 */}
                    <div className="text-center mb-5 sm:mb-6 relative z-10">
                      <div className="text-4xl sm:text-5xl mb-2 sm:mb-3 animate-pulse">🔐</div>
                      <h3 className="text-xl sm:text-2xl font-bold text-gray-800 mb-1 sm:mb-2">
                        开始你的冒险！
                      </h3>
                      <p className="text-sm sm:text-base text-gray-600 font-medium">
                        Start your adventure!
                      </p>
                      <button
                        onClick={() => {
                          setShowLoginModal(false);
                          setPendingAction(null);
                        }}
                        className="absolute top-0 right-0 w-8 h-8 bg-red-400 hover:bg-red-500 text-white rounded-full flex items-center justify-center transition-all transform hover:scale-110"
                      >
                        ✕
                      </button>
                    </div>
                    
                    {/* 超级可爱的模式选择按钮 */}
                    <div className="mb-6 relative z-10">
                      <div className="flex justify-center gap-2">
                        <button
                          onClick={() => setAuthMode('login')}
                          className={`px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl text-xs sm:text-sm font-bold transition-all transform hover:scale-105 ${
                            authMode === 'login' 
                              ? 'bg-blue-500 text-white shadow-lg scale-105' 
                              : 'bg-white/70 text-gray-700 hover:bg-white/90'
                          }`}
                        >
                          🎮 登录<br/>Login
                        </button>
                        <button
                          onClick={() => setAuthMode('register')}
                          className={`px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl text-xs sm:text-sm font-bold transition-all transform hover:scale-105 ${
                            authMode === 'register' 
                              ? 'bg-green-500 text-white shadow-lg scale-105' 
                              : 'bg-white/70 text-gray-700 hover:bg-white/90'
                          }`}
                        >
                          ⭐ 注册<br/>Register
                        </button>
                        <button
                          onClick={() => setAuthMode('forgot')}
                          className={`px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl text-xs sm:text-sm font-bold transition-all transform hover:scale-105 ${
                            authMode === 'forgot' 
                              ? 'bg-orange-500 text-white shadow-lg scale-105' 
                              : 'bg-white/70 text-gray-700 hover:bg-white/90'
                          }`}
                        >
                          🔑 忘记<br/>Forgot
                        </button>
                      </div>
                    </div>
                    
                    {/* 输入框区域 */}
                    <div className="space-y-4 relative z-10">
                      <div className="relative">
                        <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl">📧</div>
                        <input
                          type="email"
                          placeholder="邮箱地址 / Email"
                          value={loginEmail}
                          onChange={e => setLoginEmail(e.target.value)}
                          onKeyPress={e => e.key === 'Enter' && handleAuth()}
                          className="w-full pl-10 sm:pl-12 pr-3 sm:pr-4 py-3 sm:py-4 bg-white/90 border-2 sm:border-3 border-purple-300 rounded-xl sm:rounded-2xl focus:ring-2 sm:focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-base sm:text-lg font-medium placeholder-gray-500"
                          disabled={isAuthLoading}
                        />
                      </div>
                      
                      {authMode !== 'forgot' && (
                        <div className="relative">
                          <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl">🔒</div>
                          <input
                            type="password"
                            placeholder="密码 / Password"
                            value={loginPassword}
                            onChange={e => setLoginPassword(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && handleAuth()}
                            className="w-full pl-10 sm:pl-12 pr-3 sm:pr-4 py-3 sm:py-4 bg-white/90 border-2 sm:border-3 border-purple-300 rounded-xl sm:rounded-2xl focus:ring-2 sm:focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-base sm:text-lg font-medium placeholder-gray-500"
                            disabled={isAuthLoading}
                          />
                        </div>
                      )}
                      
                      {/* 超级酷炫的行动按钮 */}
                      <button
                        onClick={handleAuth}
                        disabled={isAuthLoading}
                        className={`w-full py-3 sm:py-4 px-4 sm:px-6 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg transition-all transform hover:scale-105 shadow-xl ${
                          isAuthLoading
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : authMode === 'login'
                              ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700'
                              : authMode === 'register'
                                ? 'bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700'
                                : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white hover:from-orange-600 hover:to-orange-700'
                        }`}
                      >
                        {isAuthLoading ? (
                          <span className="flex items-center justify-center">
                            <div className="w-6 h-6 mr-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            处理中... Loading...
                          </span>
                        ) : (
                          <span className="flex items-center justify-center">
                            {authMode === 'login' ? '🎮 开始冒险 Start Adventure!' :
                             authMode === 'register' ? '⭐ 加入我们 Join Us!' :
                             '🔑 找回密码 Reset Password!'}
                          </span>
                        )}
                      </button>
                      
                      {authMode === 'register' && (
                        <div className="text-center">
                          <div className="bg-yellow-100 border-2 border-yellow-300 rounded-xl sm:rounded-2xl p-2 sm:p-3">
                            <span className="text-base sm:text-lg">💡</span>
                            <span className="text-xs sm:text-sm text-yellow-800 font-medium ml-2">
                              密码至少6位字符哦！Password must be at least 6 characters
                            </span>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // 渲染主组件
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<LucaPointsSystem />);

    </script>
</body>
</html>